# 版本更新日志

---
## [4.21.7] - 2025-11-26

### 🐛 重要Bug修复
- **修复连板个股梯队弹窗显示格式问题（Critical）**
  - 问题：点击星期时显示的连板个股板位格式被简化（例如："7天6板"显示为"6板"，"6天4板"显示为"4板"）
  - 根本原因：`src/app/page.tsx` 第3072行使用了 `{stock.boardNum}板` 显示提取的板位数字，而不是完整的 `stock.td_type`
  - 解决方案：将显示逻辑改为直接显示 `{stock.td_type}`，保留完整格式
  - 修复位置：连板个股梯队弹窗表格（第3072行）
  - 现在会正确显示：
    - "7天6板" → 显示为 "7天6板"（完整格式）
    - "6天4板" → 显示为 "6天4板"（完整格式）
    - "4连板" → 显示为 "4连板"（保持原样）

### 🔧 技术说明
- **显示逻辑**：直接使用 `stock.td_type` 而非 `stock.boardNum + "板"`
- **颜色逻辑**：保持不变，仍然使用 `boardNum` 判断颜色（红色5+板、橙色3+板、蓝色其他）
- **数据完整性**：`boardNum` 仅用于排序和颜色判断，不再用于显示

### 📊 影响范围
- 文件：`src/app/page.tsx`（第3072行）
- 影响功能：连板个股梯队弹窗（点击星期几时显示）
- 优先级：非常高（Critical Bug Fix）

---
## [4.21.6] - 2025-11-26

### 🐛 重要Bug修复
- **修复td_type格式显示问题（Critical）**
  - 问题：后端API将"13天12板"简化为"12板"，导致前端无法显示完整格式
  - 根本原因：`src/app/api/stocks/route.ts` 两处代码（第906行和第1049行）调用了 `normalizeBoardType()` 函数，该函数会将完整格式转换为简化格式
  - 解决方案：移除 `normalizeBoardType()` 调用，直接使用原始 `stock.TDType` 值
  - 修复位置：
    1. 单日数据路径（第906行）：`td_type: normalizeBoardType(stock.TDType)` → `td_type: stock.TDType`
    2. 7天数据路径（第1049行）：`td_type: normalizeBoardType(stock.TDType)` → `td_type: stock.TDType`
  - 现在会正确保留和显示：
    - "13天12板" → 显示为 "13天12板"（完整格式）
    - "2连板" → 显示为 "2连板"（保持原样）
    - "首板" → 显示为 "首板"（保持原样）

### 🔧 技术说明
- **数据流向**：外部API → `stock.TDType`（原始格式）→ 前端显示（不再经过规范化转换）
- **排序逻辑**：`getBoardWeight()` 函数仍然能够正确处理所有格式：
  - "首板" / "首" → 权重 1
  - "2连板" / "2板" → 权重 2
  - "13天12板" → 权重 12（正则提取连板数）
  - "二板"（中文数字）→ 权重 2（BOARD_WEIGHTS映射）
- **兼容性**：完全向后兼容，`getBoardWeight()` 支持所有可能的板位格式

### 📊 影响范围
- 文件：`src/app/api/stocks/route.ts`（第906行、第1049行）
- 影响功能：所有显示个股板位类型的地方（包括单日数据和7天数据）
- 数据库：需要清除缓存以获取新格式数据
- 优先级：非常高（Critical Bug Fix）

---
## [4.21.5] - 2025-11-26

### 🐛 重要Bug修复
- **修复td_type显示格式问题（Critical）**
  - 问题1：显示"13天12板"被错误简化为"13天12"或"12"
  - 问题2：所有replace逻辑会破坏原始格式
  - 根本原因：3个位置使用了错误的 `replace` 逻辑修改 `td_type` 显示
  - 解决方案：移除所有 `replace` 逻辑，直接显示原始 `td_type` 字段
  - 修复位置：
    1. 板块个股梯队弹窗（第1148行）：移除 `.replace('连板', '板')`
    2. 涨停数弹窗（第1747行）：移除 `.replace('首板', '1').replace('首', '1').replace('连板', '').replace('板', '')`
    3. 日期列详情弹窗（第2232行）：移除 `.replace('连板', '板')`
  - 现在会正确显示：
    - "13天12板" → 显示为 "13天12板"（保持原样）
    - "12板" → 显示为 "12板"（保持原样）
    - "首板" → 显示为 "1板"（后端已规范化）

### 🔧 技术说明
- **连板数提取**：`getBoardWeight` 函数已正确支持多种格式：
  - "首板" / "首" → 1
  - "2连板" / "2板" → 2
  - "13天12板" → 12（提取连板数）
  - "二板" → 2（BOARD_WEIGHTS映射）
- **数据规范化**：`normalizeBoardType` 函数在后端已将中文数字转换为阿拉伯数字
- **显示原则**：前端不再修改 td_type，直接显示后端规范化后的格式

### 📊 影响范围
- 文件：`src/app/page.tsx`
- 影响功能：所有显示个股板位类型的地方
- 优先级：非常高（Critical Bug Fix）

---
## [4.21.4] - 2025-11-26

### 🐛 重要Bug修复
- **修复连板排序全局失效问题（Critical）**
  - 问题：当切换成"连板排序"时，各板块中的个股顺序并没有按连板排序，包括排行里的个股顺序也没有按连板排序
  - 根本原因：多个弹窗和列表直接使用原始数据或自定义排序逻辑，未使用统一的 `getSortedStocksForSector` 排序函数
  - 解决方案：
    1. **排行榜徽章弹窗**（`handleRankingBadgeClick` 函数）：在获取stocks后使用 `getSortedStocksForSector` 进行排序
    2. **7天涨停阶梯弹窗**：移除重复排序逻辑，直接使用已排序的stocks
    3. **涨停数弹窗**（`handleStockCountClick` 函数）：替换自定义排序为 `getSortedStocksForSector`，支持全局排序模式切换
  - 影响范围：所有板块个股列表、排行榜、7天涨停阶梯等所有显示个股的地方

### 🔧 技术改进
- 统一使用 `getSortedStocksForSector` 函数处理所有个股排序
- 确保全局 `sectorModalSortMode` 状态在所有弹窗中生效
- 支持"连板排序"（按连板数降序+涨停时间升序）和"涨幅排序"（按5日累计溢价降序）两种模式

### 📊 影响范围
- 文件：`src/app/page.tsx`
- 影响功能：
  - 排行榜徽章弹窗（点击Top 5排行徽章）
  - 7天涨停阶梯弹窗
  - 涨停数弹窗（点击"X只涨停"）
  - 主页面板块个股列表（已验证正确）
- 优先级：非常高（Critical Bug Fix）

---
## 🎉 重要里程碑 - v4.21.3 (2025-11-20)

**✅ 已完成：星期几连板内容完整修订**

本版本标志着"点击星期几显示连板个股梯队"功能的全面完成，实现了以下重要目标：

1. **功能统一** (v4.21.2)：点击星期几的显示效果与点击板块名称完全一致
   - 左侧溢价趋势图表 + 右侧详细表格的分屏布局
   - 今日分时、当日分时、显示K线、涨幅>10%筛选等完整功能
   - 个股名称可点击，支持排序和过滤

2. **数据准确性修复** (v4.21.3)：彻底解决连板个股识别错误问题
   - 修复中文数字板位识别问题（"二板"、"三板"等）
   - 统一板位数据格式，确保前后端一致性
   - 所有连板梯队数据显示准确无误

**备份说明**：此版本已完整测试并部署成功，可作为稳定版本备份节点。

---

## [4.21.3] - 2025-11-20

### 🐛 重要Bug修复
- **修复连板个股识别问题（Critical）**
  - 问题：点击星期几时显示的连板个股不正确
  - 根本原因：外部API返回的 TDType 字段包含中文数字（"二板"、"三板"等），而前端正则表达式只能匹配阿拉伯数字（"2板"、"3板"等）
  - 解决方案：新增 `normalizeBoardType` 函数，将所有中文数字板位转换为阿拉伯数字格式
  - 支持的格式转换：
    - "首板" / "一板" -> "1板"
    - "二板" -> "2板"
    - "三板" -> "3板"
    - ... 以此类推到"十板" -> "10板"
    - "2连板" -> "2板"（也支持连板格式）
  - 影响范围：所有连板个股梯队显示功能

### 🔧 技术改进
- 在 `src/app/api/stocks/route.ts` 中：
  - 新增 `normalizeBoardType(tdType: string)` 函数
  - 替换所有 `stock.TDType.replace('首板', '1').replace('首', '1')` 为 `normalizeBoardType(stock.TDType)`
  - 统一板位数据格式，确保前后端数据一致性

### ⚠️ 重要提示
- 建议清理数据库缓存，因为旧数据的 td_type 格式可能不正确
- 清理方法：访问 `/api/clear-cache` 或重启服务

### 📊 影响范围
- 文件：`src/app/api/stocks/route.ts`
- 影响功能：连板个股梯队显示、点击星期几功能
- 优先级：非常高（Critical Bug Fix）

---

## [4.21.2] - 2025-11-19

### ✨ 重要功能增强
- **统一星期模态框与板块模态框功能**
  - 点击星期几（周一、周二等）时，显示效果与点击板块名称完全一致
  - 新增右上方功能按钮区域：
    - 📊 今日分时：查看所有连板个股的实时分时图
    - 📷 当日分时：查看所有连板个股的当日快照分时图
    - 📈 显示K线：查看所有连板个股的K线图
    - 显示涨幅>10%：过滤仅显示5日累计涨幅大于10%的个股
  - 采用分屏布局：左侧40%显示个股5天溢价趋势图表（使用 StockPremiumChart 组件），右侧60%显示个股详细表格
  - 新增排序功能：支持按连板数或5日累计溢价排序
  - 个股名称可点击，与板块模态框一致的交互体验
  - 图表联动：过滤和排序同时应用于左侧图表和右侧表格

### 🔧 技术改进
- 新增 `getSortedStocksForMultiBoard` 函数，专门处理连板个股梯队的排序逻辑
- 新增状态变量：
  - `showOnly10PlusInMultiBoardModal`：控制涨幅>10%过滤
  - `multiBoardModalSortMode`：控制排序模式（board/return）
- 重构连板个股梯队模态框HTML结构，与板块模态框保持一致的布局和交互
- 优化类型转换逻辑，确保 StockPerformance 类型完整性

### 📊 影响范围
- 文件：`src/app/page.tsx`
- 影响功能：连板个股梯队弹窗（点击星期几时显示）
- 用户体验：大幅提升，功能与点击板块名称完全一致

---

## [4.21.1] - 2025-11-19

### 🐛 重要修复
- **交易日查询范围不足问题**
  - 修复 `get7TradingDaysFromCalendar` 函数的查询范围过小导致的数据加载失败
  - 将查询范围从固定 30 天扩大到 50 天（7 * 5 = 35天基础，增加长假期缓冲）
  - 解决了服务器日志中频繁出现的"查询范围不足，仅找到X个交易日"警告
  - 确保在春节、国庆等长假期也能正确获取7个交易日数据

### 📊 影响范围
- 文件：`src/lib/enhanced-trading-calendar.ts`
- 影响功能：7天数据加载、历史数据查询
- 优先级：高（Critical Bug Fix）

---

## [4.21.0] - 2025-11-19

### ✨ 新增功能
- **历史数据分页浏览**：实现分页模式，页面始终显示7列日期，避免页面拥挤
  - 新增顶部分页导航栏，支持"加载更早"和"加载更新"按钮切换
  - 显示当前页码信息（第X页/共Y页）
  - 最多可加载30天历史数据

### 🐛 问题修复
- **连板个股梯队优化**
  - 自动过滤所有ST个股，不再显示在连板梯队列表中
  - 左侧溢价趋势曲线图只统计3板及以上高板数个股数据
  - 表格仍显示所有2板以上个股（已过滤ST）

### 📝 文档更新
- 更新 CLAUDE.md 项目文档
  - 补充完整的 npm 命令列表（包括 lint、deploy 等）
  - 添加 TypeScript 类型系统架构说明
  - 完善 PM2 配置细节（wait_ready、kill_timeout 等参数）
  - 优化 GitHub Actions 自动部署说明
  - 添加组件架构和辅助工具库说明

### 🔧 技术改进
- 优化日期显示逻辑，使用 `displayDates` useMemo 计算当前页数据
- 改进数据筛选性能，支持大小写不敏感的ST个股过滤
- 完善用户体验，所有相关提示文字都已更新说明

### 📊 影响范围
- **历史数据加载**：用户体验大幅提升，页面不再因为加载过多日期而拥挤
- **连板个股梯队**：数据质量提升，过滤ST个股，高板数曲线更具参考价值
- **类型检查**：所有代码通过 TypeScript 类型检查，无编译错误

---

## [4.20.1] - 2025-11-05
- 完善自动化部署，修复时区问题

## [4.8.26]
- 优化交易日历和数据处理逻辑

## [4.8.18]
- 修复北京时间转换问题

## [4.14]
- 稳定版本，添加分钟级快照功能
