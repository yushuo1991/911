# v4.8.17 服务器部署指南

## 📦 版本信息
- **版本号**: v4.8.17
- **功能**: 涨停数弹窗添加板块成交额显示
- **提交ID**: e6d478d
- **部署时间**: 2025-10-13

---

## 🚀 快速部署（推荐）

### 方法1: 使用部署脚本（最简单）

1. **通过宝塔面板终端或SSH登录服务器**

2. **下载并执行部署脚本**：
```bash
cd /www/wwwroot/stock-tracker
curl -O https://raw.githubusercontent.com/yushuo1991/911/main/DEPLOY-v4.8.17.sh
chmod +x DEPLOY-v4.8.17.sh
./DEPLOY-v4.8.17.sh
```

3. **等待约2-3分钟，部署完成**

---

### 方法2: 手动部署（分步执行）

#### 步骤1: 登录服务器
```bash
ssh root@yushuo.click
# 或使用宝塔面板终端
```

#### 步骤2: 进入项目目录
```bash
cd /www/wwwroot/stock-tracker
pwd  # 确认当前目录
```

#### 步骤3: 拉取最新代码
```bash
git pull origin main
```

如果遇到冲突，先stash本地改动：
```bash
git stash
git pull origin main
```

#### 步骤4: 停止容器
```bash
docker compose down
```

#### 步骤5: 重新构建镜像
```bash
docker compose build --no-cache
```

#### 步骤6: 启动容器
```bash
docker compose up -d
```

#### 步骤7: 验证部署
```bash
# 检查容器状态
docker compose ps

# 查看日志
docker compose logs --tail=50 app

# 测试API
curl -I http://localhost:3000/api/stocks?date=2025-10-13&mode=7days
```

---

## ✅ 功能验证

部署完成后，在浏览器中访问：**http://bk.yushuo.click**

### 验证清单：

1. **首页板块卡片**：
   - [ ] 板块名称下方显示黄色徽章（💰XXX亿）
   - [ ] 数值合理（亿元单位，2位小数）

2. **涨停数弹窗**：
   - [ ] 点击日期头部的"XX只涨停"
   - [ ] 每个板块标题下方显示💰成交额
   - [ ] 布局紧凑（2行：名称+金额）
   - [ ] 按钮（📊M、📈K）正常显示

3. **样式统一**：
   - [ ] 首页和弹窗使用相同的黄色徽章
   - [ ] 只在成交额 > 0 时显示

---

## 🔧 常见问题

### 1. Git pull失败
```bash
# 重置本地改动
git reset --hard HEAD
git pull origin main
```

### 2. Docker构建失败
```bash
# 清理Docker缓存
docker system prune -a
docker compose build --no-cache
```

### 3. 容器启动失败
```bash
# 查看详细日志
docker compose logs -f app

# 检查端口占用
netstat -tulpn | grep 3000
```

### 4. 页面显示异常
```bash
# 强制刷新浏览器缓存
Ctrl + Shift + R (Chrome/Edge)
Cmd + Shift + R (Mac)
```

---

## 🔙 回滚到上一版本

如果部署后出现问题，执行以下命令回滚：

```bash
cd /www/wwwroot/stock-tracker

# 回滚代码到上一个提交
git log --oneline -5  # 查看最近5次提交
git reset --hard 22e3143  # 使用上一个稳定版本的commit ID

# 重新部署
docker compose down
docker compose build --no-cache
docker compose up -d
```

---

## 📊 性能监控

部署后监控关键指标：

```bash
# 查看容器资源占用
docker stats stock-tracker-app-1

# 查看实时日志
docker compose logs -f --tail=100 app

# 检查API响应时间
curl -w "\nTime: %{time_total}s\n" http://localhost:3000/api/stocks?date=2025-10-13&mode=7days
```

---

## 📝 更新日志

### v4.8.17 (2025-10-13)
- ✨ **新功能**: 涨停数弹窗添加板块成交额显示
- 🎨 **样式优化**: flex-col垂直布局，保持内容紧凑
- 🐛 **Bug修复**: 无
- 📦 **依赖更新**: 无

### v4.8.16 (之前)
- ✨ 添加个股成交额列到弹窗表格

---

## 🆘 需要帮助？

如果部署过程中遇到问题：

1. **查看完整日志**：
   ```bash
   docker compose logs --tail=200 app > /tmp/deploy-log.txt
   cat /tmp/deploy-log.txt
   ```

2. **检查环境变量**：
   ```bash
   cat .env.local
   ```

3. **重启所有服务**：
   ```bash
   docker compose down
   docker compose up -d
   ```

---

**部署完成后，请在浏览器中验证功能正常，然后在Claude Code中回复"部署完成"！** ✅
