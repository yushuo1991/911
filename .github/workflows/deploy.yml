name: Deploy to Server (PM2)

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 🚀 开始部署
        run: echo "开始部署到生产服务器 (PM2方式)"

      - name: 📦 部署到服务器
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            echo "📂 进入项目目录..."
            cd /www/wwwroot/stock-tracker
            
            echo "📥 拉取最新代码..."
            git stash
            git pull origin main
            
            echo "📋 查看最新提交..."
            git log -1 --pretty=format:"提交: %h | 作者: %an | 时间: %ad | 说明: %s"
            echo ""
            
            echo "📦 安装依赖..."
            npm install
            
            echo "🔨 构建项目..."
            npm run build
            
            echo "🔄 重启PM2应用..."
            pm2 delete stock-tracker || echo "应用未运行，跳过删除"
            pm2 start npm --name "stock-tracker" -- start
            pm2 save
            
            echo "⏳ 等待5秒让应用启动..."
            sleep 5
            
            echo "✅ 验证部署结果..."
            pm2 list
            pm2 logs stock-tracker --lines 20 --nostream
            
            echo ""
            echo "🌐 测试应用访问..."
            curl -I http://localhost:3000 2>&1 | head -5 || echo "⚠️ 应用可能还在启动中"
            
            echo ""
            echo "✅ 部署完成！"
            echo "📍 访问地址: http://bk.yushuo.click"

      - name: ✅ 部署完成
        run: |
          echo "🎉 部署成功！"
          echo "📍 访问地址: http://bk.yushuo.click"
