# 🔧 GitHub自动部署故障排查手册

**版本**: v1.0
**更新时间**: 2025-09-26
**适用系统**: 宝塔面板 + Docker + GitHub Actions

---

## 🚨 故障分类速查表

| 故障现象 | 问题模块 | 影响范围 | 解决时间 | 参考章节 |
|---------|---------|---------|---------|---------|
| GitHub Actions失败 | CI/CD流程 | 自动部署中断 | 5-15分钟 | [第1章](#1-github-actions故障) |
| SSH连接失败 | 网络/认证 | 无法连接服务器 | 5-10分钟 | [第2章](#2-ssh连接故障) |
| Docker构建失败 | 镜像构建 | 应用无法更新 | 10-20分钟 | [第3章](#3-docker构建故障) |
| 容器启动失败 | 容器运行时 | 服务不可用 | 10-15分钟 | [第4章](#4-容器启动故障) |
| 502网关错误 | 反向代理/应用 | 网站无法访问 | 5-20分钟 | [第5章](#5-502错误故障) |
| 数据库连接失败 | 数据层 | 功能受限 | 15-30分钟 | [第6章](#6-数据库故障) |

---

## 1. GitHub Actions故障

### 1.1 症状识别
```bash
# 在GitHub Actions页面看到
❌ GitHub自动同步到宝塔服务器 #X failed
```

### 1.2 快速诊断
```bash
# 诊断命令（在本地执行）
# 检查Secrets配置是否正确
echo "检查以下Secrets是否存在:"
echo "- SERVER_HOST: 107.173.154.147"
echo "- SERVER_USER: root"
echo "- SERVER_SSH_KEY: (SSH私钥内容)"
```

### 1.3 常见错误及解决方案

#### 错误1：SSH连接超时
**错误日志**:
```
ssh: connect to host 107.173.154.147 port 22: Operation timed out
```

**问题模块**: **网络连接模块**
**影响**: GitHub Actions无法连接服务器，自动部署完全中断
**解决方案**:
```bash
# 1. 检查服务器防火墙
# 在服务器执行:
ufw status
iptables -L | grep 22

# 2. 确认SSH服务运行
systemctl status ssh

# 3. 测试端口连通性
# 在本地执行:
telnet 107.173.154.147 22
```

#### 错误2：认证失败
**错误日志**:
```
Permission denied (publickey,password)
```

**问题模块**: **SSH认证模块**
**影响**: 身份验证失败，无法执行远程部署命令
**解决方案**:
```bash
# 1. 重新生成SSH密钥
cd /www/wwwroot/stock-tracker
./ssh-setup.sh generate

# 2. 更新GitHub Secrets中的SERVER_SSH_KEY
# 复制新的私钥内容到GitHub

# 3. 测试SSH连接
ssh -i ~/.ssh/id_rsa root@107.173.154.147
```

#### 错误3：Secrets配置错误
**错误日志**:
```
Error: Input required and not supplied: host
```

**问题模块**: **GitHub Secrets配置模块**
**影响**: 缺少必要的配置参数，Actions无法执行
**解决方案**:
```bash
# 检查GitHub Secrets配置清单:
# ✅ SERVER_HOST = 107.173.154.147
# ✅ SERVER_USER = root
# ✅ SERVER_SSH_KEY = (完整的SSH私钥)

# 注意事项:
# - 名称必须完全匹配，区分大小写
# - SSH私钥必须包含BEGIN和END行
# - 不能有多余的空格或换行
```

---

## 2. SSH连接故障

### 2.1 症状识别
```bash
# Actions日志显示SSH相关错误
ssh: connect to host XXX port 22: Connection refused/timed out
Permission denied (publickey,password)
```

### 2.2 诊断脚本
```bash
#!/bin/bash
# SSH连接诊断脚本
echo "=== SSH连接诊断 ==="

# 1. 测试网络连通性
echo "1. 测试网络连通性..."
ping -c 3 107.173.154.147

# 2. 测试SSH端口
echo "2. 测试SSH端口..."
nmap -p 22 107.173.154.147

# 3. 检查本地SSH配置
echo "3. 检查SSH密钥..."
ls -la ~/.ssh/

# 4. 测试SSH连接
echo "4. 测试SSH连接..."
ssh -v -o ConnectTimeout=10 root@107.173.154.147 "echo 'SSH连接成功'"
```

### 2.3 解决方案矩阵

| 错误现象 | 根本原因 | 影响模块 | 修复命令 |
|---------|---------|---------|---------|
| Connection refused | SSH服务未启动 | SSH守护进程 | `systemctl start ssh` |
| Connection timed out | 防火墙阻塞 | 网络安全层 | `ufw allow 22` |
| Permission denied | 密钥认证失败 | 身份验证模块 | 重新配置SSH密钥 |
| Host key verification failed | 主机密钥变更 | SSH安全验证 | `ssh-keygen -R 107.173.154.147` |

---

## 3. Docker构建故障

### 3.1 症状识别
```bash
# Actions日志显示Docker构建失败
Step X/Y : RUN npm install
ERROR: failed to solve: process "/bin/sh -c npm install" did not complete successfully
```

### 3.2 问题模块分析

**Docker镜像构建模块**:
- **基础镜像层**: node:18-alpine下载或损坏
- **依赖安装层**: npm包依赖解析失败
- **应用构建层**: Next.js构建过程错误
- **权限设置层**: 用户权限配置问题

### 3.3 诊断检查清单
```bash
#!/bin/bash
# Docker构建诊断脚本
echo "=== Docker构建诊断 ==="

# 1. 检查磁盘空间
echo "1. 磁盘空间检查..."
df -h

# 2. 检查Docker服务
echo "2. Docker服务状态..."
systemctl status docker

# 3. 检查镜像缓存
echo "3. Docker镜像清单..."
docker images

# 4. 检查Dockerfile语法
echo "4. Dockerfile语法检查..."
docker build --dry-run -t test-build .

# 5. 清理Docker缓存
echo "5. 清理Docker缓存..."
docker system prune -f
```

### 3.4 分步解决方案

#### 步骤1：清理Docker环境
```bash
# 停止所有相关容器
docker stop $(docker ps -q --filter ancestor=stock-tracker)

# 删除旧镜像
docker rmi stock-tracker:latest

# 清理构建缓存
docker builder prune -f

# 清理系统缓存
docker system prune -f
```

#### 步骤2：修复Dockerfile问题
```bash
# 检查常见问题:
# 1. 基础镜像是否可用
docker pull node:18-alpine

# 2. package.json语法是否正确
# 3. 依赖包是否存在冲突
# 4. 构建上下文是否正确
```

#### 步骤3：手动构建测试
```bash
# 逐步构建测试
cd /www/wwwroot/stock-tracker

# 测试基础镜像
docker run --rm node:18-alpine node --version

# 测试依赖安装
docker build --target base -t test-base .

# 完整构建
docker build -t stock-tracker:latest . 2>&1 | tee log/manual-build.log
```

---

## 4. 容器启动故障

### 4.1 症状识别
```bash
# 容器创建成功但立即退出
docker ps -a
CONTAINER ID   IMAGE            STATUS
abc123         stock-tracker    Exited (1) 2 seconds ago
```

### 4.2 故障模块分析

**容器运行时模块**:
- **端口绑定**: 3000端口冲突或占用
- **环境变量**: 必需的环境变量缺失或错误
- **文件权限**: 数据目录权限配置错误
- **应用启动**: Next.js应用启动命令失败

### 4.3 诊断方法
```bash
#!/bin/bash
# 容器启动诊断脚本
echo "=== 容器启动诊断 ==="

# 1. 检查容器日志
echo "1. 容器启动日志..."
docker logs stock-tracker-app --tail=50

# 2. 检查端口占用
echo "2. 端口占用检查..."
netstat -tlnp | grep :3000
lsof -i :3000

# 3. 检查环境变量
echo "3. 环境变量检查..."
docker inspect stock-tracker-app | grep -A 20 "Env"

# 4. 检查数据目录权限
echo "4. 数据目录权限..."
ls -la /www/wwwroot/stock-tracker/data/

# 5. 手动启动测试
echo "5. 手动启动测试..."
docker run --rm -it stock-tracker:latest /bin/sh
```

### 4.4 解决步骤

#### 步骤1：检查端口冲突
```bash
# 查找端口占用进程
netstat -tlnp | grep :3000
# 或
lsof -i :3000

# 终止占用进程
kill -9 <PID>

# 或使用其他端口
docker run -p 3001:3000 stock-tracker:latest
```

#### 步骤2：修复环境变量
```bash
# 检查必需的环境变量
REQUIRED_VARS=(
    "NODE_ENV=production"
    "PORT=3000"
    "HOSTNAME=0.0.0.0"
    "TUSHARE_TOKEN=2876ea85cb005fb5fa17c809a98174f2d5aae8b1f830110a5ead6211"
)

# 验证每个变量
for var in "${REQUIRED_VARS[@]}"; do
    echo "检查: $var"
done
```

#### 步骤3：修复权限问题
```bash
# 修复数据目录权限
mkdir -p /www/wwwroot/stock-tracker/data
chmod 755 /www/wwwroot/stock-tracker/data
chown -R 1001:1001 /www/wwwroot/stock-tracker/data

# 验证权限
ls -la /www/wwwroot/stock-tracker/data/
```

---

## 5. 502错误故障

### 5.1 症状识别
```bash
# 浏览器访问显示
HTTP ERROR 502
107.173.154.147 目前无法处理此请求
```

### 5.2 故障链路分析

**502错误链路**:
1. **用户请求** → bk.yushuo.click
2. **DNS解析** → 107.173.154.147
3. **Nginx反向代理** → http://127.0.0.1:3000
4. **Docker容器** → Next.js应用
5. **应用响应** → 返回数据

**可能的故障点**:
- **Nginx配置错误**: 反向代理指向错误
- **容器未运行**: Docker容器停止或崩溃
- **应用无响应**: Next.js应用启动失败
- **端口不匹配**: 容器端口映射错误

### 5.3 分层诊断方法
```bash
#!/bin/bash
# 502错误分层诊断
echo "=== 502错误诊断 ==="

# 第1层：Nginx层
echo "1. Nginx配置检查..."
nginx -t
nginx -s reload

# 第2层：网络层
echo "2. 网络连通性检查..."
curl -I http://127.0.0.1:3000
telnet 127.0.0.1 3000

# 第3层：容器层
echo "3. 容器状态检查..."
docker ps | grep stock-tracker
docker logs stock-tracker-app --tail=20

# 第4层：应用层
echo "4. 应用健康检查..."
docker exec stock-tracker-app curl -f http://localhost:3000 || echo "应用无响应"

# 第5层：系统资源层
echo "5. 系统资源检查..."
free -h
df -h
uptime
```

### 5.4 修复优先级

#### 🚨 紧急修复（5分钟内）
```bash
# 1. 重启容器
docker restart stock-tracker-app

# 2. 重载Nginx
nginx -s reload

# 3. 测试连接
curl -I http://127.0.0.1:3000
```

#### 🔧 标准修复（15分钟内）
```bash
# 1. 完整重建容器
cd /www/wwwroot/stock-tracker
./docker-fix.sh

# 2. 检查所有配置
./docker-debug.sh > log/debug-$(date +%Y%m%d-%H%M%S).log
```

#### 🛠️ 深度修复（30分钟内）
```bash
# 1. 完全重新部署
./一键执行.sh

# 2. 检查系统配置
# 3. 优化资源配置
# 4. 建立监控机制
```

---

## 6. 数据库故障

### 6.1 症状识别
```bash
# 应用日志显示数据库连接错误
Error: connect ECONNREFUSED 127.0.0.1:3306
或
Error: SQLite database is locked
```

### 6.2 数据库模块分析

**当前项目使用内存数据库**:
- **模块**: `src/lib/database-simple.ts`
- **类型**: 内存Map缓存
- **优点**: 避免SQLite/MySQL依赖问题
- **影响**: 容器重启数据丢失（设计如此）

### 6.3 数据库诊断
```bash
#!/bin/bash
# 数据库诊断脚本
echo "=== 数据库诊断 ==="

# 1. 检查数据库配置
echo "1. 数据库配置检查..."
grep -r "database" /www/wwwroot/stock-tracker/src/

# 2. 检查数据目录
echo "2. 数据目录状态..."
ls -la /www/wwwroot/stock-tracker/data/

# 3. 检查容器内数据库
echo "3. 容器内数据库状态..."
docker exec stock-tracker-app ls -la /app/data/

# 4. 测试数据库连接
echo "4. 数据库连接测试..."
docker exec stock-tracker-app node -e "
const db = require('./src/lib/database-simple.js');
console.log('数据库状态:', db.database.getStats());
"
```

---

## 🚀 快速修复工具箱

### 一键诊断命令
```bash
# 全面诊断（生成诊断报告）
cd /www/wwwroot/stock-tracker
./docker-debug.sh > log/diagnosis-$(date +%Y%m%d-%H%M%S).log 2>&1
```

### 一键修复命令
```bash
# 紧急修复（重启服务）
docker restart stock-tracker-app && nginx -s reload

# 标准修复（重建容器）
cd /www/wwwroot/stock-tracker && ./docker-fix.sh

# 完全重置（重新部署）
cd /www/wwwroot/stock-tracker && ./一键执行.sh
```

### 状态监控命令
```bash
# 服务状态检查
watch -n 5 'docker ps | grep stock-tracker && curl -I http://127.0.0.1:3000'

# 实时日志监控
docker logs -f stock-tracker-app

# 系统资源监控
htop
```

---

## 📞 紧急联系清单

### 故障升级流程
1. **L1 - 自助排查** (5分钟)
   - 执行诊断脚本
   - 查看错误日志
   - 尝试重启服务

2. **L2 - 脚本修复** (15分钟)
   - 执行一键修复脚本
   - 检查配置文件
   - 重建Docker镜像

3. **L3 - 深度排查** (30分钟)
   - 检查系统日志
   - 分析网络配置
   - 重新部署应用

### 故障记录模板
```
故障时间: YYYY-MM-DD HH:MM:SS
故障现象: [详细描述用户看到的错误]
影响范围: [网站访问/API接口/数据同步等]
诊断结果: [根本原因分析]
解决方案: [具体修复步骤]
预防措施: [避免再次发生的方法]
```

---

## ✅ 故障预防清单

### 日常监控
- [ ] 每日检查Docker容器状态
- [ ] 每日检查GitHub Actions执行状态
- [ ] 每周清理Docker缓存和日志
- [ ] 每月检查服务器磁盘空间

### 配置备份
- [ ] 定期备份SSH密钥
- [ ] 备份重要配置文件
- [ ] 导出Docker镜像
- [ ] 备份数据库（如使用持久化存储）

### 性能优化
- [ ] 监控容器资源使用率
- [ ] 优化Docker镜像大小
- [ ] 配置日志轮转
- [ ] 设置健康检查机制

现在你有了完整的故障排查手册，遇到任何问题都可以按照手册快速定位和解决！🔧