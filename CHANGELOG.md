# 版本更新日志

---
## 🎉 重要里程碑 - v4.21.3 (2025-11-20)

**✅ 已完成：星期几连板内容完整修订**

本版本标志着"点击星期几显示连板个股梯队"功能的全面完成，实现了以下重要目标：

1. **功能统一** (v4.21.2)：点击星期几的显示效果与点击板块名称完全一致
   - 左侧溢价趋势图表 + 右侧详细表格的分屏布局
   - 今日分时、当日分时、显示K线、涨幅>10%筛选等完整功能
   - 个股名称可点击，支持排序和过滤

2. **数据准确性修复** (v4.21.3)：彻底解决连板个股识别错误问题
   - 修复中文数字板位识别问题（"二板"、"三板"等）
   - 统一板位数据格式，确保前后端一致性
   - 所有连板梯队数据显示准确无误

**备份说明**：此版本已完整测试并部署成功，可作为稳定版本备份节点。

---

## [4.21.3] - 2025-11-20

### 🐛 重要Bug修复
- **修复连板个股识别问题（Critical）**
  - 问题：点击星期几时显示的连板个股不正确
  - 根本原因：外部API返回的 TDType 字段包含中文数字（"二板"、"三板"等），而前端正则表达式只能匹配阿拉伯数字（"2板"、"3板"等）
  - 解决方案：新增 `normalizeBoardType` 函数，将所有中文数字板位转换为阿拉伯数字格式
  - 支持的格式转换：
    - "首板" / "一板" -> "1板"
    - "二板" -> "2板"
    - "三板" -> "3板"
    - ... 以此类推到"十板" -> "10板"
    - "2连板" -> "2板"（也支持连板格式）
  - 影响范围：所有连板个股梯队显示功能

### 🔧 技术改进
- 在 `src/app/api/stocks/route.ts` 中：
  - 新增 `normalizeBoardType(tdType: string)` 函数
  - 替换所有 `stock.TDType.replace('首板', '1').replace('首', '1')` 为 `normalizeBoardType(stock.TDType)`
  - 统一板位数据格式，确保前后端数据一致性

### ⚠️ 重要提示
- 建议清理数据库缓存，因为旧数据的 td_type 格式可能不正确
- 清理方法：访问 `/api/clear-cache` 或重启服务

### 📊 影响范围
- 文件：`src/app/api/stocks/route.ts`
- 影响功能：连板个股梯队显示、点击星期几功能
- 优先级：非常高（Critical Bug Fix）

---

## [4.21.2] - 2025-11-19

### ✨ 重要功能增强
- **统一星期模态框与板块模态框功能**
  - 点击星期几（周一、周二等）时，显示效果与点击板块名称完全一致
  - 新增右上方功能按钮区域：
    - 📊 今日分时：查看所有连板个股的实时分时图
    - 📷 当日分时：查看所有连板个股的当日快照分时图
    - 📈 显示K线：查看所有连板个股的K线图
    - 显示涨幅>10%：过滤仅显示5日累计涨幅大于10%的个股
  - 采用分屏布局：左侧40%显示个股5天溢价趋势图表（使用 StockPremiumChart 组件），右侧60%显示个股详细表格
  - 新增排序功能：支持按连板数或5日累计溢价排序
  - 个股名称可点击，与板块模态框一致的交互体验
  - 图表联动：过滤和排序同时应用于左侧图表和右侧表格

### 🔧 技术改进
- 新增 `getSortedStocksForMultiBoard` 函数，专门处理连板个股梯队的排序逻辑
- 新增状态变量：
  - `showOnly10PlusInMultiBoardModal`：控制涨幅>10%过滤
  - `multiBoardModalSortMode`：控制排序模式（board/return）
- 重构连板个股梯队模态框HTML结构，与板块模态框保持一致的布局和交互
- 优化类型转换逻辑，确保 StockPerformance 类型完整性

### 📊 影响范围
- 文件：`src/app/page.tsx`
- 影响功能：连板个股梯队弹窗（点击星期几时显示）
- 用户体验：大幅提升，功能与点击板块名称完全一致

---

## [4.21.1] - 2025-11-19

### 🐛 重要修复
- **交易日查询范围不足问题**
  - 修复 `get7TradingDaysFromCalendar` 函数的查询范围过小导致的数据加载失败
  - 将查询范围从固定 30 天扩大到 50 天（7 * 5 = 35天基础，增加长假期缓冲）
  - 解决了服务器日志中频繁出现的"查询范围不足，仅找到X个交易日"警告
  - 确保在春节、国庆等长假期也能正确获取7个交易日数据

### 📊 影响范围
- 文件：`src/lib/enhanced-trading-calendar.ts`
- 影响功能：7天数据加载、历史数据查询
- 优先级：高（Critical Bug Fix）

---

## [4.21.0] - 2025-11-19

### ✨ 新增功能
- **历史数据分页浏览**：实现分页模式，页面始终显示7列日期，避免页面拥挤
  - 新增顶部分页导航栏，支持"加载更早"和"加载更新"按钮切换
  - 显示当前页码信息（第X页/共Y页）
  - 最多可加载30天历史数据

### 🐛 问题修复
- **连板个股梯队优化**
  - 自动过滤所有ST个股，不再显示在连板梯队列表中
  - 左侧溢价趋势曲线图只统计3板及以上高板数个股数据
  - 表格仍显示所有2板以上个股（已过滤ST）

### 📝 文档更新
- 更新 CLAUDE.md 项目文档
  - 补充完整的 npm 命令列表（包括 lint、deploy 等）
  - 添加 TypeScript 类型系统架构说明
  - 完善 PM2 配置细节（wait_ready、kill_timeout 等参数）
  - 优化 GitHub Actions 自动部署说明
  - 添加组件架构和辅助工具库说明

### 🔧 技术改进
- 优化日期显示逻辑，使用 `displayDates` useMemo 计算当前页数据
- 改进数据筛选性能，支持大小写不敏感的ST个股过滤
- 完善用户体验，所有相关提示文字都已更新说明

### 📊 影响范围
- **历史数据加载**：用户体验大幅提升，页面不再因为加载过多日期而拥挤
- **连板个股梯队**：数据质量提升，过滤ST个股，高板数曲线更具参考价值
- **类型检查**：所有代码通过 TypeScript 类型检查，无编译错误

---

## [4.20.1] - 2025-11-05
- 完善自动化部署，修复时区问题

## [4.8.26]
- 优化交易日历和数据处理逻辑

## [4.8.18]
- 修复北京时间转换问题

## [4.14]
- 稳定版本，添加分钟级快照功能
