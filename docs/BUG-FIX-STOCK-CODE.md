# ðŸ› è‚¡ç¥¨ä»£ç é”™è¯¯ä¿®å¤æŒ‡å—

## é—®é¢˜æè¿°

**æŠ¥å‘Šé—®é¢˜**ï¼šæµ·å³¡åˆ›æ–°çš„æ¶¨è·Œå¹…æ•°æ®ä¸Žå®žé™…ä¸ç¬¦

**æ ¹æœ¬åŽŸå› **ï¼šå¤–éƒ¨APIè¿”å›žçš„è‚¡ç¥¨ä»£ç æ ¼å¼ä¸æ ‡å‡†ï¼ˆ7ä½æ•°å­—è€Œéž6ä½ï¼‰ï¼Œå¯¼è‡´æŸ¥è¯¢Tushareæ—¶èŽ·å–åˆ°é”™è¯¯çš„æ•°æ®ã€‚

- **é”™è¯¯ä»£ç **ï¼š3003300ï¼ˆ7ä½ï¼‰
- **æ­£ç¡®ä»£ç **ï¼š300330ï¼ˆ6ä½ï¼‰
- **è‚¡ç¥¨åç§°**ï¼šæµ·å³¡åˆ›æ–°
- **è‚¡ç¥¨ç±»åž‹**ï¼šåˆ›ä¸šæ¿

## ä¿®å¤å†…å®¹ï¼ˆv4.20.2ï¼‰

### 1. æ·»åŠ è‚¡ç¥¨ä»£ç è§„èŒƒåŒ–å‡½æ•°

**æ–‡ä»¶**ï¼š`src/app/api/stocks/route.ts`

**æ–°å¢žå‡½æ•°**ï¼š`normalizeStockCode(rawCode: string)`

**åŠŸèƒ½**ï¼š
- è‡ªåŠ¨å°†7ä½åŠä»¥ä¸Šçš„éžæ ‡å‡†ä»£ç æˆªå–ä¸º6ä½æ ‡å‡†ä»£ç 
- æ”¯æŒæ‰€æœ‰å¸‚åœºï¼šåˆ›ä¸šæ¿ï¼ˆ300ï¼‰ã€ç§‘åˆ›æ¿ï¼ˆ688ï¼‰ã€æ·±å¸‚ä¸»æ¿ï¼ˆ000-003ï¼‰ã€ä¸Šäº¤æ‰€ï¼ˆ6ï¼‰ã€åŒ—äº¤æ‰€ï¼ˆ4, 8ï¼‰
- è®°å½•æ‰€æœ‰è§„èŒƒåŒ–æ“ä½œåˆ°æ—¥å¿—

### 2. åº”ç”¨åˆ°æ•°æ®è§£æž

åœ¨è§£æžå¤–éƒ¨APIè¿”å›žçš„è‚¡ç¥¨æ•°æ®æ—¶ï¼Œè‡ªåŠ¨è§„èŒƒåŒ–ä»£ç ï¼š

```typescript
const rawStockCode = stockData[0];
const stockCode = normalizeStockCode(rawStockCode); // è§„èŒƒåŒ–
```

### 3. æ·»åŠ ç¼“å­˜æ¸…é™¤åŠŸèƒ½

**æ–°å¢žAPI**ï¼š`/api/clear-cache`

**åŠŸèƒ½**ï¼šæ¸…é™¤é”™è¯¯çš„ç¼“å­˜æ•°æ®

**æ–°å¢žæ•°æ®åº“æ–¹æ³•**ï¼š
- `clearStockDataCache(date)` - æ¸…é™¤æŒ‡å®šæ—¥æœŸçš„æ¶¨åœè‚¡ç¥¨ç¼“å­˜
- `clearPerformanceCache(baseDate)` - æ¸…é™¤è‚¡ç¥¨è¡¨çŽ°ç¼“å­˜
- `clear7DaysCache()` - æ¸…é™¤7å¤©æ•°æ®ç¼“å­˜

### 4. æ·»åŠ è¯Šæ–­å·¥å…·

**æ–°å¢žAPI**ï¼š`/api/debug-stock`

**åŠŸèƒ½**ï¼šæŸ¥è¯¢æŒ‡å®šè‚¡ç¥¨åœ¨æŒ‡å®šæ—¥æœŸèŒƒå›´çš„çœŸå®žæ•°æ®

---

## éªŒè¯ä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šæ¸…é™¤æ—§ç¼“å­˜

ä¿®å¤å‰çš„é”™è¯¯æ•°æ®å¯èƒ½å·²è¢«ç¼“å­˜ï¼Œéœ€è¦æ¸…é™¤ï¼š

```bash
# æ–¹æ³•1ï¼šæ¸…é™¤æ‰€æœ‰ç¼“å­˜
curl -X POST "http://localhost:3000/api/clear-cache?type=all"

# æ–¹æ³•2ï¼šæ¸…é™¤ç‰¹å®šæ—¥æœŸï¼ˆå¦‚2025-10-28ï¼‰
curl -X POST "http://localhost:3000/api/clear-cache?date=2025-10-28&type=all"

# æ–¹æ³•3ï¼šåªæ¸…é™¤7å¤©æ•°æ®ç¼“å­˜
curl -X POST "http://localhost:3000/api/clear-cache?type=7days"
```

### æ­¥éª¤2ï¼šé‡å¯åº”ç”¨

```bash
# å¦‚æžœä½¿ç”¨PM2
pm2 restart stock-tracker

# å¦‚æžœä½¿ç”¨npm
npm run build
npm start
```

### æ­¥éª¤3ï¼šé‡æ–°èŽ·å–æ•°æ®

åˆ·æ–°é¡µé¢ï¼Œç³»ç»Ÿä¼šï¼š
1. ä»Žå¤–éƒ¨APIèŽ·å–æ¶¨åœè‚¡ç¥¨åˆ—è¡¨
2. è‡ªåŠ¨è§„èŒƒåŒ–è‚¡ç¥¨ä»£ç ï¼ˆ7ä½â†’6ä½ï¼‰
3. ä½¿ç”¨æ­£ç¡®çš„ä»£ç æŸ¥è¯¢TushareèŽ·å–æ¶¨è·Œå¹…æ•°æ®
4. æ˜¾ç¤ºæ­£ç¡®çš„æ•°æ®

### æ­¥éª¤4ï¼šéªŒè¯ä¿®å¤

#### æ–¹æ³•1ï¼šæŸ¥çœ‹å‰ç«¯æ˜¾ç¤º

1. æ‰“å¼€åº”ç”¨
2. ç‚¹å‡»10-28çš„æµ·å—æ¿å—ï¼ˆæˆ–å…¶ä»–æœ‰é—®é¢˜çš„æ¿å—ï¼‰
3. æŸ¥çœ‹æµ·å³¡åˆ›æ–°çš„ï¼š
   - **è‚¡ç¥¨ä»£ç **ï¼šåº”è¯¥æ˜¾ç¤º `(300330)` è€Œä¸æ˜¯ `(3003300)`
   - **æ¶¨è·Œå¹…æ•°æ®**ï¼šåº”è¯¥ä¸Žå®žé™…è‚¡å¸‚æ•°æ®ä¸€è‡´

#### æ–¹æ³•2ï¼šä½¿ç”¨è¯Šæ–­API

æŸ¥è¯¢æµ·å³¡åˆ›æ–°åœ¨10-29åˆ°11-04çš„çœŸå®žæ•°æ®ï¼š

```bash
curl "http://localhost:3000/api/debug-stock?code=300330&start=2025-10-29&end=2025-11-04"
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "success": true,
  "stockCode": "300330",
  "tsCode": "300330.SZ",
  "dateRange": "2025-10-29 åˆ° 2025-11-04",
  "data": [
    {
      "date": "2025-10-29",
      "pct_chg": X.XX,  // çœŸå®žæ¶¨è·Œå¹…
      "close": XXX.XX,
      "pre_close": XXX.XX
    },
    // ... å…¶ä»–æ—¥æœŸ
  ],
  "totalDays": 5
}
```

å¯¹æ¯”è¯Šæ–­APIè¿”å›žçš„æ•°æ®å’Œå‰ç«¯æ˜¾ç¤ºçš„æ•°æ®ï¼Œç¡®è®¤ä¸€è‡´ã€‚

#### æ–¹æ³•3ï¼šæ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—

æŸ¥çœ‹æ˜¯å¦æœ‰ä»£ç è§„èŒƒåŒ–çš„æ—¥å¿—ï¼š

```
[ä»£ç è§„èŒƒåŒ–] åˆ›ä¸šæ¿: 3003300 â†’ 300330
```

å¦‚æžœçœ‹åˆ°è¿™æ¡æ—¥å¿—ï¼Œè¯´æ˜Žä¿®å¤å·²ç”Ÿæ•ˆã€‚

---

## é¢„æœŸä¿®å¤æ•ˆæžœ

### ä¿®å¤å‰
- âŒ è‚¡ç¥¨ä»£ç ï¼š3003300ï¼ˆé”™è¯¯ï¼‰
- âŒ æ¶¨è·Œå¹…ï¼šä¸Žå®žé™…ä¸ç¬¦
- âŒ å¯èƒ½æ— æ³•æŸ¥è¯¢åˆ°æ•°æ®

### ä¿®å¤åŽ
- âœ… è‚¡ç¥¨ä»£ç ï¼š300330ï¼ˆæ­£ç¡®ï¼‰
- âœ… æ¶¨è·Œå¹…ï¼šä¸ŽTushare APIè¿”å›žçš„çœŸå®žæ•°æ®ä¸€è‡´
- âœ… æ•°æ®æŸ¥è¯¢æ­£å¸¸
- âœ… æ‰€æœ‰ä½¿ç”¨è¯¥ä»£ç çš„è‚¡ç¥¨éƒ½ä¼šè¢«è‡ªåŠ¨ä¿®å¤

---

## å½±å“èŒƒå›´

### å—ç›Šçš„è‚¡ç¥¨ç±»åž‹

æ‰€æœ‰å¯èƒ½å‡ºçŽ°éžæ ‡å‡†ä»£ç çš„è‚¡ç¥¨éƒ½ä¼šè¢«è‡ªåŠ¨ä¿®å¤ï¼š

| å¸‚åœº | æ ‡å‡†æ ¼å¼ | å¯èƒ½çš„é”™è¯¯æ ¼å¼ | ä¿®å¤åŽ |
|------|----------|----------------|--------|
| åˆ›ä¸šæ¿ | 300XXX | 3003300, 3003301 ç­‰ | 300330 |
| ç§‘åˆ›æ¿ | 688XXX | 6883000 ç­‰ | 688300 |
| æ·±å¸‚ä¸»æ¿ | 000XXX | 0005920 ç­‰ | 000592 |
| ä¸Šäº¤æ‰€ | 6XXXXX | 6000001 ç­‰ | 600000 |
| åŒ—äº¤æ‰€ | 8XXXXX, 4XXXXX | 8300000 ç­‰ | 830000 |

### ä¸å½±å“

- âœ… ä»£ç æ ¼å¼æœ¬èº«å°±æ­£ç¡®çš„è‚¡ç¥¨ï¼ˆå¤§éƒ¨åˆ†ï¼‰
- âœ… å…¶ä»–åŠŸèƒ½æ¨¡å—
- âœ… åŽ†å²æ•°æ®ï¼ˆéœ€è¦æ¸…é™¤ç¼“å­˜åŽé‡æ–°èŽ·å–ï¼‰

---

## é•¿æœŸç›‘æŽ§

### 1. æ·»åŠ ä»£ç éªŒè¯å‘Šè­¦

å»ºè®®åœ¨åŽç»­ç‰ˆæœ¬ä¸­æ·»åŠ ï¼š

```typescript
function validateStockCode(code: string, name: string): boolean {
  if (code.length !== 6) {
    console.warn(`[ä»£ç éªŒè¯] ${name} çš„ä»£ç æ ¼å¼å¼‚å¸¸: ${code}`);
    return false;
  }
  if (!/^\d{6}$/.test(code)) {
    console.warn(`[ä»£ç éªŒè¯] ${name} çš„ä»£ç åŒ…å«éžæ•°å­—: ${code}`);
    return false;
  }
  return true;
}
```

### 2. å®šæœŸæ£€æŸ¥

å»ºè®®æ¯å‘¨æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰æ–°çš„ä»£ç æ ¼å¼é—®é¢˜ï¼š

```bash
# æŸ¥çœ‹æœ€è¿‘çš„ä»£ç è§„èŒƒåŒ–æ—¥å¿—
grep "ä»£ç è§„èŒƒåŒ–" logs/*.log | tail -20
```

### 3. æ•°æ®è´¨é‡ç›‘æŽ§

ç›‘æŽ§Tushare APIè¿”å›žçš„æ•°æ®æ˜¯å¦æ­£å¸¸ï¼š
- æ˜¯å¦æœ‰å¤§é‡0å€¼
- æ˜¯å¦æœ‰å¼‚å¸¸çš„æ¶¨è·Œå¹…ï¼ˆå¦‚>50%æˆ–<-50%ï¼‰
- æ˜¯å¦æœ‰ç¼ºå¤±æ•°æ®

---

## æ•…éšœæŽ’æŸ¥

### é—®é¢˜1ï¼šä¿®å¤åŽæ•°æ®ä»ç„¶ä¸å¯¹

**å¯èƒ½åŽŸå› **ï¼š
- ç¼“å­˜æœªæ¸…é™¤å¹²å‡€
- åº”ç”¨æœªé‡å¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ¸…é™¤æ‰€æœ‰ç¼“å­˜
curl -X POST "http://localhost:3000/api/clear-cache?type=all"

# 2. é‡å¯åº”ç”¨
pm2 restart stock-tracker

# 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# æŒ‰ Ctrl+Shift+R å¼ºåˆ¶åˆ·æ–°
```

### é—®é¢˜2ï¼šè¯Šæ–­APIæ— æ³•è®¿é—®

**å¯èƒ½åŽŸå› **ï¼š
- åº”ç”¨æœªå¯åŠ¨
- ç«¯å£ä¸å¯¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥åº”ç”¨çŠ¶æ€
pm2 status

# æ£€æŸ¥ç«¯å£
netstat -tuln | grep 3000

# é‡å¯åº”ç”¨
pm2 restart stock-tracker
```

### é—®é¢˜3ï¼šæŸäº›è‚¡ç¥¨ä»ç„¶æ˜¾ç¤ºé”™è¯¯ä»£ç 

**å¯èƒ½åŽŸå› **ï¼š
- ä»£ç æ ¼å¼ç‰¹æ®Šï¼Œæœªè¢«è§„èŒƒåŒ–å‡½æ•°è¦†ç›–

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è®°å½•é”™è¯¯çš„ä»£ç æ ¼å¼
2. åœ¨ `normalizeStockCode` å‡½æ•°ä¸­æ·»åŠ æ–°çš„è§„åˆ™
3. é‡æ–°éƒ¨ç½²

---

## ç›¸å…³æ–‡ä»¶

- **ä¿®å¤ä»£ç **ï¼š`src/app/api/stocks/route.ts`
- **æ•°æ®åº“æ–¹æ³•**ï¼š`src/lib/database.ts`
- **æ¸…é™¤ç¼“å­˜API**ï¼š`src/app/api/clear-cache/route.ts`
- **è¯Šæ–­API**ï¼š`src/app/api/debug-stock/route.ts`
- **é—®é¢˜åˆ†æž**ï¼š`STOCK-CODE-FIX.md`

---

## æ€»ç»“

âœ… **é—®é¢˜å·²ä¿®å¤**ï¼šæ·»åŠ äº†è‚¡ç¥¨ä»£ç è§„èŒƒåŒ–åŠŸèƒ½  
âœ… **å½±å“èŒƒå›´**ï¼šæ‰€æœ‰ä½¿ç”¨éžæ ‡å‡†ä»£ç çš„è‚¡ç¥¨  
âœ… **éªŒè¯æ–¹æ³•**ï¼šæ¸…é™¤ç¼“å­˜â†’é‡å¯â†’æ£€æŸ¥å‰ç«¯æ˜¾ç¤º  
âœ… **è¯Šæ–­å·¥å…·**ï¼šå¯ç”¨è¯Šæ–­APIéªŒè¯æ•°æ®æ­£ç¡®æ€§  

**å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼**

