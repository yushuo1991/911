# 📦 版本备份：v4.21.1 - 修复个股弹窗层级问题

## 📅 备份信息
- **版本号**: v4.21.1
- **备份时间**: 2025年10月21日 13:34
- **备份文件**: `backup/v4.21.1-modal-zindex-fix-20251021.tar.gz`
- **Git提交**: 9986ee6

## 🐛 本版本修复内容

### 问题描述
**用户反馈**：在点击"今日分时"或"显示K线"后弹出的板块展示页面中，再点击个股名称弹出的个股K线图被遮挡，看不到。

### 根本原因
**z-index 层级冲突**：
- K线/分时批量展示弹窗：`z-[90]`
- 个股K线弹窗：`z-[70]` ⬅️ 层级太低，被遮挡

### 修复方案
提升个股K线弹窗的层级到最顶层：

#### 1️⃣ 个股K线弹窗主体
```tsx
// 修复前
<div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[70]">

// 修复后
<div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[100]">
```

**修改位置**: `src/app/page.tsx` 第1938行

#### 2️⃣ 个股K线背景遮罩
```tsx
// 修复前
<div className="fixed inset-0 z-40" onClick={closeModal} />

// 修复后
<div className="fixed inset-0 z-[95]" onClick={closeModal} />
```

**修改位置**: `src/app/page.tsx` 第2435行

---

## 📊 修复前后对比

### ❌ 修复前的层级结构
```
z-[90]  ─────── K线/分时批量展示弹窗 (最顶层)
z-[70]  ─────── 个股K线弹窗 (被遮挡！)
z-[60]  ─────── 其他模态框
z-[40]  ─────── 背景遮罩
```

### ✅ 修复后的层级结构
```
z-[100] ─────── 个股K线弹窗 (最顶层！) ✅
z-[95]  ─────── 个股背景遮罩
z-[90]  ─────── K线/分时批量展示弹窗
z-[60]  ─────── 其他模态框
z-[40]  ─────── 其他背景遮罩
```

---

## 🎯 修复效果

### 修复前
1. 点击"显示K线" → 弹出板块K线展示 ✅
2. 点击个股名称 → 个股K线弹窗被遮挡 ❌
3. 无法看到个股K线图 ❌

### 修复后
1. 点击"显示K线" → 弹出板块K线展示 ✅
2. 点击个股名称 → 个股K线弹窗显示在最顶层 ✅
3. 可以清晰看到个股K线和分时图 ✅
4. 点击背景可正常关闭 ✅

---

## 🛠️ 技术细节

### 修改的文件
- `src/app/page.tsx` - 主要修复文件

### 代码变更统计
- **修改行数**: 2行
- **新增代码**: 0行
- **删除代码**: 0行
- **仅修改**: 2行（z-index值调整）

### 影响范围
- ✅ 仅影响个股K线弹窗的显示层级
- ✅ 不影响其他功能
- ✅ 向后兼容
- ✅ 无破坏性变更

---

## 📋 完整的层级体系

| 弹窗类型 | z-index | 说明 |
|---------|---------|------|
| 🟢 **个股K线弹窗** | `z-[100]` | 最高优先级（本次修复） |
| 🟢 个股背景遮罩 | `z-[95]` | 配套遮罩（本次修复） |
| 🔴 K线批量展示 | `z-[90]` | 板块级别 |
| 🔴 分时批量展示 | `z-[90]` | 板块级别 |
| 🔵 板块详情弹窗 | `z-[60]` | 中等优先级 |
| 🔵 日期列详情 | `z-[60]` | 中等优先级 |
| ⚪ 其他模态框 | `z-[50]` | 普通优先级 |
| ⚫ 普通背景遮罩 | `z-[40]` | 基础层级 |

---

## 🚀 部署记录

### 部署方式
- **方式**: Docker容器化部署
- **容器名**: stock-tracker-app
- **端口映射**: 3002:3000
- **数据库**: MySQL 8.0 (独立容器)

### 部署时间线
```
13:04:25 - 代码提交
13:24:01 - 开始部署
13:24:05 - SSH连接成功
13:24:11 - Git拉取完成 (Already up to date)
13:33:27 - Docker构建完成 (~9分钟)
13:34:08 - 部署完成 ✅
```

### 部署耗时
- SSH连接: 4秒
- Git操作: 6秒
- Docker构建: 9分05秒
- 容器启动: 20秒
- **总耗时**: 约10分钟

### 部署命令
```bash
git add src/app/page.tsx
git commit -m "fix: increase z-index of stock modal to display above other modals"
git push origin main
npm run deploy
```

---

## 🌐 访问信息

- **生产环境**: http://bk.yushuo.click
- **服务器IP**: 107.173.154.147
- **项目路径**: /www/wwwroot/stock-tracker
- **容器状态**: ✅ 健康运行中

---

## ✅ 测试清单

- [x] K线批量展示弹窗正常显示
- [x] 分时批量展示弹窗正常显示
- [x] 在K线弹窗中点击个股名称
- [x] 个股K线弹窗显示在最顶层
- [x] 个股K线图清晰可见
- [x] 分时图清晰可见
- [x] 点击背景可正常关闭
- [x] 点击关闭按钮可正常关闭
- [x] 无层级冲突
- [x] 容器健康检查通过
- [x] 生产环境访问正常

---

## 🔄 回滚方案

### 回滚到 v4.21.0（修复前）
```bash
# SSH登录服务器
ssh root@107.173.154.147

# 回滚Git版本
cd /www/wwwroot/stock-tracker
git checkout v4.21.0

# 重新构建并启动
docker compose down
docker compose build
docker compose up -d
```

### 使用备份文件回滚
```bash
# 解压备份
cd /www/wwwroot
tar -xzf backup/v4.21.0-peak-labels-20251021.tar.gz

# 重新部署
cd stock-tracker
docker compose down
docker compose build
docker compose up -d
```

---

## 🐛 已知问题
- ✅ 无已知问题
- ✅ z-index层级问题已完全修复

---

## 📝 相关文件

### 修改的文件
- `src/app/page.tsx` - z-index调整

### 配置文件
- `package.json` - 版本号更新 4.21.0 → 4.21.1
- `docker-compose.yml` - Docker配置
- `Dockerfile` - 镜像构建

---

## 📌 备注

- 本次更新为BUG修复，属于补丁版本
- 仅修改z-index值，不涉及功能逻辑变更
- 完全向后兼容v4.21.0
- 建议在使用前按 Ctrl+Shift+R 强制刷新浏览器缓存

---

## 🔗 相关版本

- **v4.21.0** - 图表峰值标签功能
- **v4.21.1** - 修复个股弹窗层级问题 ⬅️ **当前版本**

---

## 👤 开发信息

- **开发者**: yushu
- **提交**: 9986ee6
- **提交时间**: 2025-10-21 13:04:25
- **部署时间**: 2025-10-21 13:34:08

---

**备份状态**: ✅ 已完成  
**部署状态**: ✅ 生产环境运行中  
**文档版本**: 1.0  
**最后更新**: 2025-10-21 13:34

