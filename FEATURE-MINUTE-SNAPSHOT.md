# ğŸ“¸ åˆ†æ—¶å›¾å¿«ç…§åŠŸèƒ½ v4.22.0

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æ–°å¢**"å½“æ—¥åˆ†æ—¶"**åŠŸèƒ½ï¼Œå¯ä»¥æŸ¥çœ‹å†å²ä»»ä½•ä¸€å¤©çš„åˆ†æ—¶å›¾å¿«ç…§ï¼Œä¸å†å±€é™äºåªèƒ½çœ‹å½“å¤©å®æ—¶åˆ†æ—¶å›¾ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1ï¸âƒ£ è‡ªåŠ¨å¿«ç…§é‡‡é›†
- â° **å®šæ—¶ä»»åŠ¡**: æ¯å¤© 15:00 è‡ªåŠ¨æ‰§è¡Œ
- ğŸ“Š **é‡‡é›†å¯¹è±¡**: å½“å¤©æ‰€æœ‰æ¶¨åœè‚¡ç¥¨
- ğŸ’¾ **å­˜å‚¨æ–¹å¼**: æ–‡ä»¶ç³»ç»Ÿ + æ•°æ®åº“ç´¢å¼•
- ğŸ—‘ï¸ **è‡ªåŠ¨æ¸…ç†**: ä¿ç•™æœ€è¿‘14å¤©ï¼Œè¶…æœŸè‡ªåŠ¨åˆ é™¤

### 2ï¸âƒ£ åŒæ¨¡å¼åˆ‡æ¢
- ğŸ“Š **ä»Šæ—¥åˆ†æ—¶**: å®æ—¶ä»æ–°æµªè´¢ç»APIè·å–
- ğŸ“· **å½“æ—¥åˆ†æ—¶**: ä»æ•°æ®åº“è¯»å–å†å²å¿«ç…§
- ğŸ”„ **ä¸€é”®åˆ‡æ¢**: ç•Œé¢ä¸Šéšæ—¶å¯åˆ‡æ¢æŸ¥çœ‹

### 3ï¸âƒ£ å…¨é¢è¦†ç›–
åœ¨æ‰€æœ‰æ˜¾ç¤ºåˆ†æ—¶å›¾çš„ä½ç½®éƒ½æ”¯æŒï¼š
- âœ… æ¿å—è¯¦æƒ…å¼¹çª—
- âœ… åˆ†æ—¶å›¾æ‰¹é‡å±•ç¤ºå¼¹çª—
- âœ… ä¸ªè‚¡è¯¦æƒ…å¼¹çª—

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•°æ®åº“è®¾è®¡
```sql
CREATE TABLE minute_chart_snapshots (
  id INT PRIMARY KEY AUTO_INCREMENT,
  trade_date DATE NOT NULL,           -- äº¤æ˜“æ—¥æœŸ
  stock_code VARCHAR(10) NOT NULL,    -- è‚¡ç¥¨ä»£ç 
  stock_name VARCHAR(50),             -- è‚¡ç¥¨åç§°
  file_path VARCHAR(255) NOT NULL,    -- å›¾ç‰‡æ–‡ä»¶è·¯å¾„
  file_size INT,                      -- æ–‡ä»¶å¤§å°
  created_at TIMESTAMP,               -- åˆ›å»ºæ—¶é—´
  INDEX idx_date_code (trade_date, stock_code),
  UNIQUE KEY uk_date_code (trade_date, stock_code)
);
```

### æ–‡ä»¶å­˜å‚¨ç»“æ„
```
project_root/
â””â”€â”€ data/
    â””â”€â”€ minute-snapshots/
        â”œâ”€â”€ 2025-10-21/
        â”‚   â”œâ”€â”€ 600000.gif
        â”‚   â”œâ”€â”€ 600519.gif
        â”‚   â””â”€â”€ ...
        â”œâ”€â”€ 2025-10-22/
        â”‚   â””â”€â”€ ...
        â””â”€â”€ ...
```

### APIæ¥å£

#### 1. è¯»å–åˆ†æ—¶å›¾å¿«ç…§
```
GET /api/minute-snapshot?date=2025-10-21&code=600000
```

**å“åº”**: è¿”å›GIFå›¾ç‰‡æ•°æ®

---

#### 2. ä¿å­˜åˆ†æ—¶å›¾å¿«ç…§
```
POST /api/minute-snapshot
Content-Type: application/json

{
  "date": "2025-10-21",
  "stocks": [
    { "code": "600000", "name": "æµ¦å‘é“¶è¡Œ" },
    { "code": "600519", "name": "è´µå·èŒ…å°" }
  ]
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "åˆ†æ—¶å›¾å¿«ç…§ä¿å­˜å®Œæˆ",
  "data": {
    "total": 2,
    "success": 2,
    "failed": 0,
    "errors": []
  }
}
```

---

#### 3. æ¸…ç†è¿‡æœŸå¿«ç…§
```
DELETE /api/minute-snapshot
```

**åŠŸèƒ½**: åˆ é™¤14å¤©å‰çš„æ‰€æœ‰å¿«ç…§

**å“åº”**:
```json
{
  "success": true,
  "message": "å·²æ¸…ç† X æ¡è¶…è¿‡14å¤©çš„è®°å½•",
  "data": {
    "deletedRecords": 150,
    "deletedFiles": 150,
    "cutoffDate": "2025-10-07"
  }
}
```

---

#### 4. å®šæ—¶ä»»åŠ¡è°ƒåº¦
```
POST /api/snapshot-scheduler
Authorization: Bearer {SCHEDULER_TOKEN}
```

**åŠŸèƒ½**: æ‰§è¡Œå®Œæ•´çš„å¿«ç…§é‡‡é›†æµç¨‹
1. è·å–å½“å¤©æ¶¨åœè‚¡ç¥¨åˆ—è¡¨
2. æ‰¹é‡ä¸‹è½½å¹¶ä¿å­˜åˆ†æ—¶å›¾
3. è‡ªåŠ¨æ¸…ç†14å¤©å‰çš„æ•°æ®

**å“åº”**:
```json
{
  "success": true,
  "message": "åˆ†æ—¶å›¾å¿«ç…§å®šæ—¶ä»»åŠ¡å®Œæˆ",
  "data": {
    "date": "2025-10-21",
    "totalStocks": 85,
    "snapshotResults": {
      "total": 85,
      "success": 85,
      "failed": 0
    },
    "cleanupResults": {
      "deletedRecords": 120,
      "deletedFiles": 120
    }
  }
}
```

---

## ğŸ¨ å‰ç«¯ä½¿ç”¨

### UIç•Œé¢

#### æ¿å—è¯¦æƒ…å¼¹çª—
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¦å»ºæ¿å— - 2025-10-21           â”‚
â”‚  [ğŸ“Š ä»Šæ—¥åˆ†æ—¶] [ğŸ“· å½“æ—¥åˆ†æ—¶]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åˆ†æ—¶å›¾æ‰¹é‡å±•ç¤º
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š ç¦å»ºæ¿å— - ä»Šæ—¥åˆ†æ—¶å›¾ (2025-10-21)    â”‚
â”‚  [ğŸ“Š ä»Šæ—¥åˆ†æ—¶] [ğŸ“· å½“æ—¥åˆ†æ—¶]              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚åˆ†æ—¶1â”‚ â”‚åˆ†æ—¶2â”‚ â”‚åˆ†æ—¶3â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç‚¹å‡»åˆ‡æ¢æŒ‰é’®åï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“· ç¦å»ºæ¿å— - å½“æ—¥åˆ†æ—¶å›¾ (2025-10-21)    â”‚
â”‚  [ğŸ“Š ä»Šæ—¥åˆ†æ—¶] [ğŸ“· å½“æ—¥åˆ†æ—¶]              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚å¿«ç…§1â”‚ â”‚å¿«ç…§2â”‚ â”‚å¿«ç…§3â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€ç®¡ç†
```typescript
const [minuteChartMode, setMinuteChartMode] = useState<'realtime' | 'snapshot'>('realtime');
```

### å›¾ç‰‡URLç”Ÿæˆ
```typescript
function getMinuteChartUrl(stockCode: string, mode: 'realtime' | 'snapshot', date?: string): string {
  if (mode === 'snapshot' && date) {
    return `/api/minute-snapshot?date=${date}&code=${stockCode}`;
  } else {
    const codeFormat = getStockCodeFormat(stockCode);
    return `http://image.sinajs.cn/newchart/min/n/${codeFormat}.gif`;
  }
}
```

---

## âš™ï¸ éƒ¨ç½²é…ç½®

### 1. æ•°æ®åº“åˆå§‹åŒ–
```bash
# åœ¨MySQLä¸­æ‰§è¡Œ
mysql -u root -p stock_tracker < init-minute-snapshots.sql
```

### 2. åˆ›å»ºæ•°æ®ç›®å½•
```bash
mkdir -p /www/wwwroot/stock-tracker/data/minute-snapshots
chown -R nextjs:nodejs /www/wwwroot/stock-tracker/data
```

### 3. é…ç½®å®šæ—¶ä»»åŠ¡

#### æ–¹å¼A: ç³»ç»ŸCron (æ¨è)
```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»»åŠ¡ï¼šæ¯ä¸ªäº¤æ˜“æ—¥15:00æ‰§è¡Œ
0 15 * * 1-5 curl -X POST http://localhost:3002/api/snapshot-scheduler \
  -H "Authorization: Bearer default-secure-token" >> /var/log/minute-snapshot.log 2>&1
```

#### æ–¹å¼B: æ‰‹åŠ¨è§¦å‘
```bash
# å¯ä»¥éšæ—¶æ‰‹åŠ¨æ‰§è¡Œ
curl -X POST http://localhost:3002/api/snapshot-scheduler \
  -H "Authorization: Bearer default-secure-token"
```

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡

### å­˜å‚¨ç©ºé—´ä¼°ç®—
- **å•å¼ åˆ†æ—¶å›¾**: çº¦ 20-50 KB
- **æ¯å¤©æ¶¨åœè‚¡æ•°**: å¹³å‡ 80-150 åª
- **æ¯å¤©å­˜å‚¨**: çº¦ 3-7 MB
- **14å¤©å­˜å‚¨**: çº¦ 50-100 MB

### æ€§èƒ½æŒ‡æ ‡
- **å•æ¬¡é‡‡é›†æ—¶é—´**: 2-5 åˆ†é’Ÿ (å–å†³äºæ¶¨åœè‚¡æ•°é‡)
- **APIå“åº”æ—¶é—´**: < 100ms
- **å›¾ç‰‡åŠ è½½æ—¶é—´**: < 500ms

---

## ğŸ”§ ç»´æŠ¤ç®¡ç†

### æ‰‹åŠ¨æ¸…ç†
```bash
# æ¸…ç†14å¤©å‰çš„å¿«ç…§
curl -X DELETE http://localhost:3002/api/minute-snapshot
```

### æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨
```bash
du -sh /www/wwwroot/stock-tracker/data/minute-snapshots/
```

### æ•°æ®åº“ç»´æŠ¤
```sql
-- æŸ¥çœ‹å¿«ç…§ç»Ÿè®¡
SELECT 
  trade_date, 
  COUNT(*) as stock_count,
  SUM(file_size)/1024/1024 as total_mb
FROM minute_chart_snapshots
GROUP BY trade_date
ORDER BY trade_date DESC
LIMIT 14;

-- æŸ¥çœ‹æ€»æ•°
SELECT COUNT(*) as total_snapshots FROM minute_chart_snapshots;

-- æ¸…ç†æŒ‡å®šæ—¥æœŸ
DELETE FROM minute_chart_snapshots WHERE trade_date < '2025-10-07';
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å­˜å‚¨ç©ºé—´**: ç¡®ä¿æœåŠ¡å™¨æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆå»ºè®®é¢„ç•™2GBï¼‰
2. **ç½‘ç»œç¨³å®š**: é‡‡é›†è¿‡ç¨‹éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥åˆ°æ–°æµªè´¢ç»API
3. **æ—¶é—´è®¾ç½®**: å®šæ—¶ä»»åŠ¡è®¾ç½®åœ¨15:00ï¼Œç¡®ä¿è‚¡å¸‚å·²æ”¶ç›˜
4. **æƒé™é…ç½®**: ç¡®ä¿dataç›®å½•æœ‰æ­£ç¡®çš„è¯»å†™æƒé™
5. **å¤‡ä»½ç­–ç•¥**: é‡è¦å¿«ç…§å»ºè®®å®šæœŸå¤‡ä»½åˆ°äº‘å­˜å‚¨

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: å¿«ç…§æ˜¾ç¤º"æš‚æ— å½“æ—¥å¿«ç…§"
**åŸå› **: æ•°æ®åº“ä¸­æ²¡æœ‰è¯¥æ—¥æœŸçš„å¿«ç…§
**è§£å†³**:
```bash
# æ‰‹åŠ¨è§¦å‘é‡‡é›†
curl -X POST http://localhost:3002/api/snapshot-scheduler \
  -H "Authorization: Bearer default-secure-token"
```

### é—®é¢˜2: å®šæ—¶ä»»åŠ¡æœªæ‰§è¡Œ
**æ£€æŸ¥**:
```bash
# æŸ¥çœ‹cronæ—¥å¿—
tail -f /var/log/minute-snapshot.log

# æ£€æŸ¥cronæœåŠ¡
systemctl status cron
```

### é—®é¢˜3: å­˜å‚¨ç©ºé—´ä¸è¶³
**æ¸…ç†**:
```bash
# åˆ é™¤14å¤©å‰çš„æ•°æ®
curl -X DELETE http://localhost:3002/api/minute-snapshot

# æˆ–æ‰‹åŠ¨åˆ é™¤
rm -rf /www/wwwroot/stock-tracker/data/minute-snapshots/2025-10-01
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v4.22.0 (2025-10-21)
- âœ¨ æ–°å¢åˆ†æ—¶å›¾å¿«ç…§åŠŸèƒ½
- âœ¨ æ–°å¢"å½“æ—¥åˆ†æ—¶"æŒ‰é’®
- âœ¨ æ–°å¢è‡ªåŠ¨å®šæ—¶é‡‡é›†ä»»åŠ¡
- âœ¨ æ–°å¢è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
- âœ¨ æ–°å¢å¿«ç…§APIæ¥å£
- ğŸ¨ ä¼˜åŒ–åˆ†æ—¶å›¾å±•ç¤ºç•Œé¢
- ğŸ“š å®Œå–„åŠŸèƒ½æ–‡æ¡£

---

## ğŸ‘¥ å¼€å‘å›¢é˜Ÿ
- **åŠŸèƒ½è®¾è®¡**: yushu
- **åç«¯å¼€å‘**: yushu
- **å‰ç«¯å¼€å‘**: yushu
- **æµ‹è¯•**: yushu

---

**ç‰ˆæœ¬**: v4.22.0  
**æ›´æ–°æ—¶é—´**: 2025-10-21  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0

