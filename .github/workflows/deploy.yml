name: GitHubè‡ªåŠ¨åŒæ­¥åˆ°å®å¡”æœåŠ¡å™¨

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: éƒ¨ç½²åˆ°å®å¡”æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "=== GitHubè‡ªåŠ¨åŒæ­¥éƒ¨ç½²å¼€å§‹ ==="
          echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "æäº¤: ${{ github.sha }}"
          echo "ä»“åº“: ${{ github.repository }}"

          # é…ç½®å˜é‡
          REPO_URL="https://github.com/${{ github.repository }}.git"
          DEPLOY_PATH="/www/wwwroot/stock-tracker"
          CONTAINER_NAME="stock-tracker-app"
          IMAGE_NAME="stock-tracker:latest"

          # åˆ›å»ºæ—¥å¿—ç›®å½•
          mkdir -p ${DEPLOY_PATH}/log
          echo "$(date) - GitHub Actionsè‡ªåŠ¨éƒ¨ç½²å¼€å§‹ - ${{ github.sha }}" >> ${DEPLOY_PATH}/log/deploy.log

          # åœæ­¢æ—§å®¹å™¨
          echo "æ­¥éª¤1: åœæ­¢æ—§å®¹å™¨..."
          docker stop ${CONTAINER_NAME} 2>/dev/null || echo "å®¹å™¨æœªè¿è¡Œ"
          docker rm ${CONTAINER_NAME} 2>/dev/null || echo "å®¹å™¨ä¸å­˜åœ¨"

          # åŒæ­¥GitHubä»£ç 
          echo "æ­¥éª¤2: åŒæ­¥GitHubä»£ç ..."
          if [ -d "${DEPLOY_PATH}/.git" ]; then
            echo "æ›´æ–°ç°æœ‰ä»“åº“..."
            cd ${DEPLOY_PATH}
            git fetch origin
            git reset --hard origin/main
            git pull origin main
          else
            echo "å…‹éš†æ–°ä»“åº“..."
            rm -rf ${DEPLOY_PATH}
            git clone ${REPO_URL} ${DEPLOY_PATH}
          fi

          echo "å½“å‰ç‰ˆæœ¬: $(cd ${DEPLOY_PATH} && git log --oneline -1)"

          # æ„å»ºDockeré•œåƒ
          echo "æ­¥éª¤3: æ„å»ºDockeré•œåƒ..."
          cd ${DEPLOY_PATH}
          docker build -t ${IMAGE_NAME} . 2>&1 | tee log/build-$(date +%Y%m%d_%H%M%S).log

          if [ $? -ne 0 ]; then
            echo "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥" | tee -a log/deploy.log
            exit 1
          fi

          # è®¾ç½®æ•°æ®ç›®å½•æƒé™
          echo "æ­¥éª¤4: è®¾ç½®æ•°æ®ç›®å½•..."
          mkdir -p ${DEPLOY_PATH}/data
          chmod 755 ${DEPLOY_PATH}/data
          chown -R 1001:1001 ${DEPLOY_PATH}/data

          # å¯åŠ¨æ–°å®¹å™¨
          echo "æ­¥éª¤5: å¯åŠ¨æ–°Dockerå®¹å™¨..."
          docker run -d \
            --name ${CONTAINER_NAME} \
            --restart always \
            -p 3000:3000 \
            -v ${DEPLOY_PATH}/data:/app/data \
            -e NODE_ENV=production \
            -e PORT=3000 \
            -e HOSTNAME=0.0.0.0 \
            -e TUSHARE_TOKEN=2876ea85cb005fb5fa17c809a98174f2d5aae8b1f830110a5ead6211 \
            -e NEXT_PUBLIC_API_URL=http://bk.yushuo.click \
            -e NEXT_PUBLIC_API_BASE_URL=http://bk.yushuo.click/api \
            -e NEXTAUTH_SECRET=stock-tracker-secret-key-2024 \
            -e NEXTAUTH_URL=http://bk.yushuo.click \
            ${IMAGE_NAME}

          if [ $? -ne 0 ]; then
            echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥" | tee -a log/deploy.log
            docker logs ${CONTAINER_NAME} | tee -a log/deploy.log
            exit 1
          fi

          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "æ­¥éª¤6: ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 20

          # å¥åº·æ£€æŸ¥
          echo "æ­¥éª¤7: æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          for i in {1..15}; do
            if curl -s -f http://127.0.0.1:3000 >/dev/null 2>&1; then
              echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸï¼"
              break
            fi
            echo "ç­‰å¾…åº”ç”¨å¯åŠ¨... ($i/15)"
            sleep 3
          done

          # æµ‹è¯•APIæ¥å£
          echo "æ­¥éª¤8: æµ‹è¯•APIæ¥å£..."
          curl -I http://127.0.0.1:3000/api/stocks 2>&1 | tee log/api-test-$(date +%Y%m%d_%H%M%S).log

          # é‡è½½Nginx
          echo "æ­¥éª¤9: é‡è½½Nginxé…ç½®..."
          nginx -t && nginx -s reload

          # è®°å½•éƒ¨ç½²å®Œæˆ
          echo "$(date) - GitHub Actionséƒ¨ç½²å®Œæˆ - ${{ github.sha }}" >> ${DEPLOY_PATH}/log/deploy.log

          echo ""
          echo "=== éƒ¨ç½²å®Œæˆ ==="
          echo "ğŸŒ è®¿é—®åœ°å€: http://bk.yushuo.click"
          echo "ğŸ”— APIæµ‹è¯•: http://bk.yushuo.click/api/stocks"
          echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
          docker ps | grep ${CONTAINER_NAME}
          echo ""

    - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
      if: always()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          LOG_FILE="/www/wwwroot/stock-tracker/logs/deploy.log"
          if [ -f "$LOG_FILE" ]; then
            echo "æœ€è¿‘éƒ¨ç½²æ—¥å¿—ï¼š"
            tail -20 $LOG_FILE
          fi

          # æ£€æŸ¥åº”ç”¨çŠ¶æ€
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… åº”ç”¨è¿è¡Œæ­£å¸¸"
          else
            echo "âŒ åº”ç”¨å¯èƒ½å­˜åœ¨é—®é¢˜"
          fi

    - name: åˆ›å»ºéƒ¨ç½²æ ‡ç­¾
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        TAG_NAME="deploy-$(date +%Y%m%d-%H%M%S)"
        git tag $TAG_NAME
        git push origin $TAG_NAME