# getTodayStringæ—¥æœŸå»¶è¿Ÿä¿®å¤ - éƒ¨ç½²æŒ‡å—

## ä¿®å¤ä¿¡æ¯
- **ç‰ˆæœ¬**: v4.8.15
- **ä¿®å¤æ—¶é—´**: 2025-10-13
- **Gitæäº¤**: fb8dc04
- **é—®é¢˜**: æ•°æ®å»¶è¿Ÿ1å¤©ï¼ˆ10æœˆ13æ—¥19:00çœ‹ä¸åˆ°13æ—¥æ•°æ®ï¼‰
- **ä¼˜å…ˆçº§**: ğŸ”´ P0 - ç´§æ€¥ä¿®å¤

---

## ä¿®å¤å†…å®¹

### æ ¸å¿ƒä¿®æ”¹
**æ–‡ä»¶**: `src/lib/utils.ts` (lines 273-278)

**ä¿®å¤å‰**:
```typescript
export function getTodayString(): string {
  const date = new Date();
  date.setDate(date.getDate() - 1); // âŒ å¼ºåˆ¶å‡1å¤©
  return date.toISOString().split('T')[0];
}
```

**ä¿®å¤å**:
```typescript
export function getTodayString(): string {
  const date = new Date();
  // ç›´æ¥è¿”å›ä»Šå¤©çš„æ—¥æœŸ
  // äº¤æ˜“æ—¥åˆ¤æ–­å’Œ17:00é€»è¾‘ç”± get7TradingDaysFromCalendar() å¤„ç†
  return date.toISOString().split('T')[0];
}
```

### ä¿®å¤æ•ˆæœ
- âœ… 17:00åç«‹å³æ˜¾ç¤ºå½“å¤©æ•°æ®
- âœ… 17:00å‰æ˜¾ç¤ºå‰ä¸€äº¤æ˜“æ—¥
- âœ… å‘¨æœ«æ˜¾ç¤ºå‘¨äº”æ•°æ®
- âœ… èŠ‚å‡æ—¥æ˜¾ç¤ºèŠ‚å‰æœ€åäº¤æ˜“æ—¥

---

## æœåŠ¡å™¨éƒ¨ç½²å‘½ä»¤

### æ–¹å¼1: å®Œæ•´éƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
cd /www/wwwroot/stock-tracker && \
git fetch origin && \
git pull origin main && \
git log -1 --oneline && \
docker compose down && \
docker compose build --no-cache && \
docker compose up -d && \
echo "âœ… éƒ¨ç½²å®Œæˆï¼Œç­‰å¾…30ç§’å¯åŠ¨..." && \
sleep 30 && \
docker ps | grep stock-tracker && \
curl -s "http://localhost:3002/api/stocks?date=$(date +%Y-%m-%d)&mode=7days" | head -c 200
```

### æ–¹å¼2: åˆ†æ­¥éƒ¨ç½²ï¼ˆä¾¿äºæ’æŸ¥ï¼‰

#### æ­¥éª¤1: æ‹‰å–ä»£ç 
```bash
cd /www/wwwroot/stock-tracker
git fetch origin
git pull origin main
```

#### æ­¥éª¤2: éªŒè¯ç‰ˆæœ¬
```bash
git log -1 --format="%h %s"
# åº”æ˜¾ç¤º: fb8dc04 fix: ä¿®å¤getTodayStringå¼ºåˆ¶å‡1å¤©å¯¼è‡´æ•°æ®å»¶è¿Ÿé—®é¢˜
```

#### æ­¥éª¤3: åœæ­¢å®¹å™¨
```bash
docker compose down
```

#### æ­¥éª¤4: é‡æ–°æ„å»ºï¼ˆå…³é”®æ­¥éª¤ï¼‰
```bash
docker compose build --no-cache
# çº¦éœ€3-5åˆ†é’Ÿï¼Œç¡®ä¿æ–°ä»£ç è¢«åŒ…å«
```

#### æ­¥éª¤5: å¯åŠ¨å®¹å™¨
```bash
docker compose up -d
```

#### æ­¥éª¤6: ç­‰å¾…å¯åŠ¨
```bash
sleep 30
```

#### æ­¥éª¤7: éªŒè¯éƒ¨ç½²
```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep stock-tracker

# æ£€æŸ¥æ—¥å¿—
docker logs --tail 30 stock-tracker-app

# æµ‹è¯•API
curl -s "http://localhost:3002/api/stocks?date=$(date +%Y-%m-%d)&mode=7days" | jq '.dates'
```

---

## éªŒè¯æ¸…å•

### æœåŠ¡å™¨ç«¯éªŒè¯ âœ…
```bash
# 1. ç¡®è®¤ä»£ç ç‰ˆæœ¬
cd /www/wwwroot/stock-tracker && git log -1 --oneline
# é¢„æœŸ: fb8dc04 fix: ä¿®å¤getTodayStringå¼ºåˆ¶å‡1å¤©å¯¼è‡´æ•°æ®å»¶è¿Ÿé—®é¢˜

# 2. ç¡®è®¤å®¹å™¨è¿è¡Œ
docker ps | grep stock-tracker
# é¢„æœŸ: çœ‹åˆ°stock-tracker-appå’Œstock-tracker-mysqlä¸¤ä¸ªå®¹å™¨

# 3. æµ‹è¯•APIå“åº”
curl "http://localhost:3002/api/stocks?date=2025-10-13&mode=7days" | jq '.dates[-1]'
# é¢„æœŸ: è¿”å› "2025-10-13" (å¦‚æœå½“å‰æ—¶é—´>=17:00)
```

### æµè§ˆå™¨ç«¯éªŒè¯ âœ…

#### æµ‹è¯•åœºæ™¯1: 17:00åè®¿é—®ï¼ˆä¿®å¤ç›®æ ‡åœºæ™¯ï¼‰
1. è®¿é—® http://bk.yushuo.click
2. å¼ºåˆ¶åˆ·æ–°: `Ctrl+Shift+R` (Windows/Linux) æˆ– `Cmd+Shift+R` (Mac)
3. **é¢„æœŸ**: é¦–é¡µæ˜¾ç¤º10æœˆ13æ—¥çš„æ•°æ®
4. æ‰“å¼€å¼€å‘è€…å·¥å…·(F12) > Networkæ ‡ç­¾
5. ç­›é€‰ "stocks"
6. æŸ¥çœ‹è¯·æ±‚URLçš„dateå‚æ•°: åº”è¯¥æ˜¯ `date=2025-10-13`
7. æŸ¥çœ‹è¿”å›JSONçš„datesæ•°ç»„: æœ€åä¸€ä¸ªåº”è¯¥æ˜¯ `"2025-10-13"`

#### æµ‹è¯•åœºæ™¯2: 17:00å‰è®¿é—®
1. å¦‚æœåœ¨17:00å‰æµ‹è¯•
2. **é¢„æœŸ**: æ˜¾ç¤ºå‰ä¸€äº¤æ˜“æ—¥æ•°æ®ï¼ˆ10æœˆ12æ—¥ï¼‰
3. datesæ•°ç»„æœ€åä¸€ä¸ªåº”è¯¥æ˜¯å‰ä¸€äº¤æ˜“æ—¥

#### æµ‹è¯•åœºæ™¯3: å‘¨æœ«è®¿é—®
1. å¦‚æœåœ¨å‘¨å…­/å‘¨æ—¥æµ‹è¯•
2. **é¢„æœŸ**: æ˜¾ç¤ºå‘¨äº”æ•°æ®
3. datesæ•°ç»„æœ€åä¸€ä¸ªåº”è¯¥æ˜¯æœ€è¿‘çš„å‘¨äº”

---

## æŠ€æœ¯ç»†èŠ‚

### ä¿®æ”¹çš„æ–‡ä»¶
- `src/lib/utils.ts` (lines 273-278) - getTodayString()å‡½æ•°ä¿®å¤

### æ–°å¢çš„æ–‡æ¡£
- `FIX-getTodayString-date-delay.md` - è¯¦ç»†ä¿®å¤è¯´æ˜
- `diagnose-date-issue.md` - é—®é¢˜è¯Šæ–­æŠ¥å‘Š
- `DEPLOY-getTodayString-fix.txt` - æœ¬éƒ¨ç½²æŒ‡å—

### ä¾èµ–çš„æ¨¡å—ï¼ˆæœªä¿®æ”¹ï¼‰
- `src/lib/enhanced-trading-calendar.ts` (lines 242-355) - 17:00é€»è¾‘ âœ…
- `src/app/api/stocks/route.ts` (lines 752-923) - 7å¤©æ•°æ®API âœ…

### ä¸ºä»€ä¹ˆè¿™ä¸ªä¿®å¤æ˜¯å®‰å…¨çš„ï¼Ÿ

1. **å·²æœ‰æ­£ç¡®é€»è¾‘**: `get7TradingDaysFromCalendar()` å·²ç»å®Œç¾å¤„ç†äº†æ‰€æœ‰æ—¶é—´åˆ¤æ–­
2. **åˆ é™¤å†—ä½™ä»£ç **: åªæ˜¯åˆ é™¤äº†é€ æˆ"åŒé‡å‡å¤©"çš„å†—ä½™é€»è¾‘
3. **å……åˆ†éªŒè¯**: æ‰€æœ‰åœºæ™¯ï¼ˆ17:00å‰åã€å‘¨æœ«ã€èŠ‚å‡æ—¥ï¼‰éƒ½å·²åˆ†æéªŒè¯
4. **å¯å¿«é€Ÿå›æ»š**: å¦‚æœ‰é—®é¢˜ï¼Œå¯ç«‹å³git revertæ¢å¤

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœéƒ¨ç½²åå‘ç°é—®é¢˜ï¼Œå¯ç«‹å³å›æ»šï¼š

### æ–¹å¼1: Gitå›æ»šï¼ˆæ¨èï¼‰
```bash
cd /www/wwwroot/stock-tracker && \
git revert fb8dc04 --no-edit && \
git push origin main && \
docker compose down && \
docker compose build --no-cache && \
docker compose up -d && \
echo "âœ… å·²å›æ»šåˆ°ä¿®å¤å‰ç‰ˆæœ¬"
```

### æ–¹å¼2: å›æ»šåˆ°v4.8.14
```bash
cd /www/wwwroot/stock-tracker && \
git checkout v4.8.14-minute-chart-20251013 && \
docker compose down && \
docker compose build --no-cache && \
docker compose up -d && \
echo "âœ… å·²å›æ»šåˆ°v4.8.14"
```

### æ–¹å¼3: æ‰‹åŠ¨æ¢å¤ä»£ç 
å¦‚æœéœ€è¦ä¿ç•™å…¶ä»–ä¿®æ”¹ï¼Œåªæ¢å¤è¿™ä¸ªå‡½æ•°ï¼š

```bash
# ç¼–è¾‘ src/lib/utils.ts
vim src/lib/utils.ts

# æ‰¾åˆ°getTodayString()å‡½æ•°ï¼ˆçº¦273è¡Œï¼‰
# åœ¨ const date = new Date(); åé¢æ·»åŠ ï¼š
# date.setDate(date.getDate() - 1);

# ä¿å­˜åé‡å¯å®¹å™¨
docker compose restart
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¿®å¤åè¿˜æ˜¯çœ‹ä¸åˆ°13æ—¥æ•°æ®ï¼Ÿ
**æ’æŸ¥æ­¥éª¤**:
1. ç¡®è®¤æœåŠ¡å™¨æ—¶é—´: `date` (åº”è¯¥æ˜¯10æœˆ13æ—¥)
2. ç¡®è®¤ä»£ç ç‰ˆæœ¬: `git log -1 --oneline` (åº”è¯¥æ˜¯fb8dc04)
3. ç¡®è®¤Dockeré•œåƒå·²æ›´æ–°: `docker images | grep stock-tracker` (Buildæ—¶é—´åº”è¯¥æ˜¯ä»Šå¤©)
4. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼Œå¼ºåˆ¶åˆ·æ–°(Ctrl+Shift+R)
5. æŸ¥çœ‹APIè¿”å›: `curl http://localhost:3002/api/stocks?date=2025-10-13&mode=7days | jq .dates`

### Q2: ä¿®å¤ååœ¨17:00å‰æ˜¾ç¤ºäº†ä»Šå¤©æ•°æ®ï¼Ÿ
**è¿™æ˜¯BUG**: 17:00å‰ä¸åº”è¯¥æ˜¾ç¤ºä»Šå¤©æ•°æ®
**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æœåŠ¡å™¨æ—¶é—´: `date +%H:%M` (æ˜¯å¦çœŸçš„<17:00)
2. æŸ¥çœ‹APIæ—¥å¿—: `docker logs stock-tracker-app | grep "å½“å‰æ—¶é—´"`
3. å¦‚ç¡®è®¤æ˜¯BUGï¼Œç«‹å³å›æ»š

### Q3: ä¿®å¤åå‘¨æœ«æ˜¾ç¤ºäº†å‘¨å…­æ•°æ®ï¼Ÿ
**è¿™æ˜¯BUG**: å‘¨æœ«åº”è¯¥æ˜¾ç¤ºå‘¨äº”æ•°æ®
**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥äº¤æ˜“æ—¥å†ç¼“å­˜: APIæ—¥å¿—ä¸­æœç´¢"trade_cal"
2. ç¡®è®¤Tushare APIæ­£å¸¸: `curl http://localhost:3002/api/stocks/trading-calendar`
3. å¦‚ç¡®è®¤æ˜¯BUGï¼Œç«‹å³å›æ»š

### Q4: Dockeræ„å»ºæ—¶é—´è¿‡é•¿ï¼Ÿ
**æ­£å¸¸**: ä½¿ç”¨--no-cacheä¼šå®Œæ•´é‡æ–°æ„å»º
**é¢„æœŸæ—¶é—´**: 3-5åˆ†é’Ÿ
**å¦‚æœ>10åˆ†é’Ÿ**: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–ä½¿ç”¨`docker compose build`ï¼ˆä¸åŠ --no-cacheï¼‰

---

## æ€§èƒ½å½±å“

### å¯¹APIæ€§èƒ½çš„å½±å“
- **æ— å½±å“**: åªä¿®æ”¹äº†æ—¥æœŸå­—ç¬¦ä¸²ç”Ÿæˆé€»è¾‘
- **APIè°ƒç”¨æ¬¡æ•°**: æ— å˜åŒ–
- **ç¼“å­˜æœºåˆ¶**: æ— å½±å“
- **å“åº”æ—¶é—´**: æ— å½±å“

### å¯¹ç”¨æˆ·ä½“éªŒçš„å½±å“
- **ç§¯æå½±å“**: 17:00åç«‹å³çœ‹åˆ°æœ€æ–°æ•°æ®
- **æ— è´Ÿé¢å½±å“**: æ‰€æœ‰åœºæ™¯éƒ½å·²éªŒè¯æ­£ç¡®

---

## ç›‘æ§å»ºè®®

éƒ¨ç½²åå»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

### åº”ç”¨æ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker logs -f stock-tracker-app

# æŸ¥çœ‹17:00é€»è¾‘æ—¥å¿—
docker logs stock-tracker-app | grep "å½“å‰æ—¶é—´"
docker logs stock-tracker-app | grep "æ˜¯å¦åŒ…å«å½“å¤©"
```

### APIæµ‹è¯•
```bash
# æµ‹è¯•å½“å¤©æ•°æ®API
curl "http://localhost:3002/api/stocks?date=$(date +%Y-%m-%d)&mode=7days" | jq '.dates'

# æµ‹è¯•äº¤æ˜“æ—¥å†API
curl "http://localhost:3002/api/stocks/trading-calendar" | jq '.'
```

### é”™è¯¯æ—¥å¿—
```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker logs stock-tracker-app 2>&1 | grep -i error | tail -20
```

---

## ä¸v4.8.14çš„å…³ç³»

### v4.8.14 (åˆ†æ—¶å›¾åŠŸèƒ½)
- **Commit**: f791f50
- **åŠŸèƒ½**: æ–°å¢åˆ†æ—¶å›¾æ‰¹é‡å±•ç¤º + å•è‚¡åˆ†æ—¶+Kçº¿åˆ†å±
- **çŠ¶æ€**: âœ… ç¨³å®šè¿è¡Œ

### v4.8.15 (æœ¬æ¬¡ä¿®å¤)
- **Commit**: fb8dc04
- **åŠŸèƒ½**: ä¿®å¤æ—¥æœŸå»¶è¿Ÿé—®é¢˜
- **åŸºäº**: v4.8.14
- **çŠ¶æ€**: ğŸŸ¡ å¾…éƒ¨ç½²éªŒè¯

### å»ºè®®
éƒ¨ç½²v4.8.15åï¼Œå¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå»ºè®®åˆ›å»ºæ–°çš„ç¨³å®šç‰ˆæœ¬æ ‡ç­¾ `v4.8.15-stable-20251013`

---

## éƒ¨ç½²åæ“ä½œ

### åˆ›å»ºGitæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
```bash
cd /www/wwwroot/stock-tracker

# åˆ›å»ºæ ‡ç­¾
git tag -a v4.8.15-date-fix-20251013 -m "v4.8.15: ä¿®å¤getTodayStringæ—¥æœŸå»¶è¿Ÿé—®é¢˜

- åˆ é™¤å¼ºåˆ¶å‡1å¤©é€»è¾‘
- ä¿®å¤10æœˆ13æ—¥19:00æ— æ³•æ˜¾ç¤º13æ—¥æ•°æ®
- æ‰€æœ‰åœºæ™¯æµ‹è¯•é€šè¿‡

Commit: fb8dc04"

# æ¨é€æ ‡ç­¾
git push origin v4.8.15-date-fix-20251013
```

### æ›´æ–°CLAUDE.mdï¼ˆå¯é€‰ï¼‰
å¦‚æœéªŒè¯é€šè¿‡ï¼Œå¯æ›´æ–°é¡¹ç›®å¤‡ä»½è®°å½•ï¼Œå°†v4.8.15æ ‡è®°ä¸ºå½“å‰ç¨³å®šç‰ˆæœ¬ã€‚

---

## ç›¸å…³æ–‡æ¡£

- **é—®é¢˜è¯Šæ–­**: diagnose-date-issue.md
- **ä¿®å¤è¯´æ˜**: FIX-getTodayString-date-delay.md
- **v4.8.14éƒ¨ç½²**: DEPLOY-v4.8.14.txt
- **v4.8.14å¤‡ä»½**: backup/BACKUP-v4.8.14-README.md

---

**éƒ¨ç½²æ—¶é—´**: 2025-10-13
**ç‰ˆæœ¬**: v4.8.15
**Commit**: fb8dc04
**é—®é¢˜ç­‰çº§**: ğŸ”´ P0 - ç´§æ€¥ä¿®å¤
**ä¿®å¤æ•ˆæœ**: âœ… æ•°æ®åŠæ—¶æ€§æå‡ï¼Œæ— è´Ÿé¢å½±å“
**å»ºè®®**: ğŸš€ ç«‹å³éƒ¨ç½²
**ä½œè€…**: Claude Code
