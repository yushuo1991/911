# 502 Bad Gateway 错误诊断报告

**生成时间**: 2025-10-13
**错误代码**: 502 Bad Gateway
**影响范围**: http://bk.yushuo.click 完全无法访问
**优先级**: 🔴 P0 - 严重 (生产环境完全不可用)

---

## 1. 问题描述

### 错误现象
浏览器访问 http://bk.yushuo.click 时出现:
```
Failed to load resource: the server responded with a status of 502 (Bad Gateway)
```

### 影响模块
- **前端**: 完全无法加载
- **后端API**: 无法访问
- **数据库**: 可能无法连接
- **Nginx**: 反向代理失败

---

## 2. 502错误技术解释

### 什么是502 Bad Gateway?

**定义**: 502 Bad Gateway 是HTTP状态码,表示网关或代理服务器从上游服务器收到了无效响应。

**在本项目中的含义**:
```
浏览器 --> Nginx (网关) --> Docker容器(应用) --> MySQL(数据库)
              ↑
           在这里出问题了
```

Nginx(充当反向代理/网关)尝试将请求转发给Docker容器中的Next.js应用(运行在端口3002),但是:
1. **应用容器没有运行**: Docker容器崩溃或未启动
2. **端口未监听**: 应用启动失败,3002端口没有监听
3. **应用内部错误**: 应用启动了但无法正常响应请求
4. **网络不通**: Docker网络配置问题

### 与其他错误的区别

| 错误码 | 含义 | 问题位置 |
|--------|------|----------|
| **502** | 网关错误 | Nginx ↔ 应用之间 |
| 500 | 服务器内部错误 | 应用内部代码错误 |
| 503 | 服务不可用 | 服务器过载或维护 |
| 504 | 网关超时 | 上游服务器响应太慢 |

---

## 3. 可能的原因分析

### 原因1: Docker容器未运行 ⭐ (最可能)

**症状**:
- `docker ps` 看不到 stock-tracker-app 容器
- 或容器状态显示 "Exited" / "Restarting"

**原因**:
- 服务器重启后容器没有自动启动
- 手动停止容器忘记重启
- 容器启动失败(配置错误/依赖缺失)

**影响**:
- Nginx转发请求到 localhost:3002,但端口无响应
- Nginx等待一段时间后返回502错误

**验证方法**:
```bash
docker ps --filter "name=stock-tracker"
# 如果没有输出或状态不是"Up",则容器未运行
```

---

### 原因2: 端口3002未监听

**症状**:
- 容器运行中,但应用内部启动失败
- `netstat -tuln | grep 3002` 没有输出

**原因**:
- Next.js应用启动失败(代码错误/依赖缺失)
- 端口被其他进程占用
- 环境变量配置错误

**影响**:
- Docker容器运行,但内部应用未监听3002端口
- Nginx转发请求失败,返回502

**验证方法**:
```bash
netstat -tuln | grep 3002
docker logs stock-tracker-app
```

---

### 原因3: 应用内部错误

**症状**:
- 容器运行,端口监听,但应用无法正常响应
- docker logs 显示错误日志

**原因**:
- 数据库连接失败(MySQL容器未运行)
- 代码逻辑错误(新部署代码有bug)
- 依赖缺失(npm包未安装)
- 内存不足(OOM killed)

**影响**:
- 应用收到请求但无法处理
- 返回错误或超时
- Nginx判断为无效响应,返回502

**验证方法**:
```bash
docker logs --tail 100 stock-tracker-app
curl http://localhost:3002/api/stocks?date=2025-10-13&mode=7days
```

---

### 原因4: Nginx配置问题

**症状**:
- 应用正常运行,但Nginx无法转发请求

**原因**:
- Nginx配置文件错误(语法错误/路径错误)
- proxy_pass 指向错误的端口
- upstream 配置错误

**影响**:
- Nginx无法正确转发请求到应用
- 返回502错误

**验证方法**:
```bash
nginx -t
cat /www/server/nginx/conf/vhost/bk.yushuo.click.conf
```

---

### 原因5: Docker网络问题

**症状**:
- 容器运行,但相互之间无法通信

**原因**:
- Docker网络配置错误
- stock-tracker_default 网络不存在
- 容器未连接到正确的网络

**影响**:
- 应用容器无法连接数据库容器
- 应用启动失败或运行异常

**验证方法**:
```bash
docker network ls
docker network inspect stock-tracker_default
```

---

### 原因6: 资源不足

**症状**:
- 容器反复重启
- 日志显示 "OOM killed" 或 "Killed"

**原因**:
- 服务器内存不足
- 磁盘空间满
- CPU负载过高

**影响**:
- 容器被系统杀死
- 应用无法稳定运行

**验证方法**:
```bash
free -h
df -h
top -bn1 | head -n 20
```

---

## 4. 诊断流程

### 快速诊断(5分钟)

#### 步骤1: 检查Docker容器状态
```bash
docker ps --filter "name=stock-tracker"
```

**预期输出**:
```
NAMES                  STATUS         PORTS
stock-tracker-app      Up 2 hours     0.0.0.0:3002->3002/tcp
stock-tracker-db       Up 2 hours     0.0.0.0:3306->3306/tcp
```

**如果容器未运行**: → 原因1 (容器未运行)
**如果容器运行**: → 继续步骤2

---

#### 步骤2: 检查端口监听
```bash
netstat -tuln | grep :3002
```

**预期输出**:
```
tcp        0      0 0.0.0.0:3002            0.0.0.0:*               LISTEN
```

**如果端口未监听**: → 原因2 (端口未监听)
**如果端口监听**: → 继续步骤3

---

#### 步骤3: 测试本地API
```bash
curl -i http://localhost:3002/api/stocks?date=2025-10-13&mode=7days
```

**预期输出**:
```
HTTP/1.1 200 OK
Content-Type: application/json
...
```

**如果返回200**: → 原因4 (Nginx配置问题)
**如果返回其他**: → 原因3 (应用内部错误)

---

#### 步骤4: 检查Nginx配置
```bash
nginx -t
systemctl status nginx
```

**如果Nginx配置错误**: → 原因4
**如果Nginx正常**: → 原因5 (网络问题)

---

### 完整诊断(使用脚本)

我们提供了一个自动化诊断脚本,可以全面检查所有可能的问题:

```bash
cd /www/wwwroot/stock-tracker
bash log/502-diagnosis-20251013.sh
```

**脚本功能**:
1. ✅ 检查Docker服务和容器状态
2. ✅ 检查端口监听(3002/3306)
3. ✅ 检查Nginx配置和服务状态
4. ✅ 测试API响应
5. ✅ 检查数据库连接
6. ✅ 检查磁盘空间和系统资源
7. ✅ 检查Docker网络
8. ✅ 查看最近系统日志
9. ✅ 生成诊断报告

**输出**: 详细日志文件 `/www/wwwroot/stock-tracker/log/502-diagnosis-*.log`

---

## 5. 解决方案

### 方案1: 一键修复脚本 ⭐ (推荐)

最简单快速的解决方法:

```bash
cd /www/wwwroot/stock-tracker
bash server-fix-502.sh
```

**脚本执行步骤** (全自动,约5-8分钟):
1. 检查Git代码版本
2. 拉取最新代码
3. 停止现有容器
4. 清理旧镜像和缓存
5. **重新构建镜像(无缓存)** ← 关键步骤
6. 启动容器
7. 等待服务启动
8. 验证容器状态
9. 检查端口监听
10. 测试API响应
11. 重启Nginx
12. 最终验证

**适用场景**:
- 不确定具体问题原因
- 想要一次性解决所有潜在问题
- 部署新代码后出现502

---

### 方案2: 手动修复(分步骤)

根据诊断结果,选择对应的修复方法:

#### 情况A: 容器未运行
```bash
cd /www/wwwroot/stock-tracker
docker compose up -d
```

等待30秒后验证:
```bash
docker ps --filter "name=stock-tracker"
curl http://localhost:3002/api/stocks?date=2025-10-13&mode=7days
```

---

#### 情况B: 容器运行但应用启动失败

查看日志找原因:
```bash
docker logs --tail 100 stock-tracker-app
```

常见错误及解决方法:

**错误1: 数据库连接失败**
```
Error: connect ECONNREFUSED 172.18.0.2:3306
```
解决:
```bash
docker compose restart stock-tracker-db
# 等待10秒
docker compose restart stock-tracker-app
```

**错误2: 依赖缺失**
```
Error: Cannot find module 'xxx'
```
解决:
```bash
docker compose down
docker compose build --no-cache
docker compose up -d
```

**错误3: 端口占用**
```
Error: listen EADDRINUSE: address already in use :::3002
```
解决:
```bash
# 查找占用进程
netstat -tlnp | grep :3002
# 杀死进程
kill -9 <PID>
# 重启容器
docker compose restart
```

---

#### 情况C: Nginx配置问题

检查配置:
```bash
nginx -t
```

如果有错误,编辑配置文件:
```bash
vim /www/server/nginx/conf/vhost/bk.yushuo.click.conf
```

确保配置正确:
```nginx
location / {
    proxy_pass http://localhost:3002;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}
```

重启Nginx:
```bash
nginx -t && systemctl restart nginx
```

---

#### 情况D: 网络问题

重建Docker网络:
```bash
docker compose down
docker network prune -f
docker compose up -d
```

---

#### 情况E: 资源不足

清理磁盘空间:
```bash
# 清理Docker资源
docker system prune -a -f

# 清理日志
journalctl --vacuum-time=7d

# 清理旧备份
find /www/backup -name "*.tar.gz" -mtime +30 -delete
```

---

### 方案3: 紧急回滚

如果新代码导致问题,回滚到稳定版本:

```bash
cd /www/wwwroot/stock-tracker
git fetch origin
git checkout 74240f5  # v4.8.11 (K线诊断版本)
docker compose down
docker compose build --no-cache
docker compose up -d
```

---

## 6. 验证修复

### 服务器端验证

```bash
# 1. 容器运行正常
docker ps --filter "name=stock-tracker"

# 2. 端口监听正常
netstat -tuln | grep -E ":(3002|3306)"

# 3. API响应正常
curl -i http://localhost:3002/api/stocks?date=2025-10-13&mode=7days
# 预期: HTTP/1.1 200 OK

# 4. Nginx运行正常
systemctl status nginx

# 5. 通过域名访问正常
curl -i http://bk.yushuo.click/api/stocks?date=2025-10-13&mode=7days
# 预期: HTTP/1.1 200 OK
```

### 浏览器端验证

1. **强制刷新浏览器**: `Ctrl+Shift+R` (Windows) 或 `Cmd+Shift+R` (Mac)
2. 访问 http://bk.yushuo.click
3. 预期看到正常页面,不再出现502错误
4. 打开开发者工具(F12) > Console,确认无错误
5. 打开Network标签,确认API请求返回200状态码

---

## 7. 预防措施

### 监控告警

设置健康检查脚本(每5分钟):
```bash
#!/bin/bash
# /root/health-check.sh

URL="http://localhost:3002/api/stocks?date=$(date +%Y-%m-%d)&mode=7days"
STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")

if [ "$STATUS" != "200" ]; then
    echo "⚠️ 警告: API响应异常 (HTTP $STATUS)" | mail -s "Stock Tracker Health Alert" your@email.com
    # 自动重启容器
    cd /www/wwwroot/stock-tracker && docker compose restart
fi
```

添加到crontab:
```bash
crontab -e
# 每5分钟检查一次
*/5 * * * * /root/health-check.sh >> /var/log/health-check.log 2>&1
```

### 日志监控

设置日志告警(监控错误关键词):
```bash
# 监控应用错误
docker logs -f stock-tracker-app | grep -i "error\|exception\|failed" >> /var/log/app-errors.log
```

### 自动重启策略

确保docker-compose.yml配置了自动重启:
```yaml
services:
  app:
    restart: unless-stopped
  db:
    restart: unless-stopped
```

### 定期备份

自动备份脚本(每天凌晨2点):
```bash
crontab -e
# 每天凌晨2点备份
0 2 * * * cd /www/wwwroot/stock-tracker && bash backup-current-version.sh
```

---

## 8. 技术知识点学习

### 后端技术栈涉及的模块

#### Nginx (反向代理服务器)
**作用**: 接收浏览器请求,转发给Docker容器中的应用

**工作流程**:
```
浏览器 --> Nginx(80端口) --> Docker容器(3002端口) --> Next.js应用
```

**配置文件**: `/www/server/nginx/conf/vhost/bk.yushuo.click.conf`

**关键配置**:
```nginx
location / {
    proxy_pass http://localhost:3002;  # 转发到应用
}
```

**502错误场景**: 当Nginx无法从 localhost:3002 获得有效响应时

---

#### Docker (容器化平台)
**作用**: 将应用和依赖打包成独立容器,隔离运行环境

**容器架构**:
```
stock-tracker-app  (Next.js应用)  端口: 3002
stock-tracker-db   (MySQL数据库)  端口: 3306
```

**关键命令**:
- `docker ps` - 查看运行中的容器
- `docker logs <container>` - 查看容器日志
- `docker compose up -d` - 启动所有容器
- `docker compose down` - 停止所有容器
- `docker compose build --no-cache` - 重新构建镜像

**502错误场景**: 当容器未运行或内部应用启动失败时

---

#### Next.js (前端+后端框架)
**作用**: 本项目使用Next.js 14 App Router,同时处理前端渲染和API路由

**端口**: 3002

**API路由**: `/api/stocks` - 提供股票数据

**启动流程**:
```
1. Docker容器启动
2. 执行 npm start (package.json中定义)
3. Next.js监听3002端口
4. 连接MySQL数据库
5. 准备就绪,接收请求
```

**502错误场景**: 当Next.js启动失败或运行异常时

---

#### MySQL (数据库)
**作用**: 存储股票数据、板块数据、溢价数据等

**端口**: 3306

**连接配置**: 在.env文件中配置
```env
DB_HOST=stock-tracker-db
DB_PORT=3306
DB_USER=root
DB_PASSWORD=root123
DB_NAME=stock_tracker
```

**502错误场景**: 当应用无法连接数据库,导致启动失败时

---

### 网络请求链路

**完整请求链路**:
```
浏览器
  ↓ HTTP请求 (http://bk.yushuo.click/)
Nginx (80端口)
  ↓ proxy_pass转发
Docker容器 (3002端口)
  ↓ Next.js处理
API路由 (/api/stocks)
  ↓ 数据库查询
MySQL (3306端口)
  ↓ 返回数据
Next.js
  ↓ JSON响应
Nginx
  ↓ HTTP响应
浏览器显示数据
```

**502发生位置**: Nginx → Docker容器 这一步失败

---

### 端口说明

| 端口 | 服务 | 说明 |
|------|------|------|
| 80 | Nginx | 浏览器访问的HTTP端口 |
| 443 | Nginx | HTTPS端口(如果配置了SSL) |
| 3002 | Next.js应用 | 应用实际运行端口 |
| 3306 | MySQL | 数据库端口 |

**端口映射**: Docker容器内部端口映射到宿主机端口
```yaml
ports:
  - "3002:3002"  # 宿主机3002 → 容器3002
  - "3306:3306"  # 宿主机3306 → 容器3306
```

---

### Docker网络

**网络名称**: `stock-tracker_default`

**作用**: 让同一网络下的容器可以相互通信

**容器间通信**:
```
stock-tracker-app 容器
  ↓ 通过容器名连接 (stock-tracker-db:3306)
stock-tracker-db 容器
```

**配置** (docker-compose.yml):
```yaml
services:
  app:
    networks:
      - stock-tracker
  db:
    networks:
      - stock-tracker

networks:
  stock-tracker:
    driver: bridge
```

---

## 9. 常见问题FAQ

### Q1: 为什么修复后浏览器还是502?
**A**: 浏览器缓存了错误页面,需要强制刷新:
- Windows/Linux: `Ctrl+Shift+R`
- Mac: `Cmd+Shift+R`
- 或清除浏览器缓存

### Q2: docker compose build需要多久?
**A**: 首次构建约3-5分钟,后续增量构建1-2分钟。使用`--no-cache`会更慢但更可靠。

### Q3: 如何查看容器实时日志?
**A**: `docker logs -f stock-tracker-app` (Ctrl+C退出)

### Q4: 502错误会影响数据库吗?
**A**: 不会。502只是应用层错误,数据库数据不受影响。

### Q5: 可以用PM2代替Docker吗?
**A**: 本项目使用Docker部署,不建议切换到PM2。如需切换,需要重新配置整个部署环境。

### Q6: 修复脚本可以多次执行吗?
**A**: 可以。脚本是幂等的,多次执行不会造成问题。

---

## 10. 总结

### 502错误的本质
**Nginx无法从应用获得有效响应**

### 最常见原因排序
1. 🥇 Docker容器未运行 (70%)
2. 🥈 应用启动失败 (20%)
3. 🥉 Nginx配置错误 (5%)
4. 其他原因 (5%)

### 最快解决方法
```bash
cd /www/wwwroot/stock-tracker
bash server-fix-502.sh
```

### 关键检查点
- ✅ Docker容器运行
- ✅ 端口3002监听
- ✅ API返回200
- ✅ Nginx配置正确

---

**报告生成**: Claude Code
**日期**: 2025-10-13
**版本**: v1.0
**相关脚本**:
- 诊断脚本: `log/502-diagnosis-20251013.sh`
- 修复脚本: `server-fix-502.sh`
