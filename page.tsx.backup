'use client';

import { useState, useEffect, useMemo } from 'react';
import { SevenDaysData, DayData, SectorSummary, StockPerformance } from '@/types/stock';
import { getPerformanceClass, getTodayString, formatDate, formatDateCompact, cleanSectorName } from '@/lib/utils';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { createUnifiedDataProcessor, UnifiedDataProcessor } from '@/lib/unified-data-processor';

// ä¸ªè‚¡ä»£ç æ ¼å¼è½¬æ¢å‡½æ•°
function getStockCodeFormat(stockCode: string): string {
  if (stockCode.startsWith('6')) {
    return `sh${stockCode}`;
  } else {
    return `sz${stockCode}`;
  }
}

export default function Home() {
  const [sevenDaysData, setSevenDaysData] = useState<SevenDaysData | null>(null);
  const [dates, setDates] = useState<string[]>([]);
  const [dataProcessor, setDataProcessor] = useState<UnifiedDataProcessor | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [onlyLimitUp5Plus, setOnlyLimitUp5Plus] = useState(false);
  const [expandedSectors, setExpandedSectors] = useState<Record<string, boolean>>({});
  const [showModal, setShowModal] = useState(false);
  const [selectedStock, setSelectedStock] = useState<{name: string, code: string} | null>(null);
  const [showSectorModal, setShowSectorModal] = useState(false);
  const [selectedSectorData, setSelectedSectorData] = useState<{name: string, date: string, stocks: StockPerformance[], followUpData: Record<string, Record<string, number>>} | null>(null);
  const [showDateModal, setShowDateModal] = useState(false);
  const [selectedDateData, setSelectedDateData] = useState<{date: string, sectorData: { sectorName: string; stocks: any[]; avgPremium: number; }[]} | null>(null);
  const [showSectorRankingModal, setShowSectorRankingModal] = useState(false);
  const [showOnly5PlusInDateModal, setShowOnly5PlusInDateModal] = useState(true);
  const [showWeekdayModal, setShowWeekdayModal] = useState(false);
  const [selectedWeekdayData, setSelectedWeekdayData] = useState<{date: string, sectorData: { sectorName: string; avgPremium: number; stockCount: number; }[], chartData?: { date: string; avgPremium: number; stockCount: number; }[]} | null>(null);
  const [showOnly5PlusInWeekdayModal, setShowOnly5PlusInWeekdayModal] = useState(false);
  const [showStockCountModal, setShowStockCountModal] = useState(false);
  const [selectedStockCountData, setSelectedStockCountData] = useState<{date: string, sectorData: { sectorName: string; stocks: any[]; avgPremium: number; }[]} | null>(null);
  const [showOnly5PlusInStockCountModal, setShowOnly5PlusInStockCountModal] = useState(true);

  // ä¸ƒå¤©æ¿å—è¯¦æƒ…çŠ¶æ€
  const [showSevenDaysSectorModal, setShowSevenDaysSectorModal] = useState(false);
  const [selectedSevenDaysSectorData, setSelectedSevenDaysSectorData] = useState<{
    sectorName: string;
    dailyData: Array<{
      date: string;
      stocks: StockPerformance[];
      count: number;
    }>;
  } | null>(null);

  // å¤šçª—å£çŠ¶æ€ç®¡ç†
  const [stockCountWindows, setStockCountWindows] = useState<Array<{
    id: string;
    date: string;
    sectorData: { sectorName: string; stocks: any[]; avgPremium: number; }[];
    position: { x: number; y: number };
    zIndex: number;
  }>>([]);
  const [draggedWindow, setDraggedWindow] = useState<string | null>(null);
  const [dragOffset, setDragOffset] = useState<{ x: number; y: number }>({ x: 0, y: 0 });
  const [maxZIndex, setMaxZIndex] = useState(1000);

  // ç”Ÿæˆæœ€è¿‘7ä¸ªäº¤æ˜“æ—¥ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼Œä½†ä¸»è¦ä½¿ç”¨åç«¯APIçš„çœŸå®äº¤æ˜“æ—¥å†ï¼‰
  const generate7TradingDays = (endDate: string): string[] => {
    const dates = [];
    const end = new Date(endDate);
    let current = new Date(end);

    while (dates.length < 7) {
      if (current.getDay() !== 0 && current.getDay() !== 6) {
        dates.push(current.toISOString().split('T')[0]);
      }
      current.setDate(current.getDate() - 1);
    }

    return dates.reverse();
  };

  const fetch7DaysData = async () => {
    setLoading(true);
    setError(null);

    try {
      // ä½¿ç”¨å›ºå®šçš„å†å²æ—¥æœŸï¼Œç¡®ä¿æœ‰æ•°æ®
      const endDate = '2025-09-26'; // å›ºå®šä½¿ç”¨æœ‰æ•°æ®çš„å†å²æ—¥æœŸ
      console.log('[å‰ç«¯] è¯·æ±‚7å¤©æ•°æ®ï¼Œç»“æŸæ—¥æœŸ:', endDate);

      const response = await fetch(`/api/stocks?date=${endDate}&mode=7days`);
      const result = await response.json();

      console.log('[å‰ç«¯] APIå“åº”:', result);

      if (result.success) {
        console.log('[å‰ç«¯] æ•°æ®åŠ è½½æˆåŠŸï¼Œæ—¥æœŸæ•°é‡:', result.dates?.length || 0);
        setSevenDaysData(result.data);
        setDates(result.dates || []);
      } else {
        console.error('[å‰ç«¯] APIè¿”å›å¤±è´¥:', result.error);
        setError(result.error || 'è·å–æ•°æ®å¤±è´¥');
      }
    } catch (err) {
      console.error('[å‰ç«¯] ç½‘ç»œè¯·æ±‚å¤±è´¥:', err);
      setError('ç½‘ç»œè¯·æ±‚å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetch7DaysData();
  }, []);

  // åˆ›å»ºç»Ÿä¸€æ•°æ®å¤„ç†å™¨
  useEffect(() => {
    if (sevenDaysData && dates.length > 0) {
      const processor = createUnifiedDataProcessor(sevenDaysData, dates);
      setDataProcessor(processor);
      console.log('[ç»Ÿä¸€å¤„ç†å™¨] æ•°æ®å¤„ç†å™¨å·²åˆ›å»º', { dates: dates.length, cacheStats: processor.getCacheStats() });
    }
  }, [sevenDaysData, dates]);

  // å¤„ç†æ¿å—ç‚¹å‡»æ˜¾ç¤ºå¼¹çª— - ä½¿ç”¨ç»Ÿä¸€æ•°æ®å¤„ç†å™¨
  const handleSectorClick = (date: string, sectorName: string, stocks: StockPerformance[], followUpData: Record<string, Record<string, number>>) => {
    if (!dataProcessor) {
      console.warn('[ç»Ÿä¸€å¤„ç†å™¨] æ•°æ®å¤„ç†å™¨æœªåˆå§‹åŒ–ï¼Œé™çº§åˆ°åŸæœ‰é€»è¾‘');
      handleSectorClickLegacy(date, sectorName, stocks, followUpData);
      return;
    }

    try {
      console.log('[ç»Ÿä¸€å¤„ç†å™¨] å¤„ç†æ¿å—ç‚¹å‡»:', { date, sectorName, stockCount: stocks.length });
      const result = dataProcessor.handleSectorClick(date, sectorName, stocks, followUpData);

      setSelectedWeekdayData({
        date: result.date,
        sectorData: result.sectorData
      });
      setShowWeekdayModal(true);

      console.log('[ç»Ÿä¸€å¤„ç†å™¨] æ¿å—ç‚¹å‡»å¤„ç†å®Œæˆ', {
        resultType: result.type,
        sectorCount: result.sectorData.length,
        cacheStats: dataProcessor.getCacheStats()
      });
    } catch (error) {
      console.error('[ç»Ÿä¸€å¤„ç†å™¨] æ¿å—ç‚¹å‡»å¤„ç†å¤±è´¥:', error);
      handleSectorClickLegacy(date, sectorName, stocks, followUpData);
    }
  };

  // åŸæœ‰çš„æ¿å—ç‚¹å‡»å¤„ç†é€»è¾‘ï¼ˆä¿ç•™ä½œä¸ºé™çº§æ–¹æ¡ˆï¼‰
  const handleSectorClickLegacy = (date: string, sectorName: string, stocks: StockPerformance[], followUpData: Record<string, Record<string, number>>) => {
    const dayData = sevenDaysData?.[date];
    if (!dayData) return;

    // è·å–åç»­5æ—¥æ—¥æœŸ
    const dateIndex = dates.indexOf(date);
    const next5Days = dates.slice(dateIndex + 1, dateIndex + 6);

    // ä¸æ¶¨åœæ•°å¼¹çª—å®Œå…¨ä¸€è‡´çš„æ•°æ®å¤„ç†é€»è¾‘
    const sectorStocks = stocks.map(stock => {
      const stockFollowUpData = dayData.followUpData[sectorName]?.[stock.code] || {};
      const totalReturn = Object.values(stockFollowUpData).reduce((sum, val) => sum + val, 0);

      // æ„å»ºä¸ªè‚¡çš„chartData
      const chartData = next5Days.map(nextDate => {
        const nextDayData = sevenDaysData?.[nextDate];
        if (!nextDayData) return { date: nextDate, value: 0 };

        const nextDayFollowUp = nextDayData.followUpData[sectorName]?.[stock.code] || {};
        const dayValue = Object.values(nextDayFollowUp).reduce((sum, val) => sum + val, 0);
        return {
          date: nextDate,
          value: parseFloat(dayValue.toFixed(2))
        };
      });

      return {
        ...stock,
        followUpData: stockFollowUpData,
        totalReturn: parseFloat(totalReturn.toFixed(2)), // ç¡®ä¿2ä½å°æ•°ç²¾åº¦
        chartData: chartData // æ·»åŠ chartDataå­—æ®µ
      };
    });

    // æ¿å—å†…ä¸ªè‚¡æŒ‰ç´¯è®¡æº¢ä»·æ’åºï¼ˆé™åºï¼‰
    sectorStocks.sort((a, b) => b.totalReturn - a.totalReturn);

    // è®¡ç®—æ¿å—å¹³å‡æº¢ä»·
    const avgPremium = sectorStocks.reduce((total, stock) => total + stock.totalReturn, 0) / sectorStocks.length;

    // æ„å»ºæ¿å—çš„chartData
    const sectorChartData = next5Days.map(nextDate => {
      const nextDayData = sevenDaysData?.[nextDate];
      if (!nextDayData) return { date: nextDate, avgPremium: 0, stockCount: 0 };

      const nextDayStocks = nextDayData.categories[sectorName] || [];
      let totalPremium = 0;
      let validCount = 0;

      nextDayStocks.forEach((nextStock: any) => {
        const nextStockFollowUp = nextDayData.followUpData[sectorName]?.[nextStock.code] || {};
        const stockReturn = Object.values(nextStockFollowUp).reduce((sum, val) => sum + val, 0);
        totalPremium += stockReturn;
        validCount++;
      });

      const dayAvgPremium = validCount > 0 ? totalPremium / validCount : 0;
      return {
        date: nextDate,
        avgPremium: parseFloat(dayAvgPremium.toFixed(2)),
        stockCount: validCount
      };
    });

    // æ„å»ºå•æ¿å—æ•°æ®ç»“æ„ï¼Œä½¿ç”¨ä¸å¤šçª—å£ç›¸åŒçš„æ•°æ®æ ¼å¼
    const sectorData = [{
      sectorName,
      avgPremium: parseFloat(avgPremium.toFixed(2)),
      stockCount: sectorStocks.length,
      stocks: sectorStocks, // ğŸ”§ ä¿®å¤ï¼šæ”¹ä¸º stocks å­—æ®µåä¸å¼¹çª—ç»„ä»¶ä¿æŒä¸€è‡´
      chartData: sectorChartData // æ·»åŠ æ¿å—çš„chartData
    }];

    setSelectedWeekdayData({ date, sectorData });
    setShowWeekdayModal(true);
  };

  // å¤„ç†æ—¥æœŸç‚¹å‡»æ˜¾ç¤ºæ¿å—æº¢ä»·è¡¨æ ¼å’Œå›¾è¡¨ - ä½¿ç”¨ç»Ÿä¸€æ•°æ®å¤„ç†å™¨
  const handleDateClick = (date: string) => {
    if (!dataProcessor) {
      console.warn('[ç»Ÿä¸€å¤„ç†å™¨] æ•°æ®å¤„ç†å™¨æœªåˆå§‹åŒ–ï¼Œé™çº§åˆ°åŸæœ‰é€»è¾‘');
      handleDateClickLegacy(date);
      return;
    }

    try {
      console.log('[ç»Ÿä¸€å¤„ç†å™¨] å¤„ç†æ—¥æœŸç‚¹å‡»:', { date });
      const result = dataProcessor.handleDateClick(date);

      setSelectedWeekdayData({
        date: result.date,
        sectorData: result.sectorData
      });
      setShowWeekdayModal(true);

      console.log('[ç»Ÿä¸€å¤„ç†å™¨] æ—¥æœŸç‚¹å‡»å¤„ç†å®Œæˆ', {
        resultType: result.type,
        sectorCount: result.sectorData.length,
        cacheStats: dataProcessor.getCacheStats()
      });
    } catch (error) {
      console.error('[ç»Ÿä¸€å¤„ç†å™¨] æ—¥æœŸç‚¹å‡»å¤„ç†å¤±è´¥:', error);
      handleDateClickLegacy(date);
    }
  };

  // åŸæœ‰çš„æ—¥æœŸç‚¹å‡»å¤„ç†é€»è¾‘ï¼ˆä¿ç•™ä½œä¸ºé™çº§æ–¹æ¡ˆï¼‰
  const handleDateClickLegacy = (date: string) => {
    const dayData = sevenDaysData?.[date];
    if (!dayData) return;

    // è®¡ç®—å„æ¿å—çš„5å¤©æº¢ä»·æ•°æ®å’Œå›¾è¡¨æ•°æ®
    const sectorData: { sectorName: string; avgPremium: number; stockCount: number; chartData?: { date: string; avgPremium: number; stockCount: number; }[] }[] = [];

    // è·å–åç»­5æ—¥æ—¥æœŸ
    const dateIndex = dates.indexOf(date);
    const next5Days = dates.slice(dateIndex + 1, dateIndex + 6);

    Object.entries(dayData.categories)
      .filter(([sectorName]) => sectorName !== 'å…¶ä»–' && sectorName !== 'STæ¿å—')
      .forEach(([sectorName, stocks]) => {
        let totalPremium = 0;
        let validStockCount = 0;
        const sectorChartData: { date: string; avgPremium: number; stockCount: number; }[] = [];

        // è®¡ç®—å½“å¤©å¹³å‡æº¢ä»·
        stocks.forEach(stock => {
          const followUpData = dayData.followUpData[sectorName]?.[stock.code] || {};
          const stockTotalReturn = Object.values(followUpData).reduce((sum, val) => sum + val, 0);
          totalPremium += stockTotalReturn;
          validStockCount++;
        });

        const avgPremium = validStockCount > 0 ? totalPremium / validStockCount : 0;

        // è®¡ç®—åç»­5æ—¥æ•°æ®
        next5Days.forEach((nextDate, index) => {
          const nextDayData = sevenDaysData?.[nextDate];
          if (nextDayData && nextDayData.categories[sectorName]) {
            const nextDayStocks = nextDayData.categories[sectorName];
            let nextDayTotalPremium = 0;
            let nextDayValidCount = 0;

            nextDayStocks.forEach(stock => {
              const nextDayFollowUpData = nextDayData.followUpData[sectorName]?.[stock.code] || {};
              const nextDayStockReturn = Object.values(nextDayFollowUpData).reduce((sum, val) => sum + val, 0);
              nextDayTotalPremium += nextDayStockReturn;
              nextDayValidCount++;
            });

            const nextDayAvgPremium = nextDayValidCount > 0 ? nextDayTotalPremium / nextDayValidCount : 0;
            sectorChartData.push({
              date: nextDate,
              avgPremium: nextDayAvgPremium,
              stockCount: nextDayValidCount
            });
          }
        });

        sectorData.push({
          sectorName,
          avgPremium,
          stockCount: validStockCount,
          chartData: sectorChartData
        });
      });

    // æŒ‰æ¿å—ç´¯è®¡æº¢ä»·æ’åºï¼ˆå½“æ—¥+åç»­5æ—¥ï¼‰
    sectorData.sort((a, b) => {
      const aCumulative = a.avgPremium + (a.chartData?.slice(0, 5).reduce((sum, d) => sum + d.avgPremium, 0) || 0);
      const bCumulative = b.avgPremium + (b.chartData?.slice(0, 5).reduce((sum, d) => sum + d.avgPremium, 0) || 0);
      return bCumulative - aCumulative;
    });

    setSelectedWeekdayData({ date, sectorData });
    setShowWeekdayModal(true);
  };

  // å¤„ç†æ¶¨åœæ•°ç‚¹å‡»æ˜¾ç¤ºå½“å¤©æ‰€æœ‰ä¸ªè‚¡æŒ‰æ¿å—åˆ†ç»„ï¼ˆå¤šçª—å£æ‹–æ‹½æ¨¡å¼ï¼‰
  const handleStockCountClick = (date: string) => {
    const dayData = sevenDaysData?.[date];
    if (!dayData) return;

    // æŒ‰æ¿å—ç»„ç»‡æ•°æ®ï¼ŒæŒ‰æ¿å—æ¶¨åœæ•°æ’åºï¼Œæ¿å—å†…æŒ‰ç´¯è®¡æº¢ä»·æ’åºï¼Œæ’é™¤"å…¶ä»–"å’Œ"STæ¿å—"
    const sectorData: { sectorName: string; stocks: any[]; avgPremium: number; }[] = [];
    Object.entries(dayData.categories)
      .filter(([sectorName]) => sectorName !== 'å…¶ä»–' && sectorName !== 'STæ¿å—')
      .forEach(([sectorName, stocks]) => {
        // è·å–åç»­5æ—¥æ—¥æœŸ
        const dateIndex = dates.indexOf(date);
        const next5Days = dates.slice(dateIndex + 1, dateIndex + 6);

        const sectorStocks = stocks.map(stock => {
          const followUpData = dayData.followUpData[sectorName]?.[stock.code] || {};
          const totalReturn = Object.values(followUpData).reduce((sum, val) => sum + val, 0);

          // æ„å»ºä¸ªè‚¡çš„chartData
          const chartData = next5Days.map(nextDate => {
            const nextDayData = sevenDaysData?.[nextDate];
            if (!nextDayData) return { date: nextDate, value: 0 };

            const nextDayFollowUp = nextDayData.followUpData[sectorName]?.[stock.code] || {};
            const dayValue = Object.values(nextDayFollowUp).reduce((sum, val) => sum + val, 0);
            return {
              date: nextDate,
              value: parseFloat(dayValue.toFixed(2))
            };
          });

          return {
            ...stock,
            followUpData,
            totalReturn: parseFloat(totalReturn.toFixed(2)), // ç¡®ä¿2ä½å°æ•°ç²¾åº¦
            chartData: chartData // æ·»åŠ chartDataå­—æ®µ
          };
        });

        // æ¿å—å†…ä¸ªè‚¡æŒ‰ç´¯è®¡æº¢ä»·æ’åºï¼ˆé™åºï¼‰
        sectorStocks.sort((a, b) => b.totalReturn - a.totalReturn);

        // è®¡ç®—æ¿å—å¹³å‡æº¢ä»·
        const avgPremium = sectorStocks.reduce((total, stock) => total + stock.totalReturn, 0) / sectorStocks.length;

        sectorData.push({
          sectorName,
          stocks: sectorStocks,
          avgPremium: parseFloat(avgPremium.toFixed(2)) // ç¡®ä¿2ä½å°æ•°ç²¾åº¦
        });
      });

    // æŒ‰æ¿å—æ¶¨åœæ•°æ’åºï¼ˆé™åºï¼‰
    sectorData.sort((a, b) => b.stocks.length - a.stocks.length);

    // åˆ›å»ºæ–°çš„å¤šçª—å£
    const windowId = `window_${date}_${Date.now()}`;
    const newZIndex = maxZIndex + 1;

    // è®¡ç®—çª—å£ä½ç½®ï¼ˆéšæœºåç§»é¿å…é‡å ï¼‰
    const offsetX = Math.random() * 100;
    const offsetY = Math.random() * 100;

    const newWindow = {
      id: windowId,
      date,
      sectorData,
      position: { x: 100 + offsetX, y: 50 + offsetY },
      zIndex: newZIndex
    };

    setStockCountWindows(prev => [...prev, newWindow]);
    setMaxZIndex(newZIndex);
  };

  // æ‹–æ‹½å¤„ç†å‡½æ•°
  const handleMouseDown = (e: React.MouseEvent, windowId: string) => {
    const window = stockCountWindows.find(w => w.id === windowId);
    if (!window) return;

    // å°†å½“å‰çª—å£ç½®é¡¶
    const newZIndex = maxZIndex + 1;
    setStockCountWindows(prev => prev.map(w =>
      w.id === windowId ? { ...w, zIndex: newZIndex } : w
    ));
    setMaxZIndex(newZIndex);

    // è®°å½•æ‹–æ‹½èµ·å§‹ä½ç½®
    const startX = e.clientX;
    const startY = e.clientY;
    const startPosX = window.position.x;
    const startPosY = window.position.y;

    setDraggedWindow(windowId);
    setDragOffset({ x: startX - startPosX, y: startY - startPosY });

    const handleMouseMove = (e: MouseEvent) => {
      const newX = e.clientX - (startX - startPosX);
      const newY = e.clientY - (startY - startPosY);

      setStockCountWindows(prev => prev.map(w =>
        w.id === windowId ? { ...w, position: { x: newX, y: newY } } : w
      ));
    };

    const handleMouseUp = () => {
      setDraggedWindow(null);
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
  };

  // å…³é—­çª—å£
  const closeWindow = (windowId: string) => {
    setStockCountWindows(prev => prev.filter(w => w.id !== windowId));
  };

  // å¤„ç†æ˜ŸæœŸå‡ ç‚¹å‡»æ˜¾ç¤ºæ¿å—å¹³å‡æº¢ä»·è¡¨æ ¼å’Œå›¾è¡¨
  const handleWeekdayClick = (date: string) => {
    const dayData = sevenDaysData?.[date];
    if (!dayData) return;

    // è®¡ç®—å„æ¿å—çš„å¹³å‡æº¢ä»·æ•°æ®
    const sectorData: { sectorName: string; avgPremium: number; stockCount: number; }[] = [];
    Object.entries(dayData.categories).forEach(([sectorName, stocks]) => {
      let totalPremium = 0;
      let validStockCount = 0;

      stocks.forEach(stock => {
        const followUpData = dayData.followUpData[sectorName]?.[stock.code] || {};
        const stockTotalReturn = Object.values(followUpData).reduce((sum, val) => sum + val, 0);
        totalPremium += stockTotalReturn;
        validStockCount++;
      });

      const avgPremium = validStockCount > 0 ? totalPremium / validStockCount : 0;
      sectorData.push({
        sectorName,
        avgPremium,
        stockCount: validStockCount
      });
    });

    // æŒ‰å¹³å‡æº¢ä»·æ’åº
    sectorData.sort((a, b) => b.avgPremium - a.avgPremium);

    setSelectedWeekdayData({ date, sectorData });
    setShowWeekdayModal(true);
  };

  // å¤„ç†è‚¡ç¥¨åç§°ç‚¹å‡» - æ˜¾ç¤ºKçº¿å›¾
  const handleStockClick = (stockName: string, stockCode: string) => {
    // ç›´æ¥æ˜¾ç¤ºKçº¿å›¾å¼¹çª—
    setSelectedStock({ name: stockName, code: stockCode });
    setShowModal(true);
  };

  // å…³é—­å¼¹çª—
  const closeModal = () => {
    setShowModal(false);
    setSelectedStock(null);
  };

  const closeSectorModal = () => {
    setShowSectorModal(false);
    setSelectedSectorData(null);
  };

  const closeDateModal = () => {
    setShowDateModal(false);
    setSelectedDateData(null);
  };

  const closeSectorRankingModal = () => {
    setShowSectorRankingModal(false);
  };

  const closeWeekdayModal = () => {
    setShowWeekdayModal(false);
    setSelectedWeekdayData(null);
  };

  const closeStockCountModal = () => {
    setShowStockCountModal(false);
    setSelectedStockCountData(null);
  };

  // ä¸ƒå¤©æ¿å—è¯¦æƒ…å¤„ç†å‡½æ•°
  const handleSevenDaysSectorClick = (sectorName: string) => {
    if (!sevenDaysData || !dates) return;

    const dailyData: Array<{
      date: string;
      stocks: StockPerformance[];
      count: number;
    }> = [];

    // æ”¶é›†è¯¥æ¿å—7å¤©çš„æ•°æ®
    dates.forEach(date => {
      const dayData = sevenDaysData[date];
      if (dayData && dayData.categories[sectorName]) {
        dailyData.push({
          date,
          stocks: dayData.categories[sectorName],
          count: dayData.categories[sectorName].length
        });
      }
    });

    if (dailyData.length > 0) {
      setSelectedSevenDaysSectorData({
        sectorName,
        dailyData
      });
      setShowSevenDaysSectorModal(true);
    }
  };

  const closeSevenDaysSectorModal = () => {
    setShowSevenDaysSectorModal(false);
    setSelectedSevenDaysSectorData(null);
  };

  // å¤„ç†7å¤©æ•°æ®ï¼ŒæŒ‰æ—¥æœŸç”Ÿæˆæ¿å—æ±‡æ€»
  const processedTimelineData = useMemo(() => {
    if (!sevenDaysData || !dates) return {};

    const result: Record<string, SectorSummary[]> = {};

    dates.forEach(date => {
      const dayData = sevenDaysData[date];
      if (!dayData) {
        result[date] = [];
        return;
      }

      // è½¬æ¢ä¸ºæ¿å—æ±‡æ€»æ ¼å¼
      const sectors: SectorSummary[] = Object.entries(dayData.categories).map(([sectorName, stocks]) => {
        // ç¡®ä¿ followUpData ç»“æ„æ­£ç¡®
        const sectorFollowUpData = dayData.followUpData[sectorName] || {};
        return {
          name: sectorName,
          count: stocks.length,
          stocks: stocks,
          followUpData: sectorFollowUpData
        };
      });

      // æŒ‰æ¶¨åœæ•°é‡æ’åº
      sectors.sort((a, b) => b.count - a.count);

      // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤ï¼Œé»˜è®¤æ’é™¤"å…¶ä»–"å’Œ"STæ¿å—"
      const filteredSectors = sectors
        .filter(sector => sector.name !== 'å…¶ä»–' && sector.name !== 'STæ¿å—')
        .filter(sector => onlyLimitUp5Plus ? sector.count >= 5 : true);

      result[date] = filteredSectors;
    });

    return result;
  }, [sevenDaysData, dates, onlyLimitUp5Plus]);

  // è·å–å±•å¼€çš„è‚¡ç¥¨æ•°æ®ï¼ˆæŒ‰åç»­5æ—¥ç´¯è®¡æ”¶ç›Šæ’åºï¼‰
  const getSortedStocksForSector = (stocks: StockPerformance[], followUpData: Record<string, Record<string, number>>) => {
    return [...stocks].sort((a, b) => {
      const aFollowUp = followUpData[a.code] || {};
      const bFollowUp = followUpData[b.code] || {};
      const aTotalReturn = Object.values(aFollowUp).reduce((sum, val) => sum + val, 0);
      const bTotalReturn = Object.values(bFollowUp).reduce((sum, val) => sum + val, 0);
      return bTotalReturn - aTotalReturn; // é™åºæ’åˆ—
    });
  };

  // è®¡ç®—æ¿å—æœ€è¿‘7å¤©æ¶¨åœå®¶æ•°æ’åºï¼ˆå‰5åï¼‰
  const getSectorStrengthRanking = useMemo(() => {
    if (!sevenDaysData || !dates) return [];

    // ä½¿ç”¨å…¨éƒ¨7å¤©æ•°æ®è¿›è¡Œç»Ÿè®¡
    const recentDays = dates;

    if (recentDays.length === 0) return [];

    const sectorCountMap: Record<string, { name: string; totalLimitUpCount: number; dailyBreakdown: { date: string; count: number }[] }> = {};

    // ç»Ÿè®¡æœ€è¿‘7å¤©æ¯ä¸ªæ¿å—çš„æ¶¨åœå®¶æ•°ï¼Œæ’é™¤"å…¶ä»–"å’Œ"STæ¿å—"
    recentDays.forEach(date => {
      const dayData = sevenDaysData[date];
      if (!dayData) return;

      Object.entries(dayData.categories).forEach(([sectorName, stocks]) => {
        // æ’é™¤"å…¶ä»–"æ¿å—å’Œ"STæ¿å—"
        if (sectorName === 'å…¶ä»–' || sectorName === 'STæ¿å—') {
          return;
        }

        if (!sectorCountMap[sectorName]) {
          sectorCountMap[sectorName] = {
            name: sectorName,
            totalLimitUpCount: 0,
            dailyBreakdown: []
          };
        }

        const dayLimitUpCount = stocks.length;
        sectorCountMap[sectorName].totalLimitUpCount += dayLimitUpCount;
        sectorCountMap[sectorName].dailyBreakdown.push({
          date,
          count: dayLimitUpCount
        });
      });
    });

    // æŒ‰æ€»æ¶¨åœå®¶æ•°æ’åºï¼Œå–å‰5å
    const rankedSectors = Object.values(sectorCountMap)
      .sort((a, b) => b.totalLimitUpCount - a.totalLimitUpCount)
      .slice(0, 5);

    return rankedSectors;
  }, [sevenDaysData, dates]);

  if (loading) {
    return (
      <div className="min-h-screen bg-finance-bg-primary flex items-center justify-center">
        <div className="text-center">
          <div className="finance-spinner w-12 h-12 mx-auto mb-6"></div>
          <h3 className="text-lg font-semibold text-finance-text-primary mb-2">æ­£åœ¨è·å–7å¤©æ•°æ®</h3>
          <p className="text-sm text-finance-text-secondary">ä¸“ä¸šæ•°æ®å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-finance-bg-primary p-3 sm:p-4 lg:p-6">
      {/* æ¿å—ä¸ªè‚¡æ¢¯é˜Ÿå¼¹çª— */}
      {showSectorModal && selectedSectorData && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999]">
          <div className="bg-white rounded-xl p-6 max-w-4xl max-h-[90vh] overflow-auto shadow-2xl">
            <div className="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
              <h3 className="text-xl font-bold text-gray-900">
                ğŸ“Š {selectedSectorData.name} - ä¸ªè‚¡æ¢¯é˜Ÿè¯¦æƒ… ({formatDateCompact(selectedSectorData.date)})
              </h3>
              <button
                onClick={closeSectorModal}
                className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500 hover:text-red-500 transition-colors"
              >
                âœ•
              </button>
            </div>

            <div className="mb-4 text-sm text-gray-600">
              å…± {selectedSectorData.stocks.length} åªä¸ªè‚¡ï¼ŒæŒ‰5æ—¥ç´¯è®¡æº¢ä»·æ’åº
            </div>

            <div className="space-y-3 max-h-96 overflow-y-auto">
              {getSortedStocksForSector(selectedSectorData.stocks, selectedSectorData.followUpData).map((stock, index) => {
                // ä½¿ç”¨ä¸å¤šçª—å£ä¸€è‡´çš„æ—¥æœŸç”Ÿæˆé€»è¾‘
                const dateIndex = dates.indexOf(selectedSectorData.date);
                const followUpDates = dates.slice(dateIndex + 1, dateIndex + 6);
                const totalReturn = Object.values(selectedSectorData.followUpData[stock.code] || {}).reduce((sum, val) => sum + val, 0);
                return (
                  <div key={stock.code} className="bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-xs text-gray-400 font-mono w-8">#{index + 1}</span>
                          <h5
                            className="font-medium text-blue-600 hover:text-blue-800 cursor-pointer hover:underline"
                            onClick={() => handleStockClick(stock.name, stock.code)}
                          >
                            {stock.name} ({stock.code})
                          </h5>
                        </div>
                        <div className="flex items-center gap-2 text-xs text-gray-500 ml-10">
                          <span>{stock.td_type}</span>
                        </div>
                      </div>
                      <div className={`px-3 py-1 rounded-full text-sm font-medium ${
                        getPerformanceClass(totalReturn)
                      }`}>
                        ç´¯è®¡: {totalReturn.toFixed(2)}%
                      </div>
                    </div>

                    {/* T+1åˆ°T+5è¡¨ç°ç½‘æ ¼ */}
                    <div className="grid grid-cols-5 gap-2 ml-10">
                      {followUpDates.slice(0, 5).map((followDate, dayIndex) => {
                        const performance = selectedSectorData.followUpData[stock.code]?.[followDate] || 0;

                        // ä½¿ç”¨ç»Ÿä¸€çš„æ—¥æœŸæ ¼å¼åŒ–
                        const formattedDate = formatDateCompact(followDate) || `æ—¥æœŸ${dayIndex + 1}`;

                        return (
                          <div key={followDate || `day-${dayIndex}`} className="text-center bg-gray-50 rounded p-2">
                            <div className="text-xs text-gray-400 mb-1">{formattedDate}</div>
                            <div className="text-xs text-gray-400 mb-1">{formattedDate}</div>
                            <div className={getPerformanceClass(performance)}>
                              {performance.toFixed(2)}%
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* æ—¥æœŸæ¿å—æº¢ä»·åˆ†æå¼¹çª— - å·¦å³åˆ†å±å¸ƒå±€ */}
      {showWeekdayModal && selectedWeekdayData && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999]">
          <div className="bg-white rounded-xl p-4 max-w-[95vw] max-h-[90vh] overflow-hidden shadow-2xl">
            <div className="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
              <h3 className="text-xl font-bold text-gray-900">
                ğŸ“ˆ {(() => {
                  try {
                    const formattedDate = formatDate(selectedWeekdayData.date);
                    const weekday = new Date(selectedWeekdayData.date).toLocaleDateString('zh-CN', { weekday: 'long' });
                    return `${formattedDate} ${weekday}`;
                  } catch (error) {
                    console.warn('[æ—¥æœŸå¼¹çª—] æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥:', selectedWeekdayData.date, error);
                    return selectedWeekdayData.date;
                  }
                })()} - æ¿å—5æ—¥æº¢ä»·åˆ†æ
              </h3>
              <button
                onClick={closeWeekdayModal}
                className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500 hover:text-red-500 transition-colors"
              >
                âœ•
              </button>
            </div>

            {/* ç­›é€‰æŒ‰é’® */}
            <div className="mb-4 flex justify-between items-center">
              <div className="text-sm text-gray-600">
                {selectedWeekdayData.sectorData.length === 1
                  ? `å•ä¸ªæ¿å—ï¼š${cleanSectorName(selectedWeekdayData.sectorData[0].sectorName)}`
                  : `å…± ${selectedWeekdayData.sectorData
                      .filter(sector => showOnly5PlusInWeekdayModal ? sector.stockCount >= 5 : true)
                      .length} ä¸ªæ´»è·ƒæ¿å—`
                }
              </div>
              <button
                onClick={() => setShowOnly5PlusInWeekdayModal(!showOnly5PlusInWeekdayModal)}
                className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
                  showOnly5PlusInWeekdayModal
                    ? 'bg-blue-100 text-blue-700 border border-blue-300'
                    : 'bg-gray-100 text-gray-700 border border-gray-300'
                }`}
              >
                {selectedWeekdayData.sectorData.length === 1
                  ? (showOnly5PlusInWeekdayModal ? 'æ˜¾ç¤ºå…¨éƒ¨ä¸ªè‚¡' : 'åªæ˜¾ç¤ºæ¶¨å¹…å¤§äº10ä¸ªè‚¡')
                  : (showOnly5PlusInWeekdayModal ? 'åªæ˜¾ç¤ºâ‰¥5å®¶æ¿å—' : 'æ˜¾ç¤ºå…¨éƒ¨æ¿å—')
                }
              </button>
            </div>

            {/* å·¦å³åˆ†å±å¸ƒå±€ */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[70vh]">
              {/* å·¦ä¾§ï¼šæ¿å—5æ—¥æº¢ä»·æ•°æ®è¡¨ */}
              <div className="bg-gray-50 rounded-lg p-4 overflow-hidden flex flex-col">
                <h4 className="text-lg font-semibold mb-4 text-gray-800">
                  {selectedWeekdayData.sectorData.length === 1
                    ? `ğŸ“‹ ${cleanSectorName(selectedWeekdayData.sectorData[0].sectorName)}ä¸ªè‚¡5æ—¥æº¢ä»·æ•°æ®è¡¨`
                    : 'ğŸ“‹ æ¿å—5æ—¥æº¢ä»·æ•°æ®è¡¨'
                  }
                </h4>
                <div className="flex-1 overflow-auto">
                  <table className="w-full bg-white rounded-lg shadow-sm text-sm">
                    <thead className="bg-gray-100 sticky top-0">
                      <tr>
                        <th className="px-2 py-1 text-left font-semibold text-gray-700 text-xs">
                          {selectedWeekdayData.sectorData.length === 1 ? 'ä¸ªè‚¡åç§°' : 'æ¿å—åç§°'}
                        </th>
                        <th className="px-1 py-1 text-center font-semibold text-gray-700 text-xs">
                          {selectedWeekdayData.sectorData.length === 1 ? 'è¿æ¿å¤©æ•°' : 'å½“æ—¥'}
                          {selectedWeekdayData.sectorData.length === 1 && (
                            <div className="text-[10px] text-gray-500 font-normal mt-0.5">
                              {selectedWeekdayData.sectorData[0].avgPremium.toFixed(1)}%
                            </div>
                          )}
                        </th>
                        {(() => {
                          // ä½¿ç”¨ä¸å¤šçª—å£ä¸€è‡´çš„æ—¥æœŸç”Ÿæˆé€»è¾‘
                          const dateIndex = dates.indexOf(selectedWeekdayData.date);
                          const followUpDates = dates.slice(dateIndex + 1, dateIndex + 6);
                          return followUpDates.map((date: string, index: number) => {
                            const formattedDate = formatDateCompact(date) || `${index + 1}`;

                            // è·å–å½“æ—¥å¹³å‡æº¢ä»·ï¼ˆå•æ¿å—æ¨¡å¼ï¼‰
                            const dayAvgPremium = selectedWeekdayData.sectorData.length === 1 && (selectedWeekdayData.sectorData[0] as any).chartData
                              ? (selectedWeekdayData.sectorData[0] as any).chartData.find((d: any) => d.date === date)?.avgPremium || 0
                              : 0;

                            return (
                              <th key={date} className="px-1 py-1 text-center font-semibold text-gray-700 text-xs">
                                <div>{formatDateCompact(date)}</div>
                                {selectedWeekdayData.sectorData.length === 1 && (
                                  <div className="text-[10px] text-gray-500 font-normal mt-0.5">
                                    {dayAvgPremium.toFixed(1)}%
                                  </div>
                                )}
                              </th>
                            );
                          });
                        })()}
                        <th className="px-2 py-1 text-center font-semibold text-gray-700 text-xs">ç´¯è®¡</th>
                      </tr>
                    </thead>
                    <tbody>
                      {selectedWeekdayData.sectorData.length === 1
                        ? (() => {
                            // å•æ¿å—æ¨¡å¼ï¼šæ˜¾ç¤ºä¸ªè‚¡æ•°æ®
                            const sector = selectedWeekdayData.sectorData[0];
                            const stocksData = (sector as any).stocks || [];  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„ stocks å­—æ®µ
                            // å•æ¿å—æ¨¡å¼ï¼šé»˜è®¤æ˜¾ç¤ºå…¨éƒ¨ä¸ªè‚¡ï¼ŒæŒ‰é’®åˆ‡æ¢ä¸º"åªæ˜¾ç¤ºæ¶¨å¹…å¤§äº10ä¸ªè‚¡"
                            const filteredStocks = stocksData.filter((stock: any) =>
                              showOnly5PlusInWeekdayModal ? stock.totalReturn > 10 : true
                            );

                            return filteredStocks.map((stock: any, index: number) => {
                              const chartData = stock.chartData || [];
                              return (
                                <tr key={stock.code} className={`border-t ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-blue-50`}>
                                  <td className="px-2 py-1 font-medium text-gray-900">
                                    <div className="flex items-center gap-1">
                                      <span className={`w-4 h-4 rounded-full text-[10px] flex items-center justify-center font-bold ${
                                        index < 3 ? 'bg-gradient-to-r from-yellow-400 to-yellow-500 text-white' : 'bg-gray-200 text-gray-600'
                                      }`}>
                                        {index + 1}
                                      </span>
                                      <span
                                        className="truncate max-w-[80px] cursor-pointer hover:text-blue-600 hover:underline text-xs"
                                        title={`${stock.name} (${stock.code})`}
                                        onClick={() => handleStockClick(stock.name, stock.code)}
                                      >
                                        {stock.name}
                                      </span>
                                    </div>
                                  </td>
                                  <td className="px-1 py-1 text-center">
                                    {selectedWeekdayData.sectorData.length === 1 ? (
                                      // å•æ¿å—æ¨¡å¼ï¼šæ˜¾ç¤ºè¿æ¿å¤©æ•°
                                      <div className="px-1 py-0.5 rounded text-[10px] font-medium bg-blue-100 text-blue-800">
                                        {stock.td_type || '1'}æ¿
                                      </div>
                                    ) : (
                                      // å¤šæ¿å—æ¨¡å¼ï¼šæ˜¾ç¤ºæº¢ä»·
                                      <div className={`px-1 py-0.5 rounded text-[10px] font-medium ${getPerformanceClass(stock.totalReturn)}`}>
                                        {stock.totalReturn.toFixed(1)}%
                                      </div>
                                    )}
                                  </td>
                                  {chartData.slice(0, 5).map((dayData: any, dayIndex: number) => (
                                    <td key={dayData.date || dayIndex} className="px-1 py-1 text-center">
                                      <div className={`px-1 py-0.5 rounded text-[10px] font-medium ${getPerformanceClass(dayData.value)}`}>
                                        {dayData.value.toFixed(1)}%
                                      </div>
                                    </td>
                                  ))}
                                  {/* è¡¥é½ç©ºç™½åˆ— */}
                                  {Array.from({ length: Math.max(0, 5 - chartData.length) }, (_, i) => (
                                    <td key={`empty-${i}`} className="px-1 py-1 text-center">
                                      <div className="px-1 py-0.5 rounded text-[10px] bg-gray-100 text-gray-400">
                                        --
                                      </div>
                                    </td>
                                  ))}
                                  <td className="px-2 py-1 text-center">
                                    <div className={`px-1 py-0.5 rounded text-[10px] font-bold ${getPerformanceClass(
                                      stock.totalReturn
                                    )}`}>
                                      {stock.totalReturn.toFixed(1)}%
                                    </div>
                                  </td>
                                </tr>
                              );
                            });
                          })()
                        : selectedWeekdayData.sectorData
                            .filter(sector => showOnly5PlusInWeekdayModal ? sector.stockCount >= 5 : true)
                            .map((sector, index) => {
                              const chartData = (sector as any).chartData || [];
                              return (
                                <tr key={sector.sectorName} className={`border-t ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-blue-50`}>
                                  <td className="px-3 py-2 font-medium text-gray-900">
                                    <div className="flex items-center gap-2">
                                      <span className={`w-6 h-6 rounded-full text-xs flex items-center justify-center font-bold ${
                                        index < 3 ? 'bg-gradient-to-r from-yellow-400 to-yellow-500 text-white' : 'bg-gray-200 text-gray-600'
                                      }`}>
                                        {index + 1}
                                      </span>
                                      <span className="truncate max-w-[120px]" title={cleanSectorName(sector.sectorName)}>
                                        {cleanSectorName(sector.sectorName)}
                                      </span>
                                    </div>
                                  </td>
                                  <td className="px-2 py-2 text-center">
                                    <div className={getPerformanceClass(sector.avgPremium)}>
                                      {sector.avgPremium.toFixed(2)}%
                                    </div>
                                  </td>
                                  {chartData.slice(0, 5).map((dayData: any, dayIndex: number) => (
                                    <td key={dayData.date || dayIndex} className="px-2 py-2 text-center">
                                      <div className={getPerformanceClass(dayData.avgPremium)}>
                                        {dayData.avgPremium.toFixed(2)}%
                                      </div>
                                    </td>
                                  ))}
                                  {/* è¡¥é½ç©ºç™½åˆ— */}
                                  {Array.from({ length: Math.max(0, 5 - chartData.length) }, (_, i) => (
                                    <td key={`empty-${i}`} className="px-2 py-2 text-center">
                                      <div className="px-2 py-1 rounded text-xs bg-gray-100 text-gray-400">
                                        --
                                      </div>
                                    </td>
                                  ))}
                                  <td className="px-3 py-2 text-center">
                                    <div className={`font-bold ${getPerformanceClass(
                                      sector.avgPremium + chartData.slice(0, 5).reduce((sum: number, d: any) => sum + d.avgPremium, 0)
                                    )}`}>
                                      {(sector.avgPremium + chartData.slice(0, 5).reduce((sum: number, d: any) => sum + d.avgPremium, 0)).toFixed(2)}%
                                    </div>
                                  </td>
                                </tr>
                              );
                            })
                      }
                    </tbody>
                  </table>
                </div>
              </div>

              {/* å³ä¾§ï¼šæ¿å—/ä¸ªè‚¡æº¢ä»·è¶‹åŠ¿å›¾ */}
              <div className="bg-gray-50 rounded-lg p-4 overflow-hidden flex flex-col">
                <h4 className="text-lg font-semibold mb-4 text-gray-800">
                  {selectedWeekdayData.sectorData.length === 1
                    ? `ğŸ“ˆ ${cleanSectorName(selectedWeekdayData.sectorData[0].sectorName)}ä¸ªè‚¡æº¢ä»·è¶‹åŠ¿å›¾`
                    : 'ğŸ“Š æ¿å—æº¢ä»·è¶‹åŠ¿å¯¹æ¯”å›¾'
                  }
                </h4>
                <div className="flex-1">
                  <div style={{ width: '100%', height: '100%' }}>
                    <ResponsiveContainer>
                      <LineChart
                        data={(() => {
                          if (selectedWeekdayData.sectorData.length === 1) {
                            // å•æ¿å—æ¨¡å¼ï¼šæ˜¾ç¤ºä¸ªè‚¡å›¾è¡¨
                            const sector = selectedWeekdayData.sectorData[0];
                            const stocksData = (sector as any).stocks || [];  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„ stocks å­—æ®µ

                            // ç­›é€‰æ¡ä»¶ï¼šæ ¹æ®æŒ‰é’®çŠ¶æ€ç­›é€‰ä¸ªè‚¡
                            const filteredStocks = stocksData.filter((stock: any) =>
                              showOnly5PlusInWeekdayModal ? stock.totalReturn > 10 : true
                            ).slice(0, 10); // æœ€å¤šæ˜¾ç¤º10åªè‚¡ç¥¨

                            if (filteredStocks.length === 0) return [];

                            // æ‰¾åˆ°æ‰€æœ‰æ—¥æœŸ
                            const allDates = new Set<string>();
                            filteredStocks.forEach((stock: any) => {
                              if (stock.chartData) {
                                stock.chartData.forEach((d: any) => allDates.add(d.date));
                              }
                            });

                            const sortedDates = Array.from(allDates).sort();

                            // æ„å»ºä¸ªè‚¡å›¾è¡¨æ•°æ®
                            const chartData = [
                              // å½“æ—¥æ•°æ®ç‚¹
                              {
                                label: formatDateCompact(selectedWeekdayData.date) || 'å½“æ—¥',
                                date: selectedWeekdayData.date,
                                ...Object.fromEntries(
                                  filteredStocks.map((stock: any) => [
                                    stock.name.length > 4 ? stock.name.slice(0, 4) : stock.name,
                                    stock.totalReturn
                                  ])
                                )
                              },
                              // åç»­æ—¥æœŸæ•°æ®ç‚¹
                              ...sortedDates.slice(0, 5).map((date, index) => ({
                                label: formatDateCompact(date) || `æ—¥${index + 1}`,
                                date: date,
                                ...Object.fromEntries(
                                  filteredStocks.map((stock: any) => {
                                    const dayData = stock.chartData?.find((d: any) => d.date === date);
                                    return [stock.name.length > 4 ? stock.name.slice(0, 4) : stock.name, dayData?.value || 0];
                                  })
                                )
                              }))
                            ];

                            return chartData;
                          } else {
                            // å¤šæ¿å—æ¨¡å¼ï¼šæ˜¾ç¤ºæ¿å—å¯¹æ¯”å›¾è¡¨
                            const filteredSectors = selectedWeekdayData.sectorData
                              .filter(sector => showOnly5PlusInWeekdayModal ? sector.stockCount >= 5 : true)
                              .slice(0, 10);

                            if (filteredSectors.length === 0) return [];

                            const allDates = new Set<string>();
                            filteredSectors.forEach(sector => {
                              if ((sector as any).chartData) {
                                (sector as any).chartData.forEach((d: any) => allDates.add(d.date));
                              }
                            });

                            const sortedDates = Array.from(allDates).sort();

                            const chartData = [
                              {
                                label: formatDateCompact(selectedWeekdayData.date) || 'å½“æ—¥',
                                date: selectedWeekdayData.date,
                                ...Object.fromEntries(
                                  filteredSectors.map(sector => [
                                    cleanSectorName(sector.sectorName),
                                    sector.avgPremium
                                  ])
                                )
                              },
                              ...sortedDates.slice(0, 5).map((date, index) => ({
                                label: formatDateCompact(date) || `æ—¥${index + 1}`,
                                date: date,
                                ...Object.fromEntries(
                                  filteredSectors.map(sector => {
                                    const dayData = (sector as any).chartData?.find((d: any) => d.date === date);
                                    return [cleanSectorName(sector.sectorName), dayData?.avgPremium || 0];
                                  })
                                )
                              }))
                            ];

                            return chartData;
                          }
                        })()}
                      >
                        <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                        <XAxis
                          dataKey="label"
                          tick={{ fontSize: 12 }}
                          axisLine={{ stroke: '#e5e7eb' }}
                        />
                        <YAxis
                          tick={{ fontSize: 12 }}
                          axisLine={{ stroke: '#e5e7eb' }}
                          label={{ value: 'æº¢ä»·(%)', angle: -90, position: 'insideLeft' }}
                        />
                        <Tooltip
                          content={({ active, payload, label }) => {
                            if (active && payload && payload.length) {
                              return (
                                <div className="bg-white p-3 shadow-lg rounded border text-xs max-w-xs">
                                  <p className="text-gray-800 font-semibold mb-2">{label}</p>
                                  {payload.map((entry, index) => (
                                    <div key={index} className="flex justify-between items-center">
                                      <span style={{ color: entry.color }} className="mr-2">
                                        {entry.dataKey}:
                                      </span>
                                      <span className="font-semibold">
                                        {entry.value?.toFixed(2)}%
                                      </span>
                                    </div>
                                  ))}
                                </div>
                              );
                            }
                            return null;
                          }}
                        />
                        <Legend
                          wrapperStyle={{ fontSize: '10px' }}
                          iconType="line"
                        />

                        {/* ç”Ÿæˆçº¿æ¡ */}
                        {selectedWeekdayData.sectorData.length === 1
                          ? (() => {
                              // å•æ¿å—æ¨¡å¼ï¼šä¸ºæ¯åªä¸ªè‚¡ç”Ÿæˆä¸€æ¡çº¿
                              const sector = selectedWeekdayData.sectorData[0];
                              const stocksData = (sector as any).stocks || [];  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„ stocks å­—æ®µ
                              const filteredStocks = stocksData.filter((stock: any) =>
                                showOnly5PlusInWeekdayModal ? stock.totalReturn > 10 : true
                              ).slice(0, 10);

                              const colors = [
                                '#dc2626', '#2563eb', '#16a34a', '#ca8a04', '#9333ea',
                                '#c2410c', '#0891b2', '#be185d', '#4338ca', '#059669'
                              ];

                              return filteredStocks.map((stock: any, index: number) => (
                                <Line
                                  key={stock.code}
                                  type="monotone"
                                  dataKey={stock.name.length > 4 ? stock.name.slice(0, 4) : stock.name}
                                  stroke={colors[index % colors.length]}
                                  strokeWidth={2}
                                  dot={{ r: 3 }}
                                  activeDot={{ r: 5 }}
                                  connectNulls={false}
                                />
                              ));
                            })()
                          : selectedWeekdayData.sectorData
                              .filter(sector => showOnly5PlusInWeekdayModal ? sector.stockCount >= 5 : true)
                              .slice(0, 10)
                              .map((sector, index) => {
                                // å¤šæ¿å—æ¨¡å¼ï¼šä¸ºæ¯ä¸ªæ¿å—ç”Ÿæˆä¸€æ¡çº¿
                                const colors = [
                                  '#dc2626', '#2563eb', '#16a34a', '#ca8a04', '#9333ea',
                                  '#c2410c', '#0891b2', '#be185d', '#4338ca', '#059669'
                                ];
                                return (
                                  <Line
                                    key={sector.sectorName}
                                    type="monotone"
                                    dataKey={cleanSectorName(sector.sectorName)}
                                    stroke={colors[index % colors.length]}
                                    strokeWidth={2}
                                    dot={{ r: 4 }}
                                    activeDot={{ r: 6 }}
                                    connectNulls={false}
                                  />
                                );
                              })
                        }
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                </div>

                {/* æ˜¾ç¤ºè¯´æ˜ */}
                <div className="mt-3 text-xs text-gray-500 text-center">
                  {selectedWeekdayData.sectorData.length === 1
                    ? (() => {
                        const sector = selectedWeekdayData.sectorData[0];
                        const stocksData = (sector as any).stocks || [];  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„ stocks å­—æ®µ
                        const filteredCount = stocksData.filter((stock: any) =>
                          showOnly5PlusInWeekdayModal ? stock.totalReturn > 10 : true
                        ).length;
                        return filteredCount > 10
                          ? `æ˜¾ç¤ºå‰10åªä¸ªè‚¡ï¼Œå…±${filteredCount}åª`
                          : null;
                      })()
                    : selectedWeekdayData.sectorData.filter(sector => showOnly5PlusInWeekdayModal ? sector.stockCount >= 5 : true).length > 10 &&
                      `æ˜¾ç¤ºå‰10ä¸ªæ¿å—ï¼Œå…±${selectedWeekdayData.sectorData.filter(sector => showOnly5PlusInWeekdayModal ? sector.stockCount >= 5 : true).length}ä¸ª`
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ä¸ƒå¤©æ¿å—è¯¦æƒ…å¼¹çª— */}
      {showSevenDaysSectorModal && selectedSevenDaysSectorData && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999]">
          <div className="bg-white rounded-xl p-4 max-w-[95vw] max-h-[90vh] overflow-hidden shadow-2xl">
            <div className="flex justify-between items-center mb-3 pb-2 border-b border-gray-200">
              <h3 className="text-lg font-bold text-gray-900">
                ğŸ“Š {cleanSectorName(selectedSevenDaysSectorData.sectorName)} - 7å¤©æ¶¨åœæ¢¯é˜Ÿå¯¹æ¯”
              </h3>
              <button
                onClick={closeSevenDaysSectorModal}
                className="w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500 hover:text-red-500 transition-colors text-sm"
              >
                âœ•
              </button>
            </div>

            <div className="mb-3 text-xs text-gray-600">
              è¿‘7å¤© {cleanSectorName(selectedSevenDaysSectorData.sectorName)} æ¿å—æ¶¨åœæƒ…å†µï¼Œæ¨ªå‘å¯¹æ¯”æ¯æ—¥æ¢¯é˜Ÿå˜åŒ–
            </div>

            {/* æ¨ªå‘7å¤©å¸ƒå±€ */}
            <div className="grid grid-cols-7 gap-2 h-[75vh] overflow-auto">
              {selectedSevenDaysSectorData.dailyData.map((dayData) => {
                return (
                  <div key={dayData.date} className="bg-gray-50 rounded-lg overflow-hidden flex flex-col">
                    {/* æ—¥æœŸå¤´éƒ¨ */}
                    <div
                      className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-2 text-center cursor-pointer hover:bg-blue-800 transition-colors"
                      onClick={() => {
                        if (dayData.stocks.length > 0) {
                          // è®¡ç®—åç»­5å¤©æº¢ä»·æ•°æ®å¹¶æ˜¾ç¤º
                          const dayIndex = dates.indexOf(dayData.date);
                          const next5Days = dates.slice(dayIndex + 1, dayIndex + 6);
                          const dayDataFromSevenDays = sevenDaysData?.[dayData.date];

                          if (dayDataFromSevenDays) {
                            const followUpData = dayDataFromSevenDays.followUpData[selectedSevenDaysSectorData.sectorName] || {};
                            handleSectorClick(dayData.date, selectedSevenDaysSectorData.sectorName, dayData.stocks, followUpData);
                          }
                        }
                      }}
                    >
                      <div className="text-xs font-medium">
                        {formatDateCompact(dayData.date)}
                      </div>
                      <div className="text-[10px] opacity-90">
                        {new Date(dayData.date).toLocaleDateString('zh-CN', { weekday: 'short' })}
                      </div>
                      <div className="text-[10px] mt-1 bg-white/20 rounded px-1 py-0.5">
                        {dayData.count}
                      </div>
                    </div>

                    {/* ä¸ªè‚¡åˆ—è¡¨ */}
                    <div className="flex-1 p-2 space-y-1 overflow-y-auto">
                      {dayData.stocks.length === 0 ? (
                        <div className="text-center text-gray-500 py-3 text-xs">
                          æ— æ¶¨åœè‚¡ç¥¨
                        </div>
                      ) : (
                        dayData.stocks
                          .sort((a, b) => {
                            // æŒ‰è¿æ¿å¤©æ•°æ’åºï¼ˆå­—ç¬¦ä¸²å€’åºï¼‰
                            return b.td_type.localeCompare(a.td_type);
                          })
                          .map((stock, stockIndex) => {
                            // è®¡ç®—è¯¥è‚¡ç¥¨å½“æ—¥çš„å¹³å‡æº¢ä»·
                            const dayDataFromSevenDays = sevenDaysData?.[dayData.date];
                            const followUpData = dayDataFromSevenDays?.followUpData[selectedSevenDaysSectorData.sectorName]?.[stock.code] || {};
                            const stockTotalReturn = Object.values(followUpData).reduce((sum, val) => sum + val, 0);

                            return (
                              <div
                                key={stock.code}
                                className="border border-gray-200 rounded p-1.5 cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all"
                                onClick={() => handleStockClick(stock.name, stock.code)}
                              >
                                <div className="flex items-center justify-between">
                                  <div className="flex-1 min-w-0">
                                    <div className="font-medium text-gray-900 text-[10px] truncate hover:text-blue-600 transition-colors leading-tight">
                                      {stock.name.length > 6 ? stock.name.slice(0, 6) : stock.name}
                                    </div>
                                    <div className="text-[8px] text-gray-500 mt-0.5">
                                      {stock.code}
                                    </div>
                                    <div className="text-[8px] mt-0.5">
                                      <span className={`px-1 py-0.5 rounded text-[8px] font-medium ${
                                        stock.td_type.includes('è¿æ¿') || stock.td_type.includes('æ¿') ?
                                        'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'
                                      }`}>
                                        {stock.td_type}
                                      </span>
                                    </div>
                                  </div>
                                  <div className="ml-1 text-right">
                                    <div className="text-[8px] text-gray-500">æº¢ä»·</div>
                                    <div className={`text-[8px] px-1 py-0.5 rounded font-medium ${
                                      getPerformanceClass(stockTotalReturn)
                                    }`}>
                                      {stockTotalReturn.toFixed(1)}%
                                    </div>
                                  </div>
                                </div>
                              </div>
                            );
                          })
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* ä½¿ç”¨è¯´æ˜ */}
            <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
              <div className="text-blue-800 text-sm">
                ğŸ’¡ <strong>ä½¿ç”¨è¯´æ˜</strong>: ç‚¹å‡»ä»»æ„æ—¥æœŸå¯æŸ¥çœ‹è¯¥æ—¥æ¶¨åœè‚¡ç¥¨çš„åç»­5å¤©æº¢ä»·è¡¨ç°è¯¦æƒ…
              </div>
            </div>
          </div>
        </div>
      )}

      {/* æ—¥æœŸæ‰€æœ‰ä¸ªè‚¡æº¢ä»·å¼¹çª— */}
      {showDateModal && selectedDateData && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999]">
          <div className="bg-white rounded-xl p-6 max-w-7xl max-h-[90vh] overflow-auto shadow-2xl">
            <div className="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
              <h3 className="text-xl font-bold text-gray-900">
                ğŸ“ˆ {(() => {
                  try {
                    return formatDate(selectedDateData.date);
                  } catch (error) {
                    console.warn('[æ—¥æœŸå¼¹çª—] æ ‡é¢˜æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥:', selectedDateData.date, error);
                    return selectedDateData.date;
                  }
                })()} - æ‰€æœ‰æ¶¨åœä¸ªè‚¡æº¢ä»·åˆ†æ
              </h3>
              <button
                onClick={closeDateModal}
                className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500 hover:text-red-500 transition-colors"
              >
                âœ•
              </button>
            </div>

            <div className="mb-4 flex justify-between items-center">
              <div className="text-sm text-gray-600">
                å…± {selectedDateData.sectorData
                  .filter(sector => showOnly5PlusInDateModal ? sector.stocks.length >= 5 : true)
                  .reduce((total, sector) => total + sector.stocks.length, 0)} åªæ¶¨åœä¸ªè‚¡ï¼ŒæŒ‰5æ—¥ç´¯è®¡æº¢ä»·æ’åº
              </div>
              <button
                onClick={() => setShowOnly5PlusInDateModal(!showOnly5PlusInDateModal)}
                className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
                  showOnly5PlusInDateModal
                    ? 'bg-blue-100 text-blue-700 border border-blue-300'
                    : 'bg-gray-100 text-gray-700 border border-gray-300'
                }`}
              >
                {showOnly5PlusInDateModal ? 'æ˜¾ç¤ºå…¨éƒ¨æ¿å—' : 'åªæ˜¾ç¤ºâ‰¥5å®¶æ¿å—'}
              </button>
            </div>

            <div className="space-y-2 max-h-96 overflow-y-auto">
              {selectedDateData.sectorData
                .filter(sector => showOnly5PlusInDateModal ? sector.stocks.length >= 5 : true)
                .flatMap(sector =>
                  sector.stocks.map(stock => ({
                    ...stock,
                    sectorName: sector.sectorName,
                    sectorAvgPremium: sector.avgPremium
                  }))
                )
                .sort((a, b) => b.totalReturn - a.totalReturn)
                .map((stock, index) => {
                  const followUpDates = Object.keys(stock.followUpData).sort();
                  return (
                    <div key={`${stock.code}-${stock.sectorName}`} className="bg-white rounded-lg p-3 border border-gray-200 hover:shadow-md transition-shadow">
                      <div className="flex justify-between items-start mb-2">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="text-xs text-gray-400 font-mono w-8">#{index + 1}</span>
                            <h5
                              className="font-medium text-blue-600 hover:text-blue-800 cursor-pointer hover:underline"
                              onClick={() => handleStockClick(stock.name, stock.code)}
                            >
                              {stock.name} ({stock.code})
                            </h5>
                          </div>
                          <div className="flex items-center gap-2 text-xs text-gray-500 ml-10">
                            <span className="bg-blue-50 text-blue-700 px-2 py-0.5 rounded">{cleanSectorName(stock.sectorName)}</span>
                            <span>{stock.td_type}</span>
                          </div>
                        </div>
                        <div className={`px-3 py-1 rounded-full text-sm font-medium ${
                          getPerformanceClass(stock.totalReturn)
                        }`}>
                          ç´¯è®¡: {stock.totalReturn.toFixed(2)}%
                        </div>
                      </div>

                      <div className="grid grid-cols-5 gap-2 ml-10">
                        {followUpDates.slice(0, 5).map((followDate, dayIndex) => {
                          const performance = stock.followUpData[followDate] || 0;

                          // ä½¿ç”¨ç»Ÿä¸€çš„æ—¥æœŸæ ¼å¼åŒ–
                          const formattedDate = formatDateCompact(followDate) || `æ—¥æœŸ${dayIndex + 1}`;

                          return (
                            <div key={followDate || `day-${dayIndex}`} className="text-center bg-gray-50 rounded p-2">
                              <div className="text-xs text-gray-400 mb-1">{formattedDate}</div>
                              <div className="text-xs text-gray-400 mb-1">{formattedDate}</div>
                              <div className={getPerformanceClass(performance)}>
                                {performance.toFixed(2)}%
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
            </div>
          </div>
        </div>
      )}


      {/* ä¸“ä¸šæ¿å—æ’è¡Œæ¦œå¼¹çª— */}
      {showSectorRankingModal && (
        <div className="finance-modal-overlay animate-fade-in">
          <div className="finance-modal max-w-4xl animate-scale-in">
            <div className="finance-modal-header">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg flex items-center justify-center">
                  <span className="text-white text-lg">ğŸ†</span>
                </div>
                <div>
                  <h3 className="text-lg font-semibold text-finance-text-primary">
                    æ¿å—å®åŠ›æ’è¡Œæ¦œ - è¿‘7å¤©æ•°æ®
                  </h3>
                  <div className="text-sm text-finance-text-secondary mt-1">
                    æŒ‰æ¶¨åœå®¶æ•°ç»Ÿè®¡ Â· TOP5 æœ€å¼ºåŠ¿æ¿å—åˆ†æ
                  </div>
                </div>
              </div>
              <button
                onClick={closeSectorRankingModal}
                className="finance-modal-close"
              >
                âœ•
              </button>
            </div>

            <div className="finance-modal-body">
              <div className="mb-6">
                <div className="finance-alert-info">
                  <div className="w-5 h-5 text-blue-600">ğŸ“Š</div>
                  <div>
                    <div className="font-medium">æ’è¡Œè§„åˆ™</div>
                    <div className="text-sm mt-1">
                      åŸºäºè¿‘7ä¸ªäº¤æ˜“æ—¥çš„æ¶¨åœå®¶æ•°ç´¯è®¡ï¼Œå®æ—¶åæ˜ æ¿å—èµ„é‡‘æ´»è·ƒåº¦å’Œå¸‚åœºå…³æ³¨åº¦
                    </div>
                  </div>
                </div>
              </div>

              {/* ä¸“ä¸šæ’è¡Œè¡¨æ ¼ */}
              <div className="finance-table">
                <table className="w-full text-sm">
                  <thead className="finance-table-header">
                    <tr>
                      <th className="finance-table-header-cell">æ’å</th>
                      <th className="finance-table-header-cell text-left">æ¿å—åç§°</th>
                      <th className="finance-table-header-cell">æ€»è®¡</th>
                      {dates.map((date, index) => {
                        try {
                          const formattedDate = formatDateCompact(date);
                          return (
                            <th key={date} className="finance-table-header-cell text-xs">
                              {formattedDate}
                            </th>
                          );
                        } catch (error) {
                          return (
                            <th key={date} className="finance-table-header-cell text-xs">
                              D{index + 1}
                            </th>
                          );
                        }
                      })}
                    </tr>
                  </thead>
                  <tbody>
                    {getSectorStrengthRanking.map((sector, index) => (
                      <tr key={sector.name} className={`finance-table-row ${index % 2 === 0 ? 'bg-white' : 'bg-finance-bg-secondary'}`}>
                        <td className="finance-table-cell">
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold shadow-sm ${
                            index === 0 ? 'bg-gradient-to-r from-yellow-400 to-yellow-500 text-white' :
                            index === 1 ? 'bg-gradient-to-r from-gray-400 to-gray-500 text-white' :
                            index === 2 ? 'bg-gradient-to-r from-orange-400 to-orange-500 text-white' :
                            index === 3 ? 'bg-gradient-to-r from-blue-400 to-blue-500 text-white' :
                            'bg-gradient-to-r from-green-400 to-green-500 text-white'
                          }`}>
                            {index + 1}
                          </div>
                        </td>
                        <td className="finance-table-cell">
                          <div
                            className="font-semibold text-finance-accent hover:text-finance-accent-hover cursor-pointer hover:underline transition-colors"
                            onClick={() => handleSevenDaysSectorClick(sector.name)}
                            title={sector.name}
                          >
                            {cleanSectorName(sector.name)}
                          </div>
                        </td>
                        <td className="finance-table-cell text-center">
                          <div className={`finance-badge font-bold ${
                            index === 0 ? 'bg-stock-up-100 text-stock-up-700 border-stock-up-200' :
                            index === 1 ? 'bg-orange-100 text-orange-700 border-orange-200' :
                            index === 2 ? 'bg-yellow-100 text-yellow-700 border-yellow-200' :
                            'bg-primary-100 text-primary-700 border-primary-200'
                          }`}>
                            {sector.totalLimitUpCount}
                          </div>
                        </td>
                        {sector.dailyBreakdown.map((day, dayIndex) => (
                          <td key={day.date} className="finance-table-cell text-center">
                            <div className={`inline-flex items-center justify-center w-8 h-8 rounded-md text-xs font-semibold ${
                              day.count >= 10 ? 'bg-stock-up-600 text-white' :
                              day.count >= 5 ? 'bg-finance-warning text-white' :
                              day.count > 0 ? 'bg-primary-100 text-primary-700' : 'bg-finance-bg-secondary text-finance-text-tertiary'
                            }`}>
                              {day.count}
                            </div>
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {getSectorStrengthRanking.length === 0 && (
                <div className="text-center py-12">
                  <div className="w-16 h-16 mx-auto mb-4 bg-finance-bg-secondary rounded-full flex items-center justify-center">
                    <span className="text-2xl text-finance-text-tertiary">ğŸ“Š</span>
                  </div>
                  <h4 className="text-lg font-semibold text-finance-text-primary mb-2">æš‚æ— æ•°æ®</h4>
                  <p className="text-sm text-finance-text-secondary">æš‚æ— å¯ç”¨çš„æ’è¡Œæ¦œæ•°æ®</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* ä¸“ä¸šKçº¿å›¾å¼¹çª— */}
      {showModal && selectedStock && (
        <div className="finance-modal-overlay animate-fade-in">
          <div className="finance-modal max-w-5xl animate-scale-in">
            <div className="finance-modal-header">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                  <span className="text-white text-lg">ğŸ“‰</span>
                </div>
                <div>
                  <h3 className="text-lg font-semibold text-finance-text-primary">
                    {selectedStock.name} ({selectedStock.code})
                  </h3>
                  <div className="text-sm text-finance-text-secondary mt-1">
                    ä¸“ä¸šæŠ€æœ¯åˆ†æå›¾è¡¨ Â· å®æ—¶è¡Œæƒ…æ•°æ®
                  </div>
                </div>
              </div>
              <button
                onClick={closeModal}
                className="finance-modal-close"
              >
                âœ•
              </button>
            </div>
            <div className="finance-modal-body">
              <div className="text-center">
                <div className="finance-card p-6 bg-gradient-to-br from-finance-bg-primary to-finance-bg-secondary">
                  <img
                    src={`http://image.sinajs.cn/newchart/daily/${getStockCodeFormat(selectedStock.code)}.gif`}
                    alt={`${selectedStock.name}Kçº¿å›¾`}
                    className="max-w-full h-auto rounded-lg shadow-elevated border border-finance-border-light"
                    loading="lazy"
                    onError={(e) => {
                      const target = e.target as HTMLImageElement;
                      target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjlmOWY5Ii8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPktcdTdFRkZcdTU2RkVcdTUyMDBcdThGN0RcdTUxMTZcdTUwNjdcdTU5MzQ8L3RleHQ+Cjwvc3ZnPg==';
                    }}
                  />
                </div>

                <div className="mt-6 finance-alert-info">
                  <div className="w-5 h-5 text-blue-600">ğŸ“Š</div>
                  <div>
                    <div className="font-medium">æ•°æ®æ¥æº</div>
                    <div className="text-sm mt-1">
                      æ–°æµªè´¢ç»å®æ—¶æ•°æ® Â· ä¸“ä¸šæŠ€æœ¯åˆ†æå·¥å…· Â· ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ä¸“ä¸šé¡µé¢æ ‡é¢˜å’Œæ§åˆ¶åŒºåŸŸ */}
      <div className="max-w-full mx-auto mb-4 sm:mb-6">
        <div className="finance-panel-primary p-4 sm:p-6">
          {/* ä¸»æ ‡é¢˜åŒºåŸŸ */}
          <div className="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4 mb-6">
            <div className="flex flex-col lg:flex-row lg:items-center gap-4">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-finance-accent rounded-lg flex items-center justify-center">
                  <span className="text-white text-lg">ğŸ“ˆ</span>
                </div>
                <div>
                  <h1 className="text-display-sm font-bold text-finance-text-primary">å®‡ç¡•æ¿å—èŠ‚å¥</h1>
                  <p className="text-sm text-finance-text-secondary">ä¸“ä¸šè‚¡ç¥¨æ¿å—7æ—¥æ¶¨åœæ•°æ®è¿½è¸ªç³»ç»Ÿ</p>
                </div>
              </div>

              {/* ä¸ƒå¤©æ¶¨åœæ’è¡ŒTOP5ä¼˜åŒ–æ˜¾ç¤º */}
              {getSectorStrengthRanking.length > 0 && (
                <div className="flex items-center gap-2 lg:ml-6">
                  <span className="text-xs font-medium text-finance-text-secondary mr-2">7æ—¥çƒ­é—¨:</span>
                  {getSectorStrengthRanking.slice(0, 5).map((sector, index) => (
                    <div
                      key={sector.name}
                      className="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-primary-25 to-primary-50 rounded-lg border border-primary-200 cursor-pointer hover:shadow-finance hover:border-finance-accent transition-all duration-200"
                      onClick={() => handleSevenDaysSectorClick(sector.name)}
                    >
                      <div className={`w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${
                        index === 0 ? 'bg-gradient-to-r from-finance-error to-red-500 text-white shadow-sm' :
                        index === 1 ? 'bg-gradient-to-r from-finance-warning to-orange-500 text-white shadow-sm' :
                        index === 2 ? 'bg-gradient-to-r from-yellow-400 to-yellow-500 text-white shadow-sm' :
                        index === 3 ? 'bg-gradient-to-r from-finance-accent to-blue-500 text-white shadow-sm' :
                        'bg-gradient-to-r from-finance-success to-green-500 text-white shadow-sm'
                      }`}>
                        {index + 1}
                      </div>
                      <span className="text-xs font-medium text-finance-text-primary truncate max-w-[60px]" title={sector.name}>
                        {sector.name.length > 4 ? sector.name.slice(0, 4) : sector.name}
                      </span>
                      <span className={`text-xs font-bold ${
                        index === 0 ? 'text-finance-error' :
                        index === 1 ? 'text-finance-warning' :
                        index === 2 ? 'text-yellow-600' :
                        index === 3 ? 'text-finance-accent' :
                        'text-finance-success'
                      }`}>
                        {sector.totalLimitUpCount}
                      </span>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="flex items-center gap-3">
              {/* ä¸“ä¸šç­›é€‰å¼€å…³ */}
              <label className="flex items-center gap-2 text-sm cursor-pointer">
                <input
                  type="checkbox"
                  checked={onlyLimitUp5Plus}
                  onChange={(e) => setOnlyLimitUp5Plus(e.target.checked)}
                  className="w-4 h-4 text-finance-accent bg-white border-finance-border rounded focus:ring-finance-accent focus:ring-2"
                />
                <span className="text-finance-text-secondary font-medium">â‰¥5ä¸ªæ¶¨åœ</span>
              </label>

              {/* ä¸“ä¸šæŒ‰é’®ç»„ */}
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setShowSectorRankingModal(true)}
                  disabled={loading || !sevenDaysData}
                  className="btn-secondary flex items-center gap-2"
                >
                  <span>ğŸ†</span>
                  <span>7å¤©æ’è¡Œ</span>
                </button>

                <button
                  onClick={fetch7DaysData}
                  disabled={loading}
                  className="btn-primary flex items-center gap-2"
                >
                  <div className={`w-4 h-4 ${loading ? 'finance-spinner' : ''}`}>
                    {!loading && <span>ğŸ”„</span>}
                  </div>
                  <span>{loading ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°æ•°æ®'}</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* ä¸“ä¸šé”™è¯¯æç¤º */}
      {error && (
        <div className="max-w-full mx-auto mb-4 sm:mb-6">
          <div className="bg-red-50 border border-red-200 rounded-lg p-3 sm:p-4 flex items-center gap-2 sm:gap-3">
            <div className="w-8 h-8 bg-finance-error rounded-full flex items-center justify-center flex-shrink-0">
              <span className="text-white text-sm">âš </span>
            </div>
            <div>
              <h4 className="font-medium text-finance-error mb-1">æ•°æ®è·å–å¤±è´¥</h4>
              <p className="text-sm text-red-600">{error}</p>
            </div>
          </div>
        </div>
      )}

      {/* ä¸“ä¸š7å¤©æ—¶é—´è½´ä¸»å†…å®¹ */}
      {sevenDaysData && dates.length > 0 && (
        <div className="max-w-full mx-auto">
          {/* ä¸“ä¸šæ—¶é—´è½´ç½‘æ ¼ */}
          <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2 sm:gap-3 lg:gap-4">
            {dates.map((date) => {
              const dayData = sevenDaysData[date];
              const sectors = processedTimelineData[date] || [];

              return (
                <div key={date} className="timeline-card animate-fade-in">
                  {/* ä¸“ä¸šæ—¥æœŸå¤´éƒ¨ */}
                  <div className="timeline-header">
                    <div
                      className="text-sm font-semibold cursor-pointer hover:bg-white/10 rounded-md px-2 py-1 transition-all duration-200"
                      onClick={() => handleDateClick(date)}
                    >
                      {formatDateCompact(date)}
                    </div>
                    <div className="text-xs opacity-90 font-medium">
                      {new Date(date).toLocaleDateString('zh-CN', { weekday: 'short' })}
                    </div>
                    <div
                      className="text-xs mt-1 bg-white/20 rounded-full px-2 py-1 cursor-pointer hover:bg-white/30 transition-all duration-200 font-semibold"
                      onClick={() => handleStockCountClick(date)}
                    >
                      {dayData?.stats.total_stocks || 0}åª
                    </div>
                  </div>

                  {/* ä¸“ä¸šæ¿å—åˆ—è¡¨ */}
                  <div className="timeline-body finance-scrollbar">
                    {sectors.length === 0 ? (
                      <div className="text-center text-finance-text-tertiary py-4 text-xs">
                        <div className="w-8 h-8 mx-auto mb-2 bg-finance-bg-secondary rounded-full flex items-center justify-center">
                          <span className="text-finance-text-tertiary">ğŸ“Š</span>
                        </div>
                        æš‚æ— æ•°æ®
                      </div>
                    ) : (
                      sectors.map((sector) => {
                        // è®¡ç®—æ¿å—å¹³å‡æº¢ä»·
                        const sectorAvgPremium = sector.stocks.reduce((total, stock) => {
                          const followUpData = sector.followUpData[stock.code] || {};
                          const stockTotalReturn = Object.values(followUpData).reduce((sum, val) => sum + val, 0);
                          return total + stockTotalReturn;
                        }, 0) / sector.stocks.length;

                        return (
                          <div
                            key={sector.name}
                            className="sector-card group"
                            onClick={() => handleSectorClick(date, sector.name, sector.stocks, sector.followUpData)}
                          >
                            <div className="flex items-center justify-between">
                              <div className="flex-1 min-w-0">
                                <div className="font-medium text-finance-text-primary text-xs truncate group-hover:text-finance-accent transition-colors">
                                  {cleanSectorName(sector.name)}
                                </div>
                                <div className="flex items-center gap-2 mt-1">
                                  <div className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${
                                    sector.count >= 10 ? 'bg-finance-error text-white' :
                                    sector.count >= 5 ? 'bg-finance-warning text-white' :
                                    sector.count >= 3 ? 'bg-finance-accent text-white' :
                                    'bg-finance-bg-secondary text-finance-text-secondary'
                                  }`}>
                                    {sector.count}å®¶
                                  </div>
                                  <div className="status-indicator bg-finance-success"></div>
                                </div>
                              </div>
                              <div className="text-right ml-2">
                                <div className="text-[9px] text-finance-text-tertiary mb-1">æº¢ä»·</div>
                                <div className={`text-[9px] font-medium ${getPerformanceClass(sectorAvgPremium)}`}>
                                  {sectorAvgPremium.toFixed(1)}%
                                </div>
                              </div>
                            </div>
                          </div>
                        );
                      })
                    )}
                  </div>
                </div>
              );
            })}
          </div>

          {/* ä¸“ä¸šä½¿ç”¨è¯´æ˜ */}
          <div className="mt-6 finance-panel-primary p-6">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-8 h-8 bg-finance-accent rounded-lg flex items-center justify-center">
                <span className="text-white text-sm">ğŸ’¡</span>
              </div>
              <h3 className="text-lg font-semibold text-finance-text-primary">ä½¿ç”¨è¯´æ˜</h3>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div className="space-y-3">
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 bg-finance-accent rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-xs">1</span>
                  </div>
                  <div>
                    <strong className="text-finance-text-primary">ç‚¹å‡»æ—¥æœŸå¤´éƒ¨</strong>
                    <p className="text-finance-text-secondary">å·¦å³åˆ†å±æ˜¾ç¤ºæ¿å—5æ—¥æº¢ä»·æ•°æ®è¡¨å’Œè¶‹åŠ¿å›¾</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 bg-finance-warning rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-xs">2</span>
                  </div>
                  <div>
                    <strong className="text-finance-text-primary">ç‚¹å‡»æ¿å—åç§°</strong>
                    <p className="text-finance-text-secondary">æ˜¾ç¤ºè¯¥æ¿å—ä¸ªè‚¡5æ—¥æº¢ä»·è¯¦ç»†è¡¨ç°</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 bg-finance-success rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-xs">3</span>
                  </div>
                  <div>
                    <strong className="text-finance-text-primary">ç‚¹å‡»æ¶¨åœæ•°</strong>
                    <p className="text-finance-text-secondary">åˆ›å»ºå¯æ‹–æ‹½çš„å¤šçª—å£ï¼ŒåŒæ—¶å¯¹æ¯”å¤šä¸ªæ—¥æœŸ</p>
                  </div>
                </div>
              </div>
              <div className="space-y-3">
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-xs">4</span>
                  </div>
                  <div>
                    <strong className="text-finance-text-primary">ç‚¹å‡»è‚¡ç¥¨åç§°</strong>
                    <p className="text-finance-text-secondary">æŸ¥çœ‹ä¸“ä¸šKçº¿å›¾å’ŒæŠ€æœ¯åˆ†æ</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 bg-pink-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-xs">5</span>
                  </div>
                  <div>
                    <strong className="text-finance-text-primary">æ¿å—ç­›é€‰</strong>
                    <p className="text-finance-text-secondary">å¯ç­›é€‰åªæ˜¾ç¤ºâ‰¥5ä¸ªæ¶¨åœçš„æ´»è·ƒæ¿å—</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 bg-indigo-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-xs">6</span>
                  </div>
                  <div>
                    <strong className="text-finance-text-primary">7å¤©æ’è¡Œ</strong>
                    <p className="text-finance-text-secondary">æŸ¥çœ‹æœ€è¿‘7å¤©æ¿å—æ¶¨åœæ•°ä¸“ä¸šæ’å</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ä¸“ä¸šå“åº”å¼æ— æ•°æ®çŠ¶æ€ */}
      {sevenDaysData && dates.length === 0 && !loading && (
        <div className="max-w-full mx-auto">
          <div className="finance-panel-primary p-6 sm:p-12 text-center">
            <div className="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-4 sm:mb-6 bg-finance-bg-secondary rounded-full flex items-center justify-center">
              <span className="text-2xl sm:text-4xl text-finance-text-tertiary">ğŸ“Š</span>
            </div>
            <h3 className="text-lg sm:text-display-sm font-bold text-finance-text-primary mb-2 sm:mb-3">æš‚æ— 7å¤©æ•°æ®</h3>
            <p className="text-sm sm:text-base text-finance-text-secondary mb-4 sm:mb-6 max-w-sm sm:max-w-md mx-auto">
              æ— æ³•è·å–æœ€è¿‘7å¤©çš„æ¶¨åœæ•°æ®ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æ•°æ®æºæš‚æ—¶ä¸å¯ç”¨
            </p>
            <button
              onClick={fetch7DaysData}
              className="btn-primary text-sm sm:text-base"
            >
              é‡æ–°è·å–æ•°æ®
            </button>
          </div>
        </div>
      )}

      {/* ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­ */}
      {showModal && (
        <div
          className="fixed inset-0 z-[9998]"
          onClick={closeModal}
        />
      )}
      {showSectorModal && (
        <div
          className="fixed inset-0 z-[9998]"
          onClick={closeSectorModal}
        />
      )}
      {showDateModal && (
        <div
          className="fixed inset-0 z-[9998]"
          onClick={closeDateModal}
        />
      )}
      {showSectorRankingModal && (
        <div
          className="fixed inset-0 z-[9998]"
          onClick={closeSectorRankingModal}
        />
      )}
      {showWeekdayModal && (
        <div
          className="fixed inset-0 z-[9998]"
          onClick={closeWeekdayModal}
        />
      )}
      {showSevenDaysSectorModal && (
        <div
          className="fixed inset-0 z-[9998]"
          onClick={closeSevenDaysSectorModal}
        />
      )}

      {/* ä¸“ä¸šå¤šçª—å£æ‹–æ‹½ç»„ä»¶ */}
      {stockCountWindows.map((window) => (
        <div
          key={window.id}
          className="draggable-window animate-scale-in"
          style={{
            left: `${window.position.x}px`,
            top: `${window.position.y}px`,
            zIndex: window.zIndex,
            width: 'min(95vw, 1000px)',
            maxHeight: 'min(85vh, 600px)',
            cursor: draggedWindow === window.id ? 'grabbing' : 'auto'
          }}
        >
          {/* ä¸“ä¸šçª—å£æ ‡é¢˜æ  */}
          <div
            className="draggable-window-header"
            onMouseDown={(e) => handleMouseDown(e, window.id)}
            onTouchStart={(e) => {
              // ç§»åŠ¨ç«¯æ”¯æŒ
              const touch = e.touches[0];
              const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
              });
              handleMouseDown(mouseEvent as any, window.id);
            }}
          >
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-2 min-w-0">
                <div className="w-6 h-6 bg-white/20 rounded-md flex items-center justify-center flex-shrink-0">
                  <span className="text-white text-xs">ğŸ“Š</span>
                </div>
                <div className="min-w-0">
                  <h3 className="text-sm font-semibold truncate">
                    {formatDateCompact(window.date)} æ¶¨åœåˆ†æ
                  </h3>
                  <div className="text-xs opacity-90 hidden sm:block">
                    5å¤©æº¢ä»·è¡¨ç°è·Ÿè¸ª
                  </div>
                </div>
              </div>
              <button
                onClick={() => closeWindow(window.id)}
                className="w-7 h-7 flex items-center justify-center rounded-full hover:bg-white/20 text-white hover:text-red-200 transition-all duration-200 hover:scale-110 flex-shrink-0"
              >
                âœ•
              </button>
            </div>
          </div>

          {/* ä¸“ä¸šçª—å£å†…å®¹ */}
          <div className="draggable-window-body" style={{ maxHeight: '500px' }}>
            <div className="mb-4">
              <div className="finance-alert-info">
                <div className="w-5 h-5 text-blue-600">ğŸ“Š</div>
                <div>
                  <div className="font-medium">æ•°æ®æ¦‚è§ˆ</div>
                  <div className="text-sm mt-1">
                    å…± {window.sectorData
                      .filter(sector => showOnly5PlusInStockCountModal ? sector.stocks.length >= 5 : true)
                      .reduce((total, sector) => total + sector.stocks.length, 0)} åªæ¶¨åœä¸ªè‚¡ï¼ŒæŒ‰æ¿å—åˆ†ç»„æ˜¾ç¤º
                  </div>
                </div>
              </div>
            </div>

            {/* ä¸“ä¸šå“åº”å¼ç½‘æ ¼å¸ƒå±€ */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[400px] overflow-y-auto finance-scrollbar">
              {window.sectorData
                .filter(sector => showOnly5PlusInStockCountModal ? sector.stocks.length >= 5 : true)
                .map((sector, sectorIndex) => {
                  // è·å–è¯¥æ¿å—çš„5æ—¥æœŸèŒƒå›´
                  const allFollowUpDates = new Set<string>();
                  sector.stocks.forEach(stock => {
                    Object.keys(stock.followUpData).forEach(date => {
                      allFollowUpDates.add(date);
                    });
                  });
                  const followUpDates = Array.from(allFollowUpDates).sort().slice(0, 5);

                  return (
                    <div key={sector.sectorName} className="finance-card-elevated p-3 h-fit">
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2 min-w-0">
                          <div className="w-6 h-6 bg-gradient-to-r from-finance-accent to-blue-600 rounded-md flex items-center justify-center flex-shrink-0">
                            <span className="text-white text-xs">ğŸ“ˆ</span>
                          </div>
                          <div className="min-w-0">
                            <h4 className="text-sm font-semibold text-finance-text-primary truncate">
                              {cleanSectorName(sector.sectorName)}
                            </h4>
                            <div className="text-xs text-finance-text-tertiary">
                              {sector.stocks.length}åªä¸ªè‚¡
                            </div>
                          </div>
                        </div>
                        <div className={`finance-badge text-xs font-semibold ${
                          sector.avgPremium > 10 ? 'bg-stock-up-100 text-stock-up-700 border-stock-up-200' :
                          sector.avgPremium > 0 ? 'bg-stock-down-100 text-stock-down-700 border-stock-down-200' :
                          'bg-finance-bg-secondary text-finance-text-secondary border-finance-border'
                        }`}>
                          {sector.avgPremium.toFixed(2)}%
                        </div>
                      </div>

                      {/* ä¸“ä¸šè¶…ç´§å‡‘è¡¨æ ¼æ˜¾ç¤º */}
                      <div className="max-h-[280px] overflow-y-auto finance-scrollbar">
                        <div className="finance-table">
                          <table className="w-full text-[10px] table-fixed">
                            <thead className="finance-table-header sticky top-0">
                              <tr>
                                <th className="finance-table-header-cell text-left w-12 sm:w-14">åç§°</th>
                                {followUpDates.map((date, index) => {
                                  return (
                                    <th key={date} className="finance-table-header-cell w-6 sm:w-8 text-[8px] sm:text-[10px]">
                                      <span className="hidden sm:inline">{formatDateCompact(date)}</span>
                                      <span className="sm:hidden">T+{index + 1}</span>
                                    </th>
                                  );
                                })}
                                <th className="finance-table-header-cell w-8 sm:w-10">ç´¯è®¡</th>
                              </tr>
                            </thead>
                            <tbody>
                              {sector.stocks.map((stock, stockIndex) => (
                                <tr key={stock.code} className={`finance-table-row hover:bg-finance-panel-hover`}>
                                  <td className="finance-table-cell px-1 py-1">
                                    <div
                                      className="font-medium text-finance-accent hover:text-finance-accent-hover cursor-pointer hover:underline text-[8px] sm:text-[9px] leading-tight transition-colors"
                                      onClick={() => handleStockClick(stock.name, stock.code)}
                                      title={`${stock.name} (${stock.code})`}
                                    >
                                      <span className="hidden sm:inline">
                                        {stock.name.length > 3 ? stock.name.slice(0, 3) : stock.name}
                                      </span>
                                      <span className="sm:hidden">
                                        {stock.name.length > 2 ? stock.name.slice(0, 2) : stock.name}
                                      </span>
                                    </div>
                                  </td>
                                  {followUpDates.map(date => {
                                    const performance = stock.followUpData[date] || 0;
                                    return (
                                      <td key={date} className="finance-table-cell px-0.5 py-1 text-center">
                                        <div className={`px-0.5 py-0.5 rounded text-[7px] sm:text-[8px] font-medium ${
                                          performance > 5 ? 'bg-stock-up-600 text-white' :
                                          performance > 0 ? 'bg-stock-up-100 text-stock-up-800' :
                                          performance < -5 ? 'bg-stock-down-600 text-white' :
                                          performance < 0 ? 'bg-stock-down-100 text-stock-down-800' :
                                          'bg-finance-bg-secondary text-finance-text-tertiary'
                                        }`}>
                                          <span className="hidden sm:inline">
                                            {performance > 0 ? `+${performance.toFixed(2)}` : performance.toFixed(2)}
                                          </span>
                                          <span className="sm:hidden">
                                            {performance > 0 ? `+${performance.toFixed(1)}` : performance.toFixed(1)}
                                          </span>
                                        </div>
                                      </td>
                                    );
                                  })}
                                  <td className="finance-table-cell px-1 py-1 text-center">
                                    <div className={`px-1 py-0.5 rounded text-[8px] sm:text-[9px] font-semibold ${
                                      stock.totalReturn > 10 ? 'bg-stock-up-600 text-white' :
                                      stock.totalReturn > 0 ? 'bg-stock-up-100 text-stock-up-800' :
                                      stock.totalReturn < -10 ? 'bg-stock-down-600 text-white' :
                                      stock.totalReturn < 0 ? 'bg-stock-down-100 text-stock-down-800' :
                                      'bg-finance-bg-secondary text-finance-text-tertiary'
                                    }`}>
                                      <span className="hidden sm:inline">
                                        {stock.totalReturn > 0 ? `+${stock.totalReturn.toFixed(2)}` : stock.totalReturn.toFixed(2)}
                                      </span>
                                      <span className="sm:hidden">
                                        {stock.totalReturn > 0 ? `+${stock.totalReturn.toFixed(1)}` : stock.totalReturn.toFixed(1)}
                                      </span>
                                    </div>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  );
                })
              }
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}