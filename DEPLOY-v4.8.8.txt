# v4.8.8 部署指南

## 修复内容
1. **数据刷新问题**: 将7天缓存时间从2小时缩短到30分钟（加快数据刷新）
2. **板块成交额显示**: 在首页板块名称后显示板块成交额总和（格式: 💰45.2亿）

## 本地提交状态
✅ 代码已提交到本地Git仓库
⚠️  GitHub推送失败（网络连接问题）

## 手动部署步骤

### 方式1: 重试推送到GitHub（推荐）
```bash
cd "C:\Users\yushu\Desktop\stock-tracker - 副本"
git push origin main
```

### 方式2: 服务器端单行部署命令
如果GitHub推送成功，在服务器上执行:
```bash
cd /www/wwwroot/stock-tracker && git fetch origin && git checkout -- src/app/page.tsx && git pull origin main && docker compose down && docker compose build --no-cache && docker compose up -d && sleep 20 && docker ps | grep stock-tracker && curl -I http://localhost:3002 && echo "✅ v4.8.8部署完成！"
```

### 方式3: 服务器端分步部署命令
```bash
# 1. 进入项目目录
cd /www/wwwroot/stock-tracker

# 2. 拉取最新代码
git fetch origin
git pull origin main

# 3. 停止当前容器
docker compose down

# 4. 重新构建镜像（无缓存）
docker compose build --no-cache

# 5. 启动新容器
docker compose up -d

# 6. 等待20秒让服务启动
sleep 20

# 7. 验证服务状态
docker ps | grep stock-tracker
curl -I http://localhost:3002

# 8. 确认部署成功
echo "✅ v4.8.8部署完成！"
```

## 验证部署

访问 http://bk.yushuo.click 检查:
1. 数据是否自动刷新到最新交易日（10月9日或更晚）
2. 板块名称后是否显示成交额（如: 💰45.2亿）

## 技术细节

### 修改的文件
1. src/app/api/stocks/route.ts - 后端API逻辑
   - 缓存时间: 2小时 → 30分钟 (line 26)
   - 提取成交额: stockData[6] (lines 258-276)
   - 计算板块成交额总和 (lines 819-845)

2. src/types/stock.ts - 类型定义
   - Stock.Amount: 成交额（亿元）(line 6)
   - DayData.sectorAmounts: 板块成交额汇总 (line 44)

3. src/app/page.tsx - 前端显示
   - 显示板块成交额徽章 (lines 1564-1576)

### 成交额数据流
API响应 → stockData[6] → Stock.Amount → sectorAmounts → 前端显示

### Git提交信息
```
commit fd974e4
feat: v4.8.8 修复数据刷新和添加板块成交额显示
```

## 回滚方案
如果v4.8.8有问题，可以回滚到v4.8.7:
```bash
cd /www/wwwroot/stock-tracker && git fetch origin --tags && git checkout v4.8.7-stable && docker compose down && docker compose build && docker compose up -d && sleep 20 && echo "✅ 已回滚到v4.8.7"
```

---
生成时间: 2025-10-09
版本: v4.8.8
