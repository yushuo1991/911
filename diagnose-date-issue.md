# 10æœˆ13æ—¥æ•°æ®ä¸æ˜¾ç¤ºé—®é¢˜è¯Šæ–­æŠ¥å‘Š

**é—®é¢˜æè¿°**: 10æœˆ13æ—¥19:00è®¿é—®ç½‘ç«™ï¼Œæœªæ˜¾ç¤º13æ—¥çš„æ•°æ®
**è¯Šæ–­æ—¶é—´**: 2025-10-13 19:00
**é—®é¢˜ç­‰çº§**: ğŸ”´ P0 - ä¸¥é‡ï¼ˆæ•°æ®æ˜¾ç¤ºå»¶è¿Ÿ1å¤©ï¼‰

---

## 1. é—®é¢˜æ ¹æºåˆ†æ

### é—®é¢˜é“¾æ¡

```
ç”¨æˆ·è®¿é—®ç½‘ç«™ (10æœˆ13æ—¥ 19:00)
    â†“
å‰ç«¯è°ƒç”¨ getTodayString()
    â†“
getTodayString() å¼ºåˆ¶å‡å»1å¤©
    â†“
è¿”å› "2025-10-12"  âŒ (åº”è¯¥è¿”å› "2025-10-13")
    â†“
APIæ¥æ”¶ endDate = "2025-10-12"
    â†“
APIåˆ¤æ–­ï¼šç°åœ¨19:00 >= 17:00ï¼ŒåŒ…å«"å½“å¤©"(10æœˆ12æ—¥)
    â†“
APIè¿”å›æœ€æ–°æ—¥æœŸï¼š10æœˆ12æ—¥
    â†“
ç”¨æˆ·çœ‹åˆ°çš„æœ€æ–°æ•°æ®ï¼š10æœˆ12æ—¥ âŒ (åº”è¯¥æ˜¯10æœˆ13æ—¥)
```

### æ ¹æœ¬åŸå› 

**æ–‡ä»¶**: `src/lib/utils.ts`
**å‡½æ•°**: `getTodayString()` (lines 273-277)
**é—®é¢˜ä»£ç **:

```typescript
export function getTodayString(): string {
  const date = new Date();
  date.setDate(date.getDate() - 1); // âŒ é—®é¢˜ï¼šå¼ºåˆ¶å‡å»1å¤©
  return date.toISOString().split('T')[0];
}
```

**åŸå§‹æ³¨é‡Š**: "ä½¿ç”¨æ˜¨å¤©æ—¥æœŸï¼Œé¿å…å½“å¤©æˆ–å‡æœŸæ— æ•°æ®"
**é—®é¢˜**: è¿™ä¸ªé€»è¾‘æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºï¼š
1. äº¤æ˜“æ—¥åˆ¤æ–­åº”è¯¥ç”± `get7TradingDaysFromCalendar()` å¤„ç†
2. è¯¥å‡½æ•°å·²ç»æ­£ç¡®å®ç°äº†17:00é€»è¾‘
3. å¼ºåˆ¶å‡1å¤©å¯¼è‡´å³ä½¿åœ¨19:00ä¹Ÿæ— æ³•æ˜¾ç¤ºå½“å¤©æ•°æ®

---

## 2. æ­£ç¡®çš„æ—¶é—´åˆ¤æ–­é€»è¾‘

### å·²æœ‰çš„æ­£ç¡®å®ç°

**æ–‡ä»¶**: `src/lib/enhanced-trading-calendar.ts`
**å‡½æ•°**: `get7TradingDaysFromCalendar()` (lines 242-355)
**æ­£ç¡®é€»è¾‘**:

```typescript
// v4.8.9æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦åº”è¯¥åŒ…å«å½“å¤©ï¼ˆ17:00ä¹‹åä¸”æ˜¯äº¤æ˜“æ—¥ï¼‰
const now = new Date();
const currentHour = now.getHours();
const isToday = now.toISOString().split('T')[0] === endDate;
const shouldIncludeToday = isToday && currentHour >= 17;

if (!shouldIncludeToday) {
  currentDate.setDate(currentDate.getDate() - 1); // ä»å‰ä¸€å¤©å¼€å§‹
} else {
  // åŒ…å«å½“å¤©
}
```

**è¿™ä¸ªé€»è¾‘å·²ç»å®Œç¾å¤„ç†äº†æ—¶é—´åˆ¤æ–­ï¼**

---

## 3. åŒé‡å‡å¤©é—®é¢˜

### å½“å‰é”™è¯¯æµç¨‹ (10æœˆ13æ—¥ 19:00)

```
å‰ç«¯ getTodayString():
  new Date() = 2025-10-13
  date.setDate(date.getDate() - 1)  // ç¬¬ä¸€æ¬¡å‡1å¤©
  è¿”å›: "2025-10-12"

API get7TradingDaysFromCalendar(endDate="2025-10-12"):
  ç°åœ¨æ—¶é—´: 19:00 >= 17:00
  isToday: false (å› ä¸ºendDateæ˜¯10-12ï¼Œä»Šå¤©æ˜¯10-13)
  shouldIncludeToday: false
  ä»10-11å¼€å§‹æŸ¥æ‰¾  // ç¬¬äºŒæ¬¡å‡1å¤©ï¼ˆå®é™…ä¸Šï¼‰
  è¿”å›: [10-05, 10-06, 10-07, 10-08, 10-09, 10-10, 10-11, 10-12]
          ^                                              ^
          æœ€æ—©                                            æœ€æ–°
```

**ç»“æœ**: ç”¨æˆ·çœ‹åˆ°çš„æœ€æ–°æ•°æ®æ˜¯10æœˆ12æ—¥

### æ­£ç¡®æµç¨‹ (10æœˆ13æ—¥ 19:00)

```
å‰ç«¯ getTodayString():
  new Date() = 2025-10-13
  // ä¸å‡å¤©
  è¿”å›: "2025-10-13"  âœ…

API get7TradingDaysFromCalendar(endDate="2025-10-13"):
  ç°åœ¨æ—¶é—´: 19:00 >= 17:00  âœ…
  isToday: true (endDateæ˜¯10-13ï¼Œä»Šå¤©ä¹Ÿæ˜¯10-13)  âœ…
  shouldIncludeToday: true  âœ…
  ä»10-13å¼€å§‹æŸ¥æ‰¾
  è¿”å›: [10-06, 10-07, 10-08, 10-09, 10-10, 10-11, 10-12, 10-13]
          ^                                                    ^
          æœ€æ—©                                                  æœ€æ–°
```

**ç»“æœ**: ç”¨æˆ·çœ‹åˆ°çš„æœ€æ–°æ•°æ®æ˜¯10æœˆ13æ—¥ âœ…

---

## 4. ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¿®æ”¹ getTodayString() (æ¨è)

**ä¿®æ”¹æ–‡ä»¶**: `src/lib/utils.ts`
**ä¿®æ”¹ä½ç½®**: lines 273-277

**ä¿®æ”¹å‰**:
```typescript
export function getTodayString(): string {
  const date = new Date();
  date.setDate(date.getDate() - 1); // ä½¿ç”¨æ˜¨å¤©æ—¥æœŸï¼Œé¿å…å½“å¤©æˆ–å‡æœŸæ— æ•°æ®
  return date.toISOString().split('T')[0];
}
```

**ä¿®æ”¹å**:
```typescript
export function getTodayString(): string {
  const date = new Date();
  // ç›´æ¥è¿”å›ä»Šå¤©çš„æ—¥æœŸ
  // äº¤æ˜“æ—¥åˆ¤æ–­å’Œ17:00é€»è¾‘ç”± get7TradingDaysFromCalendar() å¤„ç†
  return date.toISOString().split('T')[0];
}
```

**æ”¹åŠ¨**: åˆ é™¤ `date.setDate(date.getDate() - 1);` è¿™ä¸€è¡Œ

---

## 5. ä¸ºä»€ä¹ˆè¿™æ ·ä¿®å¤æ˜¯æ­£ç¡®çš„ï¼Ÿ

### æ—¶é—´é€»è¾‘å®Œæ•´æ€§éªŒè¯

#### åœºæ™¯1: äº¤æ˜“æ—¥ 17:00 ä¹‹å‰
```
æ—¶é—´: 10æœˆ13æ—¥ 16:00
getTodayString(): "2025-10-13"
APIåˆ¤æ–­: currentHour=16 < 17
shouldIncludeToday: false
è¿”å›7å¤©: [10-06, 10-07, 10-08, 10-09, 10-10, 10-11, 10-12]
æœ€æ–°æ—¥æœŸ: 10-12 âœ… (æ­£ç¡®ï¼Œæ”¶ç›˜å‰ä¸æ˜¾ç¤ºå½“å¤©)
```

#### åœºæ™¯2: äº¤æ˜“æ—¥ 17:00 ä¹‹å (å½“å‰åœºæ™¯)
```
æ—¶é—´: 10æœˆ13æ—¥ 19:00  â† å½“å‰æƒ…å†µ
getTodayString(): "2025-10-13"
APIåˆ¤æ–­: currentHour=19 >= 17
shouldIncludeToday: true
è¿”å›7å¤©: [10-06, 10-07, 10-08, 10-09, 10-10, 10-11, 10-12, 10-13]
æœ€æ–°æ—¥æœŸ: 10-13 âœ… (æ­£ç¡®ï¼Œæ”¶ç›˜åæ˜¾ç¤ºå½“å¤©)
```

#### åœºæ™¯3: éäº¤æ˜“æ—¥ (å¦‚å‘¨å…­)
```
æ—¶é—´: 10æœˆ14æ—¥ (å‘¨å…­) 10:00
getTodayString(): "2025-10-14"
APIåˆ¤æ–­:
  - æŸ¥è¯¢äº¤æ˜“æ—¥å†
  - 10-14ä¸æ˜¯äº¤æ˜“æ—¥
  - ä»10-13å¼€å§‹å‘å‰æŸ¥æ‰¾
è¿”å›7å¤©: [10-06, 10-07, 10-08, 10-09, 10-10, 10-11, 10-12, 10-13]
æœ€æ–°æ—¥æœŸ: 10-13 âœ… (æ­£ç¡®ï¼Œå‘¨æœ«æ˜¾ç¤ºæœ€è¿‘äº¤æ˜“æ—¥)
```

#### åœºæ™¯4: èŠ‚å‡æ—¥ (å¦‚å›½åº†)
```
æ—¶é—´: 10æœˆ2æ—¥ (å›½åº†) 20:00
getTodayString(): "2025-10-02"
APIåˆ¤æ–­:
  - æŸ¥è¯¢äº¤æ˜“æ—¥å† (Tushare trade_cal API)
  - 10-02ä¸æ˜¯äº¤æ˜“æ—¥ï¼ˆèŠ‚å‡æ—¥ï¼‰
  - ä»10-01å¼€å§‹å‘å‰æŸ¥æ‰¾
è¿”å›7å¤©: èŠ‚å‰æœ€å7ä¸ªäº¤æ˜“æ—¥
æœ€æ–°æ—¥æœŸ: èŠ‚å‰æœ€åä¸€ä¸ªäº¤æ˜“æ—¥ âœ… (æ­£ç¡®ï¼ŒèŠ‚å‡æ—¥æ˜¾ç¤ºèŠ‚å‰æ•°æ®)
```

**ç»“è®º**: æ‰€æœ‰åœºæ™¯éƒ½èƒ½æ­£ç¡®å¤„ç†ï¼ âœ…

---

## 6. å½±å“åˆ†æ

### ä¿®å¤åçš„å½±å“

#### ç§¯æå½±å“ âœ…
1. **æ•°æ®åŠæ—¶æ€§æå‡**: 17:00åç«‹å³æ˜¾ç¤ºå½“å¤©æ•°æ®
2. **é€»è¾‘ä¸€è‡´æ€§**: æ—¶é—´åˆ¤æ–­ç»Ÿä¸€ç”±äº¤æ˜“æ—¥å†æ¨¡å—å¤„ç†
3. **ä»£ç ç®€æ´æ€§**: æ¶ˆé™¤å†—ä½™çš„æ—¥æœŸå‡æ³•
4. **ç”¨æˆ·ä½“éªŒ**: å½“å¤©19:00èƒ½çœ‹åˆ°å½“å¤©æ•°æ®

#### æ— è´Ÿé¢å½±å“ âœ…
1. **17:00å‰**: è‡ªåŠ¨æ’é™¤å½“å¤©ï¼ˆäº¤æ˜“æ—¥å†é€»è¾‘ï¼‰
2. **å‘¨æœ«/èŠ‚å‡æ—¥**: è‡ªåŠ¨æ˜¾ç¤ºæœ€è¿‘äº¤æ˜“æ—¥ï¼ˆäº¤æ˜“æ—¥å†é€»è¾‘ï¼‰
3. **ç¼“å­˜**: ä¸å½±å“ç¼“å­˜æœºåˆ¶ï¼ˆ5åˆ†é’Ÿç¼“å­˜ï¼‰
4. **APIé¢‘ç‡**: ä¸å¢åŠ APIè°ƒç”¨æ¬¡æ•°

---

## 7. æµ‹è¯•éªŒè¯æ¸…å•

### ä¿®å¤å‰æµ‹è¯•
- [ ] è®¿é—®ç½‘ç«™ï¼Œè®°å½•æ˜¾ç¤ºçš„æœ€æ–°æ—¥æœŸ
- [ ] æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· > Network
- [ ] æŸ¥çœ‹ `/api/stocks?mode=7days` è¯·æ±‚
- [ ] è®°å½•è¯·æ±‚URLä¸­çš„dateå‚æ•°
- [ ] è®°å½•è¿”å›çš„datesæ•°ç»„

### ä¿®å¤åæµ‹è¯•
- [ ] æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- [ ] å¼ºåˆ¶åˆ·æ–° (Ctrl+Shift+R)
- [ ] æŸ¥çœ‹æœ€æ–°æ—¥æœŸæ˜¯å¦ä¸º10æœˆ13æ—¥
- [ ] æ£€æŸ¥Networkè¯·æ±‚çš„dateå‚æ•°
- [ ] ç¡®è®¤è¿”å›çš„datesæ•°ç»„åŒ…å«10-13

### åœºæ™¯æµ‹è¯•
- [ ] **17:00åè®¿é—®**: åº”æ˜¾ç¤ºå½“å¤©
- [ ] **17:00å‰è®¿é—®**: åº”æ˜¾ç¤ºå‰ä¸€äº¤æ˜“æ—¥
- [ ] **å‘¨æœ«è®¿é—®**: åº”æ˜¾ç¤ºå‘¨äº”æ•°æ®
- [ ] **èŠ‚å‡æ—¥è®¿é—®**: åº”æ˜¾ç¤ºèŠ‚å‰æœ€åäº¤æ˜“æ—¥

---

## 8. éƒ¨ç½²æ­¥éª¤

### å¼€å‘ç¯å¢ƒæµ‹è¯•
```bash
# 1. ä¿®æ”¹ä»£ç 
vim src/lib/utils.ts

# 2. é‡å¯å¼€å‘æœåŠ¡å™¨
npm run dev

# 3. æµ‹è¯•
curl http://localhost:3000/api/stocks?date=2025-10-13&mode=7days

# 4. æ£€æŸ¥è¿”å›çš„datesæ•°ç»„
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```bash
# 1. Gitæäº¤
git add src/lib/utils.ts
git commit -m "fix: ä¿®å¤getTodayStringå¼ºåˆ¶å‡1å¤©å¯¼è‡´æ•°æ®å»¶è¿Ÿé—®é¢˜"

# 2. æ¨é€
git push origin main

# 3. æœåŠ¡å™¨éƒ¨ç½²
cd /www/wwwroot/stock-tracker
git pull origin main
docker compose down
docker compose build --no-cache
docker compose up -d

# 4. ç­‰å¾…å¯åŠ¨
sleep 30

# 5. éªŒè¯
curl http://localhost:3002/api/stocks?date=$(date +%Y-%m-%d)&mode=7days | jq '.dates'
```

---

## 9. å›æ»šæ–¹æ¡ˆ

å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜ï¼Œå›æ»šæ­¥éª¤ï¼š

```bash
# æ–¹å¼1: Gitå›æ»š
git revert HEAD
git push origin main
cd /www/wwwroot/stock-tracker && git pull origin main && docker compose restart

# æ–¹å¼2: æ‰‹åŠ¨æ¢å¤ä»£ç 
# åœ¨ src/lib/utils.ts getTodayString() ä¸­æ¢å¤:
# date.setDate(date.getDate() - 1);
```

---

## 10. ç›¸å…³ä»£ç ä½ç½®

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
- `src/lib/utils.ts` (line 273-277)

### ç›¸å…³é€»è¾‘æ–‡ä»¶ (ä¸éœ€è¦ä¿®æ”¹)
- `src/lib/enhanced-trading-calendar.ts` (lines 242-355) - 17:00é€»è¾‘ âœ…
- `src/app/api/stocks/route.ts` (line 752-923) - 7å¤©æ•°æ®API âœ…
- `src/app/page.tsx` (line 60-81) - å‰ç«¯è°ƒç”¨ âœ…

---

## 11. æŠ€æœ¯è§£é‡Š

### ä¸ºä»€ä¹ˆåŸæ¥è¦å‡1å¤©ï¼Ÿ

**å¯èƒ½çš„å†å²åŸå› **:
1. æœ€åˆæ²¡æœ‰äº¤æ˜“æ—¥å†APIï¼Œæ‹…å¿ƒå½“å¤©æ•°æ®ä¸å…¨
2. æ•°æ®æºæœ‰å»¶è¿Ÿï¼Œä¿å®ˆèµ·è§ä½¿ç”¨æ˜¨å¤©
3. ç®€åŒ–é€»è¾‘ï¼Œé¿å…å¤„ç†æ—¶é—´åˆ¤æ–­

**ä¸ºä»€ä¹ˆç°åœ¨å¯ä»¥å»æ‰ï¼Ÿ**:
1. âœ… v4.8.9å·²é›†æˆTushare trade_cal APIï¼ˆçœŸå®äº¤æ˜“æ—¥å†ï¼‰
2. âœ… v4.8.9å·²å®ç°17:00æ—¶é—´åˆ¤æ–­é€»è¾‘
3. âœ… v4.8.10ä¿®å¤äº†èŠ‚å‡æ—¥åˆ¤æ–­
4. âœ… æœ‰å®Œå–„çš„ç¼“å­˜å’Œé™çº§ç­–ç•¥

### 17:00çš„é€‰æ‹©

**ä¸ºä»€ä¹ˆé€‰æ‹©17:00ä½œä¸ºåˆ†ç•Œç‚¹ï¼Ÿ**
- Aè‚¡æ”¶ç›˜æ—¶é—´: 15:00
- æ•°æ®æ¸…ç®—æ—¶é—´: 15:00-15:30
- æ•°æ®åŒæ­¥æ—¶é—´: 15:30-16:30
- å®‰å…¨ä½™é‡: 16:30-17:00
- **17:00åæ•°æ®100%å®Œæ•´** âœ…

---

## 12. æ€»ç»“

### é—®é¢˜æœ¬è´¨
`getTodayString()` çš„å¼ºåˆ¶å‡1å¤©é€»è¾‘ä¸ `get7TradingDaysFromCalendar()` çš„17:00é€»è¾‘å†²çªï¼Œå¯¼è‡´åŒé‡å‡å¤©ã€‚

### è§£å†³æ–¹æ¡ˆ
åˆ é™¤ `getTodayString()` ä¸­çš„ `date.setDate(date.getDate() - 1);`ï¼Œè®©æ—¶é—´åˆ¤æ–­å®Œå…¨ç”±äº¤æ˜“æ—¥å†æ¨¡å—å¤„ç†ã€‚

### é¢„æœŸæ•ˆæœ
10æœˆ13æ—¥19:00è®¿é—®ç½‘ç«™ï¼Œèƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤º10æœˆ13æ—¥çš„æ•°æ®ã€‚

---

**è¯Šæ–­å®Œæˆ**: 2025-10-13
**é—®é¢˜å®šä½**: âœ… å·²ç¡®è®¤
**ä¿®å¤æ–¹æ¡ˆ**: âœ… å·²åˆ¶å®š
**é£é™©è¯„ä¼°**: ğŸŸ¢ ä½é£é™©ï¼ˆäº¤æ˜“æ—¥å†é€»è¾‘å·²å®Œå–„ï¼‰
**å»ºè®®**: ç«‹å³ä¿®å¤å¹¶éƒ¨ç½²
