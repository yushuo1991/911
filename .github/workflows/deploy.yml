name: è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸš€ SSH éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            echo "ğŸ“ è¿›å…¥é¡¹ç›®ç›®å½•"
            cd /www/wwwroot/stock-tracker
            
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç "
            git stash
            git pull origin main
            
            echo "ğŸ” æŸ¥çœ‹æœ€æ–°æäº¤"
            git log -1 --oneline
            
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨"
            docker compose down
            
            echo "ğŸ”¨ é‡æ–°æ„å»ºé•œåƒ"
            docker compose build
            
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨"
            docker compose up -d
            
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 20
            
            echo "âœ… æ£€æŸ¥å®¹å™¨çŠ¶æ€"
            docker compose ps
            
            echo "ğŸ§ª æµ‹è¯•æœåŠ¡"
            curl -I http://localhost:3002
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼è®¿é—® http://bk.yushuo.click"

      - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: http://bk.yushuo.click"
          
      - name: âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
