# 🚀 GitHub自动同步部署 - 详细操作步骤

**⏰ 预计完成时间**: 15-20分钟
**🎯 目标**: 实现代码推送到GitHub后自动部署到服务器

---

## 📋 准备工作检查

在开始之前，确认以下条件：
- ✅ 服务器IP: `107.173.154.147`
- ✅ 域名: `bk.yushuo.click`
- ✅ 宝塔面板已安装
- ✅ Docker已安装
- ✅ SSH可以连接服务器

---

## 第一步：上传文件到服务器 (5分钟)

### 1.1 打包所有文件
```bash
# 在本地执行，创建部署包
cd C:\Users\yushu\Desktop\stock-tracker
```

### 1.2 通过宝塔面板上传文件

**操作路径**: 宝塔面板 → 文件 → `/www/wwwroot/stock-tracker/`

**需要上传的关键文件**:
```
✅ .github/workflows/deploy.yml    # GitHub Actions配置
✅ ssh-setup.sh                    # SSH配置脚本
✅ server-sync.sh                  # 服务器同步脚本
✅ docker-debug.sh                 # 诊断脚本
✅ docker-fix.sh                   # 修复脚本
✅ Dockerfile                      # Docker配置
✅ .env.production                 # 环境变量
✅ log/                           # 日志目录
✅ 所有源码文件                    # src/, pages/, components/ 等
```

**具体操作**:
1. 登录宝塔面板: `http://107.173.154.147:8888`
2. 点击 **文件** 菜单
3. 进入目录 `/www/wwwroot/stock-tracker/`
4. 点击 **上传** 按钮
5. 选择所有文件上传（或先打包成zip再上传）

---

## 第二步：配置SSH密钥 (5分钟)

### 2.1 通过宝塔终端配置SSH

**方法一：宝塔面板终端**
1. 宝塔面板 → **终端**
2. 执行以下命令：

```bash
# 进入项目目录
cd /www/wwwroot/stock-tracker

# 给脚本执行权限
chmod +x ssh-setup.sh
chmod +x server-sync.sh
chmod +x docker-debug.sh
chmod +x docker-fix.sh

# 执行SSH配置（一键配置）
./ssh-setup.sh auto
```

**方法二：SSH连接服务器**
```bash
# 从你的电脑连接服务器
ssh root@107.173.154.147

# 然后执行相同的命令
cd /www/wwwroot/stock-tracker
chmod +x *.sh
./ssh-setup.sh auto
```

### 2.2 复制SSH私钥
执行ssh-setup.sh后，会显示私钥内容，**完整复制**保存到记事本：

```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAA...
(这里是完整的私钥内容，很长一段)
...
-----END OPENSSH PRIVATE KEY-----
```

**⚠️ 重要**: 必须包含BEGIN和END行，完整复制！

---

## 第三步：创建GitHub仓库 (3分钟)

### 3.1 创建新仓库
1. 访问 [GitHub.com](https://github.com)
2. 点击右上角 **+** → **New repository**
3. 填写信息：
   - **Repository name**: `stock-tracker`
   - **Description**: `股票追踪应用 - 自动部署版本`
   - 选择 **Public** 或 **Private**
   - ❌ **不要**勾选 "Add a README file"

4. 点击 **Create repository**

### 3.2 推送代码到GitHub
在本地项目目录执行：

```bash
# 初始化git（如果还没有）
cd C:\Users\yushu\Desktop\stock-tracker
git init

# 添加远程仓库（替换your-username为你的GitHub用户名）
git remote add origin https://github.com/your-username/stock-tracker.git

# 添加所有文件
git add .

# 创建第一个提交
git commit -m "🚀 初始提交: 配置GitHub自动部署"

# 推送到GitHub
git branch -M main
git push -u origin main
```

**如果推送失败**，可能需要GitHub Token：
1. GitHub → Settings → Developer settings → Personal access tokens
2. Generate new token，选择repo权限
3. 推送时用户名输入GitHub用户名，密码输入Token

---

## 第四步：配置GitHub Secrets (3分钟)

### 4.1 进入Secrets配置页面
1. GitHub仓库页面 → **Settings**
2. 左侧菜单 → **Secrets and variables** → **Actions**
3. 点击 **New repository secret**

### 4.2 添加三个Secrets

**Secrets 1: SERVER_HOST**
- Name: `SERVER_HOST`
- Value: `107.173.154.147`
- 点击 **Add secret**

**Secrets 2: SERVER_USER**
- Name: `SERVER_USER`
- Value: `root`
- 点击 **Add secret**

**Secrets 3: SERVER_SSH_KEY**
- Name: `SERVER_SSH_KEY`
- Value: 前面复制的SSH私钥内容（包含BEGIN和END行）
- 点击 **Add secret**

**完成后应该看到3个绿色的Secrets**:
- ✅ SERVER_HOST
- ✅ SERVER_USER
- ✅ SERVER_SSH_KEY

---

## 第五步：测试自动部署 (5分钟)

### 5.1 触发首次部署
修改任意文件并推送：

```bash
# 在本地项目目录
cd C:\Users\yushu\Desktop\stock-tracker

# 修改一个文件（添加注释或空行）
echo "# GitHub自动部署测试" >> README.md

# 提交并推送
git add .
git commit -m "🧪 测试: 首次自动部署"
git push origin main
```

### 5.2 查看部署状态
1. **GitHub Actions页面**:
   - 仓库首页 → **Actions** 标签
   - 看到 "GitHub自动同步到宝塔服务器" 工作流
   - 点击进入查看详细日志

2. **预期状态**:
   - ✅ 检出代码 (绿色✓)
   - ✅ 部署到宝塔服务器 (绿色✓)
   - ⏱️ 整个流程约3-5分钟

### 5.3 验证部署结果
**方法一：访问网站**
- 浏览器访问: `http://bk.yushuo.click`
- 应该看到股票追踪应用界面

**方法二：检查服务器**
```bash
# SSH连接服务器检查
ssh root@107.173.154.147

# 查看容器状态
docker ps | grep stock-tracker

# 测试内部连接
curl -I http://127.0.0.1:3000
```

**方法三：宝塔面板检查**
- 宝塔面板 → Docker → 容器管理
- 找到 `stock-tracker-app` 容器
- 状态应该是 **运行中**

---

## 第六步：故障排查 (如果需要)

### 6.1 GitHub Actions失败
**症状**: Actions页面显示红色❌

**排查步骤**:
1. 点击失败的工作流 → 查看错误日志
2. 常见问题：
   - SSH连接失败 → 检查Secrets配置
   - Docker构建失败 → 检查Dockerfile语法
   - 权限问题 → 检查服务器文件权限

### 6.2 网站502错误
**症状**: 访问 `http://bk.yushuo.click` 显示502错误

**排查步骤**:
```bash
# 在服务器执行诊断
cd /www/wwwroot/stock-tracker
./docker-debug.sh

# 如果需要修复
./docker-fix.sh
```

### 6.3 容器启动失败
**症状**: Docker容器不在运行状态

**排查步骤**:
```bash
# 查看容器日志
docker logs stock-tracker-app

# 手动重启容器
docker restart stock-tracker-app

# 重新构建镜像
cd /www/wwwroot/stock-tracker
docker build -t stock-tracker:latest .
```

---

## ✅ 验收标准

完成配置后，应该达到以下效果：

### 自动部署验收
- [ ] GitHub提交代码后，Actions自动执行
- [ ] 3-5分钟后部署完成（绿色✓）
- [ ] 网站 `http://bk.yushuo.click` 可正常访问
- [ ] API `http://bk.yushuo.click/api/stocks` 有响应
- [ ] 宝塔面板Docker显示容器运行中

### 日志验收
- [ ] `/www/wwwroot/stock-tracker/log/deploy.log` 有部署记录
- [ ] GitHub Actions日志显示所有步骤成功
- [ ] 容器日志无报错信息

---

## 🎉 大功告成！

现在你的Stock Tracker应用已经实现了：
- 🔄 **代码自动同步**: 推送到GitHub自动部署
- 🐳 **Docker容器化**: 稳定的运行环境
- 📊 **完整监控**: 详细的部署和运行日志
- 🛠️ **故障自愈**: 自动重启和健康检查

**每次更新代码只需要**:
```bash
git add .
git commit -m "✨ 新功能描述"
git push origin main
```

然后等待3-5分钟，更新就会自动部署到服务器！🚀