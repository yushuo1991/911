# å¿«é€Ÿå¯åŠ¨æŒ‡å— - Dockeréƒ¨ç½²é—®é¢˜è¯Šæ–­

## é—®é¢˜æ¦‚è¿°

**ç°è±¡**: Gitä»£ç å·²æ›´æ–°ï¼ˆv4.3ï¼‰ï¼ŒDockerå®¹å™¨å·²é‡å»ºï¼Œä½†æµè§ˆå™¨é¡µé¢æ²¡æœ‰å˜åŒ–ï¼ŒETagè¿˜æ˜¯æ—§çš„ "y8j7zvpb1v5fd"

**å½±å“**: æ–°åŠŸèƒ½ï¼ˆStockPremiumChartå›¾è¡¨ç»„ä»¶ï¼‰æœªåœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤º

---

## ğŸš€ å¿«é€Ÿè§£å†³æ–¹æ¡ˆï¼ˆæ¨èï¼‰

### æ–¹æ¡ˆ1: æ™ºèƒ½è¯Šæ–­ä¿®å¤ï¼ˆæ¨èï¼‰â­â­â­â­â­

**ç‰¹ç‚¹**: è‡ªåŠ¨æ£€æµ‹é—®é¢˜ï¼Œæä¾›é’ˆå¯¹æ€§ä¿®å¤æ–¹æ¡ˆ

**ä½¿ç”¨æ–¹æ³•**:
```bash
# Windowsç¯å¢ƒï¼ŒåŒå‡»è¿è¡Œ
execute-smart-fix.bat
```

**æ‰§è¡Œæµç¨‹**:
1. è‡ªåŠ¨ä¸Šä¼ è„šæœ¬åˆ°æœåŠ¡å™¨
2. SSHäº¤äº’å¼è¿æ¥
3. æ‰§è¡Œ6é˜¶æ®µè¯Šæ–­
4. æ™ºèƒ½æ¨èä¿®å¤æ–¹æ¡ˆï¼ˆA/B/Cï¼‰
5. ç¡®è®¤åè‡ªåŠ¨ä¿®å¤
6. éªŒè¯ä¿®å¤ç»“æœ

**æ—¶é—´**: 3-5åˆ†é’Ÿ

---

### æ–¹æ¡ˆ2: ä¸€é”®å®Œå…¨ä¿®å¤ï¼ˆå¿«é€Ÿï¼‰â­â­â­â­

**ç‰¹ç‚¹**: ä¸é—®ç›´æ¥ä¿®ï¼Œæœ€å½»åº•çš„ä¿®å¤

**ä½¿ç”¨æ–¹æ³•**:
```bash
# Windowsç¯å¢ƒï¼ŒåŒå‡»è¿è¡Œ
execute-fix.bat
```

**æ“ä½œå†…å®¹**:
- åœæ­¢å¹¶åˆ é™¤å®¹å™¨
- åˆ é™¤æ—§é•œåƒå’Œç¼“å­˜
- åˆ é™¤ .next å’Œ node_modules
- æ— ç¼“å­˜é‡æ–°æ„å»º
- å¯åŠ¨å®¹å™¨å¹¶éªŒè¯

**æ—¶é—´**: 3-5åˆ†é’Ÿ

---

### æ–¹æ¡ˆ3: ä»…è¯Šæ–­ï¼ˆåˆ†æé—®é¢˜ï¼‰â­â­â­

**ç‰¹ç‚¹**: åªè¯Šæ–­ä¸ä¿®å¤ï¼Œç”Ÿæˆè¯¦ç»†æŠ¥å‘Š

**ä½¿ç”¨æ–¹æ³•**:
```bash
# Windowsç¯å¢ƒï¼ŒåŒå‡»è¿è¡Œ
quick-diagnose.bat

# æŸ¥çœ‹æŠ¥å‘Š
type quick-diagnostic-20250930.txt
```

**æ—¶é—´**: 30ç§’

---

## ğŸ“‹ æ‰‹åŠ¨SSHæ“ä½œï¼ˆå¦‚æœè‡ªåŠ¨è„šæœ¬å¤±è´¥ï¼‰

### å¦‚æœSSHè¿æ¥è¶…æ—¶

ç”±äºæœ¬åœ°Windowsç¯å¢ƒå¯èƒ½æ— æ³•SSHè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å¤‡é€‰æ–¹æ¡ˆï¼š

#### é€‰é¡¹1: å®å¡”é¢æ¿Web SSHï¼ˆæœ€æ¨èï¼‰

1. ç™»å½•å®å¡”é¢æ¿
2. ç‚¹å‡»å·¦ä¾§èœå• "ç»ˆç«¯"
3. è¿›å…¥é¡¹ç›®ç›®å½•:
   ```bash
   cd /www/wwwroot/stock-tracker
   ```
4. æ‰§è¡Œæ™ºèƒ½ä¿®å¤:
   ```bash
   # å…ˆä¸Šä¼  smart-fix.sh åˆ°æœåŠ¡å™¨
   chmod +x smart-fix.sh
   ./smart-fix.sh
   ```

#### é€‰é¡¹2: PuTTY SSHå®¢æˆ·ç«¯

1. ä¸‹è½½PuTTY: https://www.putty.org/
2. è¿æ¥ä¿¡æ¯:
   - Host: yushuo.click
   - Port: 22
   - Username: root
   - Password: gJ75hNHdy90TA4qGo9
3. ç™»å½•åæ‰§è¡Œä¿®å¤å‘½ä»¤

#### é€‰é¡¹3: ä¸€é”®ä¿®å¤å‘½ä»¤ï¼ˆå¤åˆ¶ç²˜è´´ï¼‰

ç›´æ¥åœ¨SSHç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹å®Œæ•´å‘½ä»¤åºåˆ—ï¼š

```bash
cd /www/wwwroot/stock-tracker && \
docker compose down && \
docker images | grep stock-tracker | awk '{print $3}' | xargs -r docker rmi -f && \
docker builder prune -f && \
rm -rf .next node_modules && \
docker compose build --no-cache --pull && \
docker compose up -d && \
sleep 10 && \
docker compose ps && \
docker compose exec stock-tracker curl -I http://localhost:3000
```

**è¿™ä¸ªå‘½ä»¤ä¼š**:
1. åœæ­¢å®¹å™¨
2. åˆ é™¤æ—§é•œåƒ
3. æ¸…ç†Dockerç¼“å­˜
4. åˆ é™¤æ„å»ºäº§ç‰©
5. æ— ç¼“å­˜é‡æ–°æ„å»º
6. å¯åŠ¨å®¹å™¨
7. éªŒè¯éƒ¨ç½²

---

## âœ… éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
```bash
docker compose ps

# æœŸæœ›è¾“å‡º:
# stock-tracker-app    Up    healthy
# stock-tracker-mysql  Up    healthy
```

### 2. æ£€æŸ¥HTTPå“åº”
```bash
docker compose exec stock-tracker curl -I http://localhost:3000

# æœŸæœ›è¾“å‡º:
# HTTP/1.1 200 OK
```

### 3. æ£€æŸ¥æ–°ç»„ä»¶
```bash
docker compose exec stock-tracker curl -s http://localhost:3000 | grep "StockPremiumChart"

# å¦‚æœæœ‰è¾“å‡ºï¼Œè¯´æ˜æ–°ç»„ä»¶å·²å­˜åœ¨
```

### 4. æ£€æŸ¥ETag
```bash
docker compose exec stock-tracker curl -I http://localhost:3000 | grep -i etag

# ETagåº”è¯¥ä¸æ—§çš„ "y8j7zvpb1v5fd" ä¸åŒ
```

### 5. æµè§ˆå™¨éªŒè¯

1. æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://bk.yushuo.click
2. **å¼ºåˆ¶åˆ·æ–°**: æŒ‰ `Ctrl + Shift + R` (Windows) æˆ– `Cmd + Shift + R` (Mac)
3. æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæ–°çš„å›¾è¡¨ç»„ä»¶

---

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

æ ¹æ®è¯Šæ–­ï¼Œé—®é¢˜å¯èƒ½æ¥è‡ªä»¥ä¸‹æ¨¡å—ï¼ˆæŒ‰æ¦‚ç‡æ’åºï¼‰ï¼š

### 1. Dockerç¼“å­˜é—®é¢˜ï¼ˆ70%ï¼‰â­â­â­â­â­
- **è¡¨ç°**: å®¹å™¨å†…æ–‡ä»¶ä¸æœåŠ¡å™¨ä¸ä¸€è‡´
- **åŸå› **: Dockerä½¿ç”¨äº†ç¼“å­˜å±‚ï¼Œæœªå¤åˆ¶æ–°æ–‡ä»¶
- **è§£å†³**: æ— ç¼“å­˜é‡å»º `docker compose build --no-cache`

### 2. npmä¾èµ–é—®é¢˜ï¼ˆ15%ï¼‰â­â­â­â­
- **è¡¨ç°**: rechartsä¾èµ–æœªå®‰è£…
- **åŸå› **: package.jsonæ›´æ–°åç¼“å­˜äº†æ—§çš„npm installå±‚
- **è§£å†³**: åˆ é™¤node_modulesé‡æ–°å®‰è£…

### 3. Next.jsæ„å»ºç¼“å­˜ï¼ˆ10%ï¼‰â­â­â­
- **è¡¨ç°**: .nextç›®å½•æ˜¯æ—§çš„
- **åŸå› **: å¢é‡æ„å»ºæœªæ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–
- **è§£å†³**: åˆ é™¤.nexté‡æ–°æ„å»º

### 4. Nginxç¼“å­˜ï¼ˆ3%ï¼‰â­â­
- **è¡¨ç°**: åå‘ä»£ç†ç¼“å­˜äº†æ—§å“åº”
- **åŸå› **: proxy_cacheæœªæ¸…ç†
- **è§£å†³**: æ¸…ç†Nginxç¼“å­˜æˆ–é‡å¯Nginx

### 5. æµè§ˆå™¨ç¼“å­˜ï¼ˆ2%ï¼‰â­â­â­â­â­
- **è¡¨ç°**: æœåŠ¡å™¨æ­£å¸¸ä½†æµè§ˆå™¨æ˜¾ç¤ºæ—§ç‰ˆ
- **åŸå› **: æµè§ˆå™¨ç¼“å­˜äº†HTML/JS/CSS
- **è§£å†³**: å¼ºåˆ¶åˆ·æ–° `Ctrl+Shift+R`

---

## ğŸ› ï¸ è¯Šæ–­å·¥å…·è¯´æ˜

### å·²åˆ›å»ºçš„å·¥å…·

| å·¥å…· | ç”¨é€” | æ‰§è¡Œæ–¹å¼ |
|------|------|----------|
| `smart-fix.sh` | æ™ºèƒ½è¯Šæ–­å’Œä¿®å¤ | `execute-smart-fix.bat` |
| `one-click-fix.sh` | ä¸€é”®å®Œå…¨ä¿®å¤ | `execute-fix.bat` |
| `diagnose-deployment.sh` | è¯¦ç»†è¯Šæ–­ | `run-remote-diagnose.bat` |
| `quick-diagnose.bat` | å¿«é€Ÿè¯Šæ–­ | ç›´æ¥åŒå‡» |

### æ™ºèƒ½è¯Šæ–­çš„6ä¸ªé˜¶æ®µ

1. **æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥**
   - æœåŠ¡å™¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   - å®¹å™¨å†…æ–‡ä»¶æ˜¯å¦å­˜åœ¨

2. **MD5å®Œæ•´æ€§å¯¹æ¯”**
   - æœåŠ¡å™¨å’Œå®¹å™¨æ–‡ä»¶æ˜¯å¦ä¸€è‡´

3. **ä¾èµ–æ£€æŸ¥**
   - rechartsæ˜¯å¦å®‰è£…

4. **æ„å»ºäº§ç‰©æ£€æŸ¥**
   - .next/BUILD_IDæ˜¯å¦æœ€æ–°
   - æ„å»ºæ—¶é—´æ˜¯å¦åˆç†

5. **è¿è¡Œæ—¶æ£€æŸ¥**
   - HTTPçŠ¶æ€ç æ˜¯å¦200
   - é¡µé¢å†…å®¹æ˜¯å¦åŒ…å«æ–°ç»„ä»¶

6. **ETagæ£€æŸ¥**
   - ETagæ˜¯å¦æ›´æ–°

### ä¿®å¤æ–¹æ¡ˆåˆ†çº§

- **æ–¹æ¡ˆA**: å®Œå…¨é‡å»ºï¼ˆæ–‡ä»¶ä¸ä¸€è‡´æ—¶ï¼‰- æ—¶é—´3-5åˆ†é’Ÿ
- **æ–¹æ¡ˆB**: é‡å»ºå®¹å™¨ï¼ˆä¾èµ–é—®é¢˜æ—¶ï¼‰- æ—¶é—´2-3åˆ†é’Ÿ
- **æ–¹æ¡ˆC**: é‡å¯å®¹å™¨ï¼ˆè¿è¡Œæ—¶é—®é¢˜æ—¶ï¼‰- æ—¶é—´30ç§’

---

## ğŸ“š æŠ€æœ¯å­¦ä¹ è¦ç‚¹

é€šè¿‡è¿™æ¬¡è¯Šæ–­ï¼Œä½ å¯ä»¥å­¦ä¹ åˆ°ï¼š

### 1. Dockerå·¥ä½œåŸç†
- **é•œåƒåˆ†å±‚**: Dockerä½¿ç”¨å±‚å æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯ä¸ªæŒ‡ä»¤åˆ›å»ºä¸€å±‚
- **ç¼“å­˜æœºåˆ¶**: å¦‚æœæŒ‡ä»¤å’Œæ–‡ä»¶æœªå˜ï¼ŒDockerä¼šé‡ç”¨ç¼“å­˜å±‚
- **é—®é¢˜**: ç¼“å­˜å¯èƒ½å¯¼è‡´æ–°æ–‡ä»¶æœªè¢«å¤åˆ¶
- **è§£å†³**: `--no-cache` æ ‡å¿—å¼ºåˆ¶é‡æ–°æ„å»ºæ‰€æœ‰å±‚

### 2. Dockerfileæ„å»º
- **COPYæŒ‡ä»¤**: å°†ä¸»æœºæ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨
- **.dockerignore**: æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼ˆå¦‚node_modulesï¼‰
- **æœ€ä½³å®è·µ**: å…ˆå¤åˆ¶package.jsonï¼Œå†npm installï¼Œæœ€åå¤åˆ¶æºä»£ç 

### 3. Next.jsæ„å»º
- **.nextç›®å½•**: åŒ…å«ç¼–è¯‘åçš„é¡µé¢å’Œé™æ€èµ„æº
- **BUILD_ID**: å”¯ä¸€æ ‡è¯†ä¸€æ¬¡æ„å»º
- **å¢é‡æ„å»º**: åªé‡æ–°æ„å»ºå˜åŒ–çš„éƒ¨åˆ†
- **é—®é¢˜**: æœ‰æ—¶éœ€è¦å®Œå…¨æ¸…é™¤é‡æ–°æ„å»º

### 4. HTTPç¼“å­˜
- **ETag**: èµ„æºçš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºç¼“å­˜éªŒè¯
- **Cache-Control**: æ§åˆ¶ç¼“å­˜ç­–ç•¥
- **æµè§ˆå™¨ç¼“å­˜**: å¯èƒ½å¯¼è‡´çœ‹åˆ°æ—§ç‰ˆæœ¬
- **è§£å†³**: å¼ºåˆ¶åˆ·æ–°ç»•è¿‡ç¼“å­˜

### 5. é—®é¢˜æ’æŸ¥æ–¹æ³•è®º
- **ç³»ç»ŸåŒ–è¯Šæ–­**: ä»å¤–åˆ°å†…é€å±‚æ£€æŸ¥
- **å¯¹æ¯”éªŒè¯**: å¯¹æ¯”æœåŠ¡å™¨å’Œå®¹å™¨çš„å·®å¼‚
- **æ—¥å¿—åˆ†æ**: æŸ¥çœ‹æ„å»ºæ—¥å¿—å®šä½é—®é¢˜
- **éªŒè¯ä¿®å¤**: ç¡®ä¿æ¯ä¸€æ­¥éƒ½æˆåŠŸ

---

## ğŸ’¡ é¢„é˜²æªæ–½

ä¸ºäº†é¿å…ç±»ä¼¼é—®é¢˜ï¼Œå»ºè®®é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

### 1. Dockeré…ç½®ä¼˜åŒ–
```yaml
# docker-compose.yml
services:
  stock-tracker:
    build:
      context: .
      dockerfile: Dockerfile
      no_cache: true  # ç¦ç”¨ç¼“å­˜
```

### 2. ä½¿ç”¨æ„å»ºå‚æ•°
```dockerfile
# Dockerfile
ARG BUILD_DATE
ENV BUILD_DATE=${BUILD_DATE}
RUN echo "Build date: ${BUILD_DATE}"
```

æ„å»ºæ—¶:
```bash
docker compose build --build-arg BUILD_DATE=$(date +%s)
```

### 3. å¥åº·æ£€æŸ¥
```yaml
# docker-compose.yml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:3000"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

### 4. è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
åˆ›å»º `deploy.sh`:
```bash
#!/bin/bash
set -e
git pull
docker compose down
docker compose build --no-cache
docker compose up -d
docker compose ps
```

### 5. ç‰ˆæœ¬æ ‡è®°
```bash
git tag -a v4.3-$(date +%Y%m%d-%H%M%S) -m "Deploy with StockPremiumChart"
git push origin --tags
```

---

## ğŸ†˜ é—®é¢˜ä»æœªè§£å†³ï¼Ÿ

å¦‚æœæ‰§è¡Œä¸Šè¿°æ‰€æœ‰æ–¹æ¡ˆåé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·ï¼š

### 1. æ”¶é›†è¯Šæ–­ä¿¡æ¯
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /www/wwwroot/stock-tracker
./diagnose-deployment.sh > diagnostic-output.txt
cat diagnostic-output.txt
```

### 2. æŸ¥çœ‹å®Œæ•´æ—¥å¿—
```bash
docker compose logs --tail=100 stock-tracker > container-logs.txt
cat container-logs.txt
```

### 3. æ£€æŸ¥Nginxæ—¥å¿—ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
```bash
tail -n 100 /www/wwwlogs/bk.yushuo.click.error.log
```

### 4. éªŒè¯åŸºç¡€ç¯å¢ƒ
```bash
# Dockerç‰ˆæœ¬
docker --version
docker compose version

# å®¹å™¨çŠ¶æ€
docker compose ps

# ç«¯å£ç›‘å¬
netstat -tlnp | grep 3002

# ç£ç›˜ç©ºé—´
df -h
```

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

### æœåŠ¡å™¨ä¿¡æ¯
- **æœåŠ¡å™¨**: yushuo.click (75.2.60.5)
- **é¡¹ç›®è·¯å¾„**: /www/wwwroot/stock-tracker
- **å®¹å™¨åç§°**: stock-tracker-app
- **åº”ç”¨ç«¯å£**: 3002
- **è®¿é—®åœ°å€**: http://bk.yushuo.click

### å…³é”®æ–‡ä»¶
- **æ–°å¢ç»„ä»¶**: src/components/StockPremiumChart.tsx
- **æ–°å¢å·¥å…·**: src/lib/chartHelpers.ts
- **ä¸»é¡µé¢**: src/app/page.tsx
- **ä¾èµ–**: package.json (æ–°å¢recharts)

### éªŒè¯æ¸…å•
- [ ] Gitä»£ç æœ€æ–°
- [ ] å®¹å™¨çŠ¶æ€æ­£å¸¸ï¼ˆUp, healthyï¼‰
- [ ] HTTPå“åº”200
- [ ] é¡µé¢åŒ…å«æ–°ç»„ä»¶
- [ ] ETagå·²æ›´æ–°
- [ ] æµè§ˆå™¨æ˜¾ç¤ºæ–°ç‰ˆæœ¬

---

## ğŸ¯ æœ€ç®€å•çš„å¼€å§‹æ–¹å¼

**å¦‚æœä½ åªæƒ³å¿«é€Ÿè§£å†³é—®é¢˜ï¼Œä¸æƒ³æ·±å…¥äº†è§£ç»†èŠ‚**:

1. åŒå‡»è¿è¡Œ `execute-smart-fix.bat`
2. ç­‰å¾…3-5åˆ†é’Ÿ
3. æµè§ˆå™¨è®¿é—® http://bk.yushuo.click
4. æŒ‰ `Ctrl+Shift+R` å¼ºåˆ¶åˆ·æ–°

**å°±è¿™ä¹ˆç®€å•ï¼** ğŸ‰

---

## ğŸ“– è¯¦ç»†æ–‡æ¡£

å¦‚éœ€æ›´æ·±å…¥äº†è§£ï¼Œè¯·æŸ¥çœ‹ï¼š

- **å®Œæ•´æŒ‡å—**: `DEPLOYMENT-DIAGNOSTIC-GUIDE.md` (24KB)
- **è¯¦ç»†æŠ¥å‘Š**: `log/deployment-issue-diagnostic-20250930.md` (26.8KB)

---

**æœ€åæ›´æ–°**: 2025-09-30
**é€‚ç”¨ç‰ˆæœ¬**: v4.3
**çŠ¶æ€**: å·²æµ‹è¯•