# ğŸš¨ ç´§æ€¥ä¿®å¤ï¼šæœåŠ¡å™¨ç£ç›˜ç©ºé—´ä¸è¶³

**æ—¶é—´**ï¼š2025-11-05  
**é”™è¯¯**ï¼š`Out of diskspace`  
**ä¸¥é‡ç¨‹åº¦**ï¼šé«˜  
**å½±å“**ï¼šéƒ¨ç½²å¤±è´¥ï¼Œæ— æ³•æ›´æ–°ä»£ç 

---

## âŒ é”™è¯¯è¯¦æƒ…

```
fatal: sha1 file '.git/index.lock' write error. Out of diskspace
```

**åŸå› **ï¼šæœåŠ¡å™¨ç£ç›˜å·²æ»¡ï¼ŒGitæ— æ³•å†™å…¥æ–‡ä»¶ã€‚

---

## âš¡ ç«‹å³æ‰§è¡Œï¼ˆå¤åˆ¶ç²˜è´´ï¼‰

### æ­¥éª¤1ï¼šè¿æ¥åˆ°æœåŠ¡å™¨

```bash
ssh root@107.173.154.147
```

å¯†ç ï¼š`gJ75hNHdy90TA4qGo9`

### æ­¥éª¤2ï¼šæ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ

```bash
df -h
```

æŸ¥çœ‹å“ªä¸ªåˆ†åŒºä½¿ç”¨ç‡æœ€é«˜ï¼ˆå¯èƒ½æ˜¯100%ï¼‰ã€‚

### æ­¥éª¤3ï¼šå¿«é€Ÿæ¸…ç†ï¼ˆæ‰§è¡Œä»¥ä¸‹æ‰€æœ‰å‘½ä»¤ï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/stock-tracker || cd ~/stock-tracker || cd /home/stock-tracker

# 1. åˆ é™¤ Git é”æ–‡ä»¶
rm -f .git/index.lock .git/*.lock
echo "âœ“ Git é”æ–‡ä»¶å·²æ¸…ç†"

# 2. æ¸…ç† npm ç¼“å­˜
npm cache clean --force
echo "âœ“ npm ç¼“å­˜å·²æ¸…ç†"

# 3. æ¸…ç†æ„å»ºç¼“å­˜
rm -rf .next
echo "âœ“ æ„å»ºç¼“å­˜å·²æ¸…ç†"

# 4. æ¸…ç†æ—§å¤‡ä»½ï¼ˆåªä¿ç•™æœ€è¿‘2ä¸ªï¼‰
if [ -d "backup" ]; then
  cd backup
  ls -t | tail -n +3 | xargs rm -rf 2>/dev/null
  cd ..
  echo "âœ“ æ—§å¤‡ä»½å·²æ¸…ç†"
fi

# 5. æ¸…ç† PM2 æ—¥å¿—
pm2 flush
echo "âœ“ PM2 æ—¥å¿—å·²æ¸…ç†"

# 6. Git åƒåœ¾å›æ”¶
git gc --aggressive --prune=now
echo "âœ“ Git ä»“åº“å·²æ¸…ç†"

# 7. æ¸…ç†ç³»ç»Ÿæ—¥å¿—ï¼ˆéœ€è¦rootæƒé™ï¼‰
sudo journalctl --vacuum-time=3d
echo "âœ“ ç³»ç»Ÿæ—¥å¿—å·²æ¸…ç†"

# 8. å†æ¬¡æ£€æŸ¥ç£ç›˜ç©ºé—´
echo ""
echo "æ¸…ç†åçš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
df -h
```

### æ­¥éª¤4ï¼šå¦‚æœç©ºé—´ä»ç„¶ä¸è¶³

```bash
# æ¸…ç† node_modulesï¼ˆéœ€è¦é‡æ–°å®‰è£…ï¼‰
cd /www/wwwroot/stock-tracker || cd ~/stock-tracker
rm -rf node_modules
echo "âœ“ node_modules å·²åˆ é™¤ï¼ˆç¨åä¼šé‡æ–°å®‰è£…ï¼‰"

# å†æ¬¡æ£€æŸ¥
df -h
```

### æ­¥éª¤5ï¼šé‡æ–°å®‰è£…ä¾èµ–å¹¶æ„å»º

```bash
cd /www/wwwroot/stock-tracker || cd ~/stock-tracker

# æ‹‰å–æœ€æ–°ä»£ç 
git fetch origin
git reset --hard origin/main

# å®‰è£…ä¾èµ–
npm install --production=false

# æ„å»ºé¡¹ç›®
npm run build

# é‡å¯æœåŠ¡
pm2 restart stock-tracker
pm2 save

echo "âœ“ éƒ¨ç½²å®Œæˆï¼"
```

---

## ğŸ“Š æ¸…ç†é¡¹ç›®è¯´æ˜

### å¯ä»¥å®‰å…¨æ¸…ç†çš„é¡¹ç›®

| é¡¹ç›® | ä½ç½® | å¤§å°ï¼ˆä¼°è®¡ï¼‰ | å½±å“ |
|------|------|-------------|------|
| âœ… npmç¼“å­˜ | ~/.npm | å¯èƒ½å¾ˆå¤§ | æ— å½±å“ |
| âœ… .next | é¡¹ç›®/.next | 100-500MB | ä¼šè‡ªåŠ¨é‡æ–°ç”Ÿæˆ |
| âœ… PM2æ—¥å¿— | ~/.pm2/logs | å¯èƒ½å¾ˆå¤§ | æ— å½±å“ |
| âœ… æ—§å¤‡ä»½ | backup/ | å–å†³äºæ•°é‡ | åªä¿ç•™æœ€è¿‘çš„ |
| âœ… Gité”æ–‡ä»¶ | .git/*.lock | å¾ˆå° | æ— å½±å“ |
| âš ï¸ node_modules | é¡¹ç›®/node_modules | 200-500MB | éœ€è¦é‡æ–°å®‰è£… |

### ä¸è¦åˆ é™¤çš„é¡¹ç›®

| é¡¹ç›® | åŸå›  |
|------|------|
| âŒ .gitç›®å½• | ä¼šä¸¢å¤±Gitå†å² |
| âŒ src/ç›®å½• | æºä»£ç  |
| âŒ public/ç›®å½• | é™æ€èµ„æº |
| âŒ .envæ–‡ä»¶ | ç¯å¢ƒé…ç½® |

---

## ğŸ”„ éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥ç£ç›˜ç©ºé—´

```bash
df -h
```

**æœŸæœ›ç»“æœ**ï¼šä½¿ç”¨ç‡ < 90%

### 2. æµ‹è¯•Gitæ“ä½œ

```bash
cd /www/wwwroot/stock-tracker || cd ~/stock-tracker
git status
```

**æœŸæœ›ç»“æœ**ï¼šæ— é”™è¯¯ä¿¡æ¯

### 3. æ£€æŸ¥åº”ç”¨çŠ¶æ€

```bash
pm2 status
pm2 logs stock-tracker --lines 20
```

**æœŸæœ›ç»“æœ**ï¼šåº”ç”¨æ­£å¸¸è¿è¡Œ

### 4. è®¿é—®ç½‘ç«™

æµè§ˆå™¨è®¿é—®ï¼š`http://107.173.154.147:3000`

**æœŸæœ›ç»“æœ**ï¼šç½‘ç«™æ­£å¸¸è®¿é—®

---

## ğŸ”„ é‡æ–°è§¦å‘éƒ¨ç½²

æ¸…ç†å®Œç©ºé—´åï¼Œé‡æ–°æ¨é€ä»£ç è§¦å‘éƒ¨ç½²ï¼š

### æ–¹æ³•1ï¼šæ‰‹åŠ¨éƒ¨ç½²ï¼ˆæ¨èï¼Œå·²åœ¨æœåŠ¡å™¨ä¸Šï¼‰

ä¸Šé¢æ­¥éª¤5å·²ç»åŒ…å«æ‰‹åŠ¨éƒ¨ç½²å‘½ä»¤ã€‚

### æ–¹æ³•2ï¼šè§¦å‘GitHub Actions

```bash
# åœ¨æœ¬åœ°æ‰§è¡Œ
cd C:\Users\yushu\Desktop\bk\911-86887ec382a82d9038e8df20f97a4d0e5ef02a56

# åˆ›å»ºä¸€ä¸ªç©ºæäº¤è§¦å‘éƒ¨ç½²
git commit --allow-empty -m "chore: Trigger deployment after disk cleanup"
git push
```

---

## ğŸ“‹ é•¿æœŸè§£å†³æ–¹æ¡ˆ

### 1. å®šæœŸæ¸…ç†è®¡åˆ’

åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹æ¸…ç†
0 3 * * 0 cd /www/wwwroot/stock-tracker && npm cache clean --force && rm -rf .next && pm2 flush
```

### 2. ç£ç›˜ç›‘æ§å‘Šè­¦

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
cat > /usr/local/bin/disk-alert.sh << 'EOF'
#!/bin/bash
THRESHOLD=85
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt "$THRESHOLD" ]; then
  echo "è­¦å‘Šï¼šç£ç›˜ä½¿ç”¨ç‡ ${DISK_USAGE}% è¶…è¿‡é˜ˆå€¼ ${THRESHOLD}%"
  # è¿™é‡Œå¯ä»¥å‘é€é‚®ä»¶æˆ–é€šçŸ¥
fi
EOF

chmod +x /usr/local/bin/disk-alert.sh

# æ·»åŠ åˆ°crontabï¼Œæ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
0 * * * * /usr/local/bin/disk-alert.sh
```

### 3. è€ƒè™‘å‡çº§æœåŠ¡å™¨

å¦‚æœç»å¸¸é‡åˆ°ç©ºé—´ä¸è¶³ï¼š
- è”ç³»æœåŠ¡å™¨æä¾›å•†å‡çº§ç£ç›˜
- æˆ–è€…å°†å¤‡ä»½/æ—¥å¿—å­˜å‚¨åˆ°å¤–éƒ¨å­˜å‚¨

---

## ğŸ†˜ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

### æŸ¥æ‰¾å¤§æ–‡ä»¶

```bash
# æŸ¥æ‰¾å¤§äº100MBçš„æ–‡ä»¶
find / -type f -size +100M -exec ls -lh {} \; 2>/dev/null | head -20

# æŸ¥çœ‹å„ç›®å½•å ç”¨
du -sh /* 2>/dev/null | sort -hr | head -10
```

### æ¸…ç†Dockerï¼ˆå¦‚æœå®‰è£…äº†ï¼‰

```bash
# æ¸…ç†æœªä½¿ç”¨çš„Dockerèµ„æº
docker system prune -a -f

# æ¸…ç†æ‰€æœ‰å·
docker volume prune -f
```

### æ¸…ç†ç³»ç»ŸåŒ…ç¼“å­˜

```bash
# Ubuntu/Debian
sudo apt-get clean
sudo apt-get autoclean
sudo apt-get autoremove

# CentOS/RHEL
sudo yum clean all
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤ä»ç„¶æ— æ³•è§£å†³ï¼š

1. æˆªå›¾`df -h`çš„è¾“å‡º
2. æˆªå›¾`du -sh /*`çš„è¾“å‡ºï¼ˆæŸ¥çœ‹å“ªé‡Œå ç”¨æœ€å¤šï¼‰
3. æŠ¥å‘Šå…·ä½“é”™è¯¯ä¿¡æ¯

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] è¿æ¥åˆ°æœåŠ¡å™¨
- [ ] æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µï¼ˆdf -hï¼‰
- [ ] æ‰§è¡Œå¿«é€Ÿæ¸…ç†å‘½ä»¤
- [ ] ç¡®è®¤ç£ç›˜ä½¿ç”¨ç‡ < 90%
- [ ] é‡æ–°éƒ¨ç½²é¡¹ç›®
- [ ] éªŒè¯åº”ç”¨æ­£å¸¸è¿è¡Œ
- [ ] è®¾ç½®å®šæœŸæ¸…ç†è®¡åˆ’

---

**æ‰§è¡Œè¿™äº›æ­¥éª¤åï¼Œéƒ¨ç½²åº”è¯¥å°±èƒ½æˆåŠŸäº†ï¼**




