# 股票追踪系统 - 版本管理和备份回滚完整指南

## 📖 目录
- [系统概述](#系统概述)
- [备份策略](#备份策略)
- [日常操作](#日常操作)
- [回滚操作](#回滚操作)
- [最佳实践](#最佳实践)
- [故障处理](#故障处理)
- [维护建议](#维护建议)

---

## 🎯 系统概述

### 项目信息
- **项目名称**: 股票追踪系统
- **域名访问**: https://bk.yushuo.click
- **服务器IP**: 107.173.154.147
- **部署方式**: Docker容器化部署
- **代码仓库**: https://github.com/yushuo1991/911.git

### 技术架构
```
股票追踪系统
├── 前端: Next.js + React + TailwindCSS
├── 后端: Next.js API Routes
├── 数据源: Tushare API
├── 部署: Docker + 宝塔面板
└── 域名: bk.yushuo.click (反向代理)
```

---

## 📦 备份策略

### 三重备份体系

| 备份类型 | 内容 | 优势 | 用途 |
|---------|------|------|------|
| **本地备份** | 代码+环境+配置+镜像 | 最快恢复(30秒) | 日常快速回滚 |
| **Docker备份** | 完整运行环境 | 环境一致性 | 跨服务器迁移 |
| **GitHub备份** | 代码+配置+版本历史 | 云端安全存储 | 远程协作&灾难恢复 |

### 备份内容详情

#### 本地备份 (`./backups/`)
```
backups/v1.0.0-20250923-120000/
├── code/                    # 完整代码快照
├── docker-image.tar         # Docker镜像文件(~720MB)
├── environment-info.txt     # 环境信息记录
└── restore.sh              # 一键还原脚本
```

#### Docker备份
```bash
# 镜像版本标签
stock-tracker:latest         # 当前运行版本
stock-tracker:v1.0.0        # 版本化镜像
stock-tracker:v1.1.0        # 各个历史版本...
```

#### GitHub备份
```bash
# Git标签对应版本
v1.0.0, v1.1.0, v2.0.0...   # 代码版本标签
main分支                      # 最新代码
```

---

## 🚀 日常操作

### 版本管理脚本

**核心命令**: `./version-manager.sh`

#### 1. 查看系统状态
```bash
# 查看当前版本
./version-manager.sh version

# 查看所有版本
./version-manager.sh list

# 查看帮助信息
./version-manager.sh
```

#### 2. 创建新版本备份

**语义化版本控制**:
- **patch** (补丁): 1.0.0 → 1.0.1 (bug修复)
- **minor** (小版本): 1.0.0 → 1.1.0 (新功能)
- **major** (大版本): 1.0.0 → 2.0.0 (重大改动)

```bash
# Bug修复 (1.0.0 → 1.0.1)
./version-manager.sh backup patch "修复股票数据显示问题"

# 新功能 (1.0.0 → 1.1.0)
./version-manager.sh backup minor "添加K线图功能"

# 重大更新 (1.0.0 → 2.0.0)
./version-manager.sh backup major "重构数据处理架构"
```

### 开发工作流程

#### 标准开发流程
```bash
# 1. 开发前备份当前稳定版本
./version-manager.sh backup patch "开发前备份"

# 2. 进行代码开发和修改
# ... 修改代码 ...

# 3. 本地测试
npm run build     # 测试构建
./deploy.sh       # 测试部署

# 4. 访问测试
curl http://127.0.0.1:3000  # 本地测试
# 访问 https://bk.yushuo.click # 线上测试

# 5. 功能确认无误后创建版本
./version-manager.sh backup minor "新功能开发完成"
```

#### 快速修复流程
```bash
# 1. 发现问题，立即回滚
./version-manager.sh restore v1.0.0

# 2. 修复问题
# ... 修改代码 ...

# 3. 快速部署测试
./deploy.sh

# 4. 确认修复后创建补丁版本
./version-manager.sh backup patch "紧急修复生产问题"
```

---

## 🔄 回滚操作

### 回滚策略选择

#### 1. 快速回滚 (推荐，30秒完成)
```bash
# 一键回滚到指定版本
./version-manager.sh restore v1.0.0

# 自动执行：
# - 停止当前容器
# - 恢复代码文件
# - 加载对应Docker镜像
# - 启动新容器
# - 验证服务状态
```

#### 2. Docker镜像回滚 (2分钟完成)
```bash
# 手动使用Docker镜像回滚
docker stop stock-tracker-app
docker rm stock-tracker-app
docker run -d --name stock-tracker-app -p 3000:3000 stock-tracker:v1.0.0
```

#### 3. 从GitHub重建 (10分钟完成)
```bash
# 完全重新部署（灾难恢复）
git checkout v1.0.0
./deploy.sh
```

### 回滚验证检查

每次回滚后必须验证：
```bash
# 1. 检查版本号
cat VERSION

# 2. 检查容器状态
docker ps | grep stock-tracker-app

# 3. 检查服务响应
curl -I http://127.0.0.1:3000

# 4. 检查网站访问
# 浏览器访问: https://bk.yushuo.click

# 5. 检查核心功能
# - 股票数据加载
# - 日期选择功能
# - K线图弹窗
# - 板块分析图表
```

---

## 💡 最佳实践

### 备份时机建议

#### 必须备份的时机
- ✅ **功能开发完成** - 新功能稳定运行后
- ✅ **Bug修复完成** - 问题解决并验证后
- ✅ **版本发布前** - 重要更新部署前
- ✅ **系统配置变更** - 环境配置修改后
- ✅ **定期备份** - 每周至少一次稳定版本

#### 建议备份的时机
- 🔶 **大量代码修改前** - 作为安全备份
- 🔶 **实验性功能开发前** - 方便快速回滚
- 🔶 **服务器维护前** - 预防意外情况
- 🔶 **第三方依赖更新后** - 确保兼容性

### 版本命名规范

#### 描述信息格式
```bash
# 格式：[类型] 简短描述 - 详细说明
./version-manager.sh backup patch "🐛 修复API超时问题 - 增加重试机制和错误处理"
./version-manager.sh backup minor "✨ 新增数据导出功能 - 支持Excel和CSV格式导出"
./version-manager.sh backup major "🚀 升级到Next.js 15 - 重构整体架构提升性能"
```

#### 常用emoji前缀
- 🐛 Bug修复
- ✨ 新功能
- 🚀 重大更新
- 🔧 配置修改
- 📝 文档更新
- 🎨 UI改进
- ⚡ 性能优化
- 🔒 安全修复

### 存储管理

#### 自动清理策略
```bash
# 保留最近10个本地备份，删除旧备份
./version-manager.sh cleanup 10

# 定期清理（建议每月执行）
find backups/ -name "v*" -type d -mtime +30 -exec rm -rf {} \;
```

#### 存储空间监控
```bash
# 查看备份占用空间
du -sh backups/

# 查看Docker镜像占用
docker images stock-tracker --format "table {{.Tag}}\t{{.Size}}"

# 清理无用Docker镜像
docker image prune -f
```

---

## 🚨 故障处理

### 常见问题及解决方案

#### 1. 容器启动失败
```bash
# 问题：回滚后容器无法启动
# 解决：
docker logs stock-tracker-app  # 查看错误日志
docker restart stock-tracker-app  # 重启容器
# 如果仍失败，回滚到更早的稳定版本
./version-manager.sh restore v1.0.0
```

#### 2. 网站访问异常
```bash
# 问题：网站无法访问
# 检查步骤：
docker ps | grep stock-tracker  # 容器是否运行
curl http://127.0.0.1:3000     # 本地是否正常
systemctl status nginx         # 反向代理状态
# 解决：重启相关服务或回滚版本
```

#### 3. 数据加载失败
```bash
# 问题：股票数据无法加载
# 检查：
cat .env.local                 # 环境变量配置
docker logs stock-tracker-app | grep -i error  # API错误日志
# 解决：检查Tushare token或回滚到稳定版本
```

#### 4. GitHub推送失败
```bash
# 问题：备份时GitHub推送失败
# 解决：本地和Docker备份仍然有效，GitHub推送是可选的
# 手动推送：
git push origin main --tags
```

### 灾难恢复流程

#### 完全系统重建
```bash
# 1. 重新克隆项目
cd /www/wwwroot/
git clone https://github.com/yushuo1991/911.git stock-tracker-new
cd stock-tracker-new

# 2. 恢复环境配置
cp /path/to/backup/.env.local .

# 3. 回滚到稳定版本
git checkout v1.0.0

# 4. 重新部署
./deploy.sh

# 5. 配置宝塔面板反向代理
# 6. 验证所有功能正常
```

---

## 🔧 维护建议

### 定期维护任务

#### 每周维护 (10分钟)
```bash
# 1. 创建稳定版本备份
./version-manager.sh backup patch "每周稳定版本备份"

# 2. 检查系统状态
docker ps | grep stock-tracker
curl -I http://127.0.0.1:3000

# 3. 查看日志是否有异常
docker logs stock-tracker-app --tail 50

# 4. 检查存储空间
df -h
du -sh backups/
```

#### 每月维护 (30分钟)
```bash
# 1. 清理旧备份
./version-manager.sh cleanup 10

# 2. 更新系统依赖
npm audit fix

# 3. 检查Docker镜像
docker images stock-tracker
docker image prune -f

# 4. 备份重要配置到其他位置
cp -r backups/ /backup/external/stock-tracker/
```

#### 每季度维护 (1小时)
```bash
# 1. 重大版本备份
./version-manager.sh backup major "季度稳定版本"

# 2. 系统安全更新
apt update && apt upgrade

# 3. 宝塔面板更新
# 4. SSL证书续期检查
# 5. 性能优化评估
```

### 监控建议

#### 关键指标监控
- **网站可用性**: https://bk.yushuo.click 响应时间
- **容器状态**: Docker容器运行状况
- **磁盘空间**: 备份目录存储使用率
- **内存使用**: 应用内存占用情况
- **API响应**: Tushare数据获取成功率

#### 告警设置
```bash
# 可在宝塔面板设置监控告警：
# - 网站响应时间 > 5秒
# - 磁盘使用率 > 80%
# - 内存使用率 > 90%
# - 容器停止运行
```

---

## 📞 技术支持

### 常用命令速查

```bash
# 版本管理
./version-manager.sh version           # 查看当前版本
./version-manager.sh list             # 查看所有版本
./version-manager.sh backup patch "描述"  # 创建补丁版本
./version-manager.sh restore v1.0.0   # 回滚到指定版本

# 容器管理
docker ps | grep stock-tracker        # 查看容器状态
docker logs stock-tracker-app         # 查看应用日志
docker restart stock-tracker-app      # 重启容器
./deploy.sh                           # 重新部署

# 服务检查
curl http://127.0.0.1:3000           # 本地服务检查
systemctl status nginx               # 反向代理状态
cat VERSION                          # 当前版本号
```

### 紧急联系

- **服务器提供商**: RackNerd
- **域名服务商**: (根据实际情况)
- **宝塔面板**: http://107.173.154.147:8888
- **GitHub仓库**: https://github.com/yushuo1991/911

---

## 📝 更新日志

| 版本 | 日期 | 描述 |
|------|------|------|
| v1.0.0 | 2025-09-23 | 初始稳定版本，完整三重备份系统 |

---

## 📋 附录

### A. 常见问题解答 (FAQ)

#### Q1: 如何查看当前运行的是哪个版本？
```bash
# 方法1：查看VERSION文件
cat VERSION

# 方法2：查看Docker容器标签
docker inspect stock-tracker-app | grep Image

# 方法3：访问网站查看页面版本信息
curl -s http://127.0.0.1:3000 | grep version
```

#### Q2: 备份失败了怎么办？
```bash
# 检查磁盘空间
df -h

# 检查Docker服务状态
systemctl status docker

# 手动备份关键文件
cp -r . ../manual-backup-$(date +%Y%m%d-%H%M%S)
```

#### Q3: 如何快速检查系统健康状态？
```bash
# 使用内置健康检查脚本
./version-manager.sh health

# 手动检查关键组件
echo "=== 系统健康检查 ==="
echo "1. Docker容器状态:"
docker ps | grep stock-tracker
echo "2. 网站响应:"
curl -I http://127.0.0.1:3000
echo "3. 磁盘空间:"
df -h | grep -E "(/$|/www)"
echo "4. 内存使用:"
free -h
```

#### Q4: GitHub推送总是失败怎么办？
```bash
# 检查token权限
git config --global credential.helper store
git config --global user.name "your-username"
git config --global user.email "your-email@example.com"

# 如果是大文件问题，排除Docker镜像
echo "*.tar" >> .gitignore
echo "docker-image.tar" >> .gitignore
git add .gitignore
git commit -m "排除大文件"
```

### B. 故障排除脚本

#### 系统诊断脚本
```bash
#!/bin/bash
# 文件: diagnose.sh
echo "=== 股票追踪系统诊断报告 ==="
echo "生成时间: $(date)"
echo ""

echo "1. 基础信息:"
echo "   当前版本: $(cat VERSION 2>/dev/null || echo '未找到版本文件')"
echo "   系统时间: $(date)"
echo "   服务器IP: $(curl -s ifconfig.me 2>/dev/null || echo '无法获取外网IP')"
echo ""

echo "2. Docker状态:"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""

echo "3. 服务检查:"
echo "   本地服务: $(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000)"
echo "   外网访问: $(curl -s -o /dev/null -w "%{http_code}" https://bk.yushuo.click 2>/dev/null || echo '连接失败')"
echo ""

echo "4. 资源使用:"
echo "   磁盘空间:"
df -h | grep -E "(/$|/www)"
echo "   内存使用:"
free -h
echo ""

echo "5. 备份状态:"
echo "   本地备份: $(ls -la backups/ 2>/dev/null | wc -l) 个"
echo "   Docker镜像: $(docker images stock-tracker --format 'table {{.Tag}}\t{{.Size}}' 2>/dev/null | wc -l) 个"
echo ""

echo "6. 最近日志 (最后10行):"
docker logs stock-tracker-app --tail 10 2>/dev/null || echo "无法获取日志"
```

#### 紧急修复脚本
```bash
#!/bin/bash
# 文件: emergency-fix.sh
echo "=== 紧急修复脚本 ==="

# 1. 停止当前容器
echo "1. 停止当前容器..."
docker stop stock-tracker-app 2>/dev/null

# 2. 回滚到最新稳定版本
echo "2. 回滚到最新稳定版本..."
LATEST_VERSION=$(ls -t backups/ | grep "^v" | head -1 | cut -d'-' -f1)
if [ -n "$LATEST_VERSION" ]; then
    ./version-manager.sh restore "$LATEST_VERSION"
    echo "已回滚到版本: $LATEST_VERSION"
else
    echo "未找到可用的备份版本，尝试重启当前版本..."
    docker start stock-tracker-app
fi

# 3. 验证恢复
echo "3. 验证服务恢复..."
sleep 10
if curl -s http://127.0.0.1:3000 > /dev/null; then
    echo "✅ 服务恢复正常"
else
    echo "❌ 服务仍有问题，需要人工干预"
fi
```

### C. 性能优化建议

#### 定期清理命令
```bash
# 创建清理脚本: cleanup.sh
#!/bin/bash
echo "=== 系统清理开始 ==="

# 清理Docker无用镜像
echo "1. 清理Docker镜像..."
docker image prune -f
docker system prune -f

# 清理旧备份(保留最近5个)
echo "2. 清理旧备份..."
cd backups/
ls -t | grep "^v" | tail -n +6 | xargs -r rm -rf
cd ..

# 清理日志文件
echo "3. 清理日志文件..."
find . -name "*.log" -mtime +7 -delete

echo "=== 清理完成 ==="
df -h
```

#### 监控脚本
```bash
#!/bin/bash
# 文件: monitor.sh - 放入crontab每5分钟运行一次
LOG_FILE="/www/wwwroot/stock-tracker/log/monitor.log"
mkdir -p log

# 检查服务状态
if ! curl -s http://127.0.0.1:3000 > /dev/null; then
    echo "$(date): 服务异常，尝试重启" >> $LOG_FILE
    docker restart stock-tracker-app
    sleep 30
    if curl -s http://127.0.0.1:3000 > /dev/null; then
        echo "$(date): 重启成功" >> $LOG_FILE
    else
        echo "$(date): 重启失败，需要人工干预" >> $LOG_FILE
    fi
else
    echo "$(date): 服务正常" >> $LOG_FILE
fi
```

### D. 快速参考卡片

#### 一键命令速查表

| 操作 | 命令 | 说明 |
|------|------|------|
| **查看版本** | `cat VERSION` | 当前版本号 |
| **快速备份** | `./version-manager.sh backup patch "快速备份"` | 创建补丁备份 |
| **快速回滚** | `./version-manager.sh restore v1.0.0` | 回滚到指定版本 |
| **重启服务** | `docker restart stock-tracker-app` | 重启应用容器 |
| **查看日志** | `docker logs stock-tracker-app --tail 50` | 查看最近50行日志 |
| **健康检查** | `curl -I http://127.0.0.1:3000` | 检查服务状态 |
| **磁盘检查** | `df -h` | 检查磁盘空间 |
| **清理空间** | `docker system prune -f` | 清理Docker空间 |

#### 紧急情况处理流程

```
网站无法访问 → 检查容器状态 → 重启容器 → 仍失败 → 回滚版本 → 联系技术支持
     ↓              ↓              ↓           ↓          ↓
1. curl检查      docker ps     docker restart  最新稳定版本  记录详细错误
2. 浏览器验证    容器是否运行    等待30秒       ./version-manager.sh
3. 不同网络测试  端口是否开放    再次验证       restore v1.0.0
```

---

## 🎓 学习资源

### 相关技术文档链接
- **Docker官方文档**: https://docs.docker.com/
- **Next.js部署指南**: https://nextjs.org/docs/deployment
- **宝塔面板使用教程**: https://www.bt.cn/bbs/forum.php?mod=forumdisplay&fid=39
- **Git版本控制**: https://git-scm.com/docs
- **Linux命令参考**: https://man7.org/linux/man-pages/

### 技术支持联系方式
- **GitHub Issues**: https://github.com/yushuo1991/911/issues
- **宝塔面板**: http://107.173.154.147:8888
- **服务器SSH**: root@107.173.154.147

---

*最后更新时间: 2025年9月23日*
*文档版本: v2.0*
*系统状态: ✅ 运行正常*
*备份状态: ✅ 三重备份就绪*