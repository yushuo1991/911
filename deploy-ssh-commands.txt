# SSH部署命令清单
# 使用SSH客户端（PuTTY、MobaXterm或Windows Terminal）连接后执行以下命令

# ===== 服务器连接信息 =====
主机: yushuo.click
端口: 22
用户: root
密码: gJ75hNHdy90TA4qGo9

# ===== 执行命令序列 =====

# 1. 检查当前目录和Docker环境
cd /www/wwwroot/stock-tracker
pwd
docker --version
docker-compose --version

# 2. 查看当前Git状态
git status
git log -1

# 3. 停止现有容器
docker-compose down

# 4. 拉取最新代码
git fetch --all
git reset --hard origin/main
git pull origin main

# 5. 验证最新提交
git log -1
git show --stat

# 6. 检查关键文件
ls -lh Dockerfile docker-compose.yml init.sql deploy.sh

# 7. 设置执行权限
chmod +x deploy.sh

# 8. 执行部署
./deploy.sh

# 9. 等待30秒后检查容器状态
sleep 30
docker-compose ps

# 10. 查看应用日志
docker-compose logs --tail=50 stock-tracker

# 11. 查看MySQL日志
docker-compose logs --tail=30 mysql

# 12. 测试本地访问
curl -I http://localhost:3002

# 13. 检查容器健康状态
docker ps --filter "name=stock-tracker"

# 14. 如果有问题，查看完整日志
docker-compose logs -f stock-tracker

# ===== 一键部署命令（复制粘贴执行） =====
cd /www/wwwroot/stock-tracker && \
docker-compose down && \
git fetch --all && \
git reset --hard origin/main && \
git pull origin main && \
git log -1 && \
chmod +x deploy.sh && \
./deploy.sh && \
sleep 30 && \
docker-compose ps && \
docker-compose logs --tail=50 stock-tracker && \
curl -I http://localhost:3002