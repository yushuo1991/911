name: Data Preload Cron

# æ¯ä¸ªå·¥ä½œæ—¥åŒ—äº¬æ—¶é—´16:10æ‰§è¡Œï¼ˆUTC 08:10ï¼‰
on:
  schedule:
    - cron: '10 8 * * 1-5'  # å‘¨ä¸€åˆ°å‘¨äº” UTC 08:10 = åŒ—äº¬æ—¶é—´ 16:10
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  preload-data:
    runs-on: ubuntu-latest

    steps:
      - name: Preload Recent 6 Days Data
        run: |
          echo "â° è§¦å‘æ•°æ®é¢„åŠ è½½ä»»åŠ¡..."
          echo "ğŸ“… åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

          # è°ƒç”¨é¢„åŠ è½½API
          response=$(curl -s -w "\n%{http_code}" \
            -X POST "https://bk.yushuo.click/api/cron?action=preload_recent" \
            -H "Authorization: Bearer cron-token-2025" \
            --max-time 300)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTPçŠ¶æ€ç : $http_code"
          echo "å“åº”å†…å®¹: $body"

          if [ "$http_code" = "200" ]; then
            echo "âœ… æ•°æ®é¢„åŠ è½½æˆåŠŸ"
          else
            echo "âŒ æ•°æ®é¢„åŠ è½½å¤±è´¥"
            exit 1
          fi

      - name: Preload Current Day Full Data
        run: |
          echo "ğŸ“Š é¢„åŠ è½½å½“å¤©å®Œæ•´7å¤©æ•°æ®..."

          today=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')

          response=$(curl -s -w "\n%{http_code}" \
            -X GET "https://bk.yushuo.click/api/stocks?date=${today}&mode=7days" \
            --max-time 120)

          http_code=$(echo "$response" | tail -n1)

          echo "HTTPçŠ¶æ€ç : $http_code"

          if [ "$http_code" = "200" ]; then
            echo "âœ… 7å¤©æ•°æ®ç¼“å­˜é¢„çƒ­æˆåŠŸ"
          else
            echo "âš ï¸  7å¤©æ•°æ®ç¼“å­˜é¢„çƒ­å¤±è´¥ï¼ˆå¯èƒ½æ˜¯æ•°æ®åº“é—®é¢˜ï¼‰"
          fi
