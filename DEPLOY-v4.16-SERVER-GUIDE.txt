╔══════════════════════════════════════════════════════════════╗
║         🚀 v4.16 服务器部署快速指南                          ║
╚══════════════════════════════════════════════════════════════╝

部署时间: 2025-10-03
部署版本: v4.14 + v4.15 + v4.16
当前服务器版本: v4.13 (d2908bd) ❌
目标版本: v4.16 (5ddaf4b) ✅

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎯 为什么需要部署？

服务器代码仍停留在v4.13（9月30日），缺失3个重要版本:
  ❌ v4.14 - Tushare交易日历（修复10月1日显示）
  ❌ v4.15 - 涨停数弹窗初步优化
  ❌ v4.16 - 涨停数弹窗全面优化

结果：用户看到的仍是v4.13旧版本界面

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 方法一：自动脚本部署（推荐）

1. 上传部署脚本到服务器
   - 文件: deploy-v4.16-to-server.sh
   - 位置: /www/wwwroot/stock-tracker/

2. 通过宝塔面板或SSH执行:

   cd /www/wwwroot/stock-tracker
   chmod +x deploy-v4.16-to-server.sh
   ./deploy-v4.16-to-server.sh

3. 脚本会自动完成:
   ✅ 拉取最新代码（v4.14, v4.15, v4.16）
   ✅ 停止旧容器
   ✅ 清理旧镜像
   ✅ 重新构建镜像（无缓存）
   ✅ 启动新容器
   ✅ 验证部署结果

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 方法二：手动命令部署

如果脚本上传不便，直接在宝塔终端执行以下命令（一次全部复制）:

cd /www/wwwroot/stock-tracker && \
echo "🔄 拉取最新代码..." && \
git pull origin main && \
echo "✅ 代码已更新到:" && \
git log --oneline -1 && \
echo "" && \
echo "🛑 停止旧容器..." && \
docker compose down && \
echo "" && \
echo "🔨 重新构建镜像（无缓存）..." && \
docker compose build --no-cache && \
echo "" && \
echo "🚀 启动新容器..." && \
docker compose up -d && \
echo "" && \
echo "⏳ 等待15秒让应用启动..." && \
sleep 15 && \
echo "" && \
echo "🔍 检查容器状态:" && \
docker ps | grep stock-tracker && \
echo "" && \
echo "🏥 检查应用健康:" && \
curl -I http://localhost:3002 && \
echo "" && \
echo "✅ 部署完成！请访问 http://bk.yushuo.click 验证"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔍 验证部署成功

1. 浏览器验证（重要！）
   - 访问: http://bk.yushuo.click
   - 按 Ctrl+Shift+R 强制刷新（清除缓存）
   - 检查首页顶部是否显示最近7天（不应包含10月1日）✅
   - 点击任意日期的"涨停家数"（如"8只涨停"）
   - 观察弹窗布局变化

2. v4.16弹窗优化验证清单:
   ✅ 弹窗容器宽度约70%（之前60%）
   ✅ 板块卡片3列显示（之前4列）
   ✅ 表格名称列90px宽（之前70px）
   ✅ 表格状态列60px宽（之前45px）
   ✅ 表格日期列70px宽（之前55px）
   ✅ 字体大小12px（之前10-11px）
   ✅ 表头蓝色渐变（之前灰色）
   ✅ 状态徽章颜色增强

3. 服务器验证（可选）:
   # 检查Git版本
   git log --oneline -3
   # 应显示:
   # 5ddaf4b feat: v4.16 全面优化涨停数弹窗布局和视觉效果
   # 2f93a36 feat: v4.15 优化涨停数弹窗列宽和单元格间距
   # cffc6e8 fix: v4.14 使用Tushare交易日历过滤节假日

   # 检查容器内代码（可选）
   docker exec stock-tracker-app grep "min-w-\[70vw\]" src/app/page.tsx
   # 应返回: <div className="bg-white rounded-xl p-4 w-auto min-w-[70vw] max-w-[95vw]...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🆘 如果部署后仍无变化

1. 确认浏览器缓存已清除
   - 尝试无痕模式访问
   - 或使用手机访问验证

2. 检查容器内代码版本
   docker exec stock-tracker-app cat src/app/page.tsx | grep "min-w-\[70vw\]"
   # 如果无输出，说明容器内代码仍是旧版

3. 检查Docker构建日志
   docker compose logs --tail=50 app

4. 手动验证容器挂载
   docker inspect stock-tracker-app | grep -A 10 "Mounts"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 版本对比表

功能                  v4.13 (服务器)  v4.16 (目标)
─────────────────────────────────────────────────
交易日历              手动过滤周末     Tushare API ✅
10月1日显示           错误显示 ❌      不显示 ✅
排序按钮位置          板块弹窗内       首页全局 ✅
涨停数弹窗容器宽度    60vw            70vw ✅
涨停数弹窗列数        4列             3列 ✅
表格名称列宽          70px            90px ✅
表格状态列宽          45px            60px ✅
表格日期列宽          55px            70px ✅
表格字体大小          10-11px         12px ✅
表头样式              灰色            蓝色渐变 ✅

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 部署完成后

1. 在CLAUDE.md中更新部署记录
2. 将部署时间和结果记录到日志
3. 如果成功，考虑备份v4.16为新的稳定版本

预计部署时间: 5-10分钟（取决于网络和构建速度）

Created by: Claude Code
Date: 2025-10-03
